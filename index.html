<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Spatial and Spatiotemporal SPDE-Based GLMMs with TMB â€¢ sdmTMB</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png">
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Spatial and Spatiotemporal SPDE-Based GLMMs with TMB">
<meta name="description" content="Implements spatial and spatiotemporal GLMMs (Generalized Linear Mixed Effect Models) using TMB, fmesher, and the SPDE (Stochastic Partial Differential Equation) Gaussian Markov random field approximation to Gaussian random fields. One common application is for spatially explicit species distribution models (SDMs). See Anderson et al. (2024) &lt;doi:10.1101/2022.03.24.485545&gt;.">
<meta property="og:description" content="Implements spatial and spatiotemporal GLMMs (Generalized Linear Mixed Effect Models) using TMB, fmesher, and the SPDE (Stochastic Partial Differential Equation) Gaussian Markov random field approximation to Gaussian random fields. One common application is for spatially explicit species distribution models (SDMs). See Anderson et al. (2024) &lt;doi:10.1101/2022.03.24.485545&gt;.">
<meta property="og:image" content="https://pbs-assess.github.io/sdmTMB/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">sdmTMB</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.0.9014</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="articles/basic-intro.html">Introduction to modelling with sdmTMB</a></li>
    <li><a class="dropdown-item" href="articles/bayesian.html">Bayesian estimation with sdmTMB</a></li>
    <li><a class="dropdown-item" href="articles/cross-validation.html">Cross-validation for model evaluation and comparison</a></li>
    <li><a class="dropdown-item" href="articles/delta-models.html">Fitting delta (hurdle) models with sdmTMB</a></li>
    <li><a class="dropdown-item" href="articles/ggeffects.html">Visualizing marginal effects in sdmTMB models with ggeffects</a></li>
    <li><a class="dropdown-item" href="articles/index-standardization.html">Index standardization with sdmTMB</a></li>
    <li><a class="dropdown-item" href="articles/model-description.html">sdmTMB model description</a></li>
    <li><a class="dropdown-item" href="articles/poisson-link.html">Poisson-link delta models</a></li>
    <li><a class="dropdown-item" href="articles/pretty-plots.html">Making pretty maps with sdmTMB output</a></li>
    <li><a class="dropdown-item" href="articles/residual-checking.html">Residual checking with sdmTMB</a></li>
    <li><a class="dropdown-item" href="articles/spatial-trend-models.html">Fitting spatial trend models with sdmTMB</a></li>
    <li><a class="dropdown-item" href="articles/threshold-models.html">Threshold modeling with sdmTMB</a></li>
    <li><a class="dropdown-item" href="articles/visreg.html">Visualizing sdmTMB conditional effects using visreg</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pbs-assess/sdmTMB/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header">
<img src="logo.png" class="logo" alt=""><h1 id="sdmtmb-">sdmTMB 
<a class="anchor" aria-label="anchor" href="#sdmtmb-"></a>
</h1>
</div>
<blockquote>
<p>Spatial and spatiotemporal GLMMs with TMB</p>
</blockquote>
<!-- badges: start -->

<p>sdmTMB is an R package that fits spatial and spatiotemporal GLMMs (Generalized Linear Mixed Effects Models) using Template Model Builder (<a href="https://github.com/kaskr/adcomp" class="external-link">TMB</a>), <a href="https://www.r-inla.org/" class="external-link">R-INLA</a>, and Gaussian Markov random fields. One common application is for species distribution models (SDMs). See the <a href="https://pbs-assess.github.io/sdmTMB/">documentation site</a> and a preprint:</p>
<p>Anderson, S.C., E.J. Ward, P.A. English, L.A.K. Barnett, J.T. Thorson. 2024. sdmTMB: an R package for fast, flexible, and user-friendly generalized linear mixed effects models with spatial and spatiotemporal random fields. bioRxiv 2022.03.24.485545; doi: <a href="https://doi.org/10.1101/2022.03.24.485545" class="external-link uri">https://doi.org/10.1101/2022.03.24.485545</a></p>
<div class="section level2">
<h2 id="table-of-contents">Table of contents<a class="anchor" aria-label="anchor" href="#table-of-contents"></a>
</h2>
<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#overview">Overview</a></li>
<li><a href="#getting-help">Getting help</a></li>
<li><a href="#citation">Citation</a></li>
<li><a href="#related-software">Related software</a></li>
<li><a href="#basic-use">Basic use</a></li>
<li>
<a href="#advanced-functionality">Advanced functionality</a>
<ul>
<li><a href="#time-varying-coefficients">Time-varying coefficients</a></li>
<li><a href="#spatially-varying-coefficients-svc">Spatially varying coefficients (SVC)</a></li>
<li><a href="#random-intercepts">Random intercepts</a></li>
<li><a href="#breakpoint-and-threshold-effects">Breakpoint and threshold effects</a></li>
<li><a href="#simulating-data">Simulating data</a></li>
<li><a href="#sampling-from-the-joint-precision-matrix">Sampling from the joint precision matrix</a></li>
<li><a href="#calculating-uncertainty-on-spatial-predictions">Calculating uncertainty on spatial predictions</a></li>
<li><a href="#cross-validation">Cross validation</a></li>
<li><a href="#priors">Priors</a></li>
<li><a href="#bayesian-mcmc-sampling-with-stan">Bayesian MCMC sampling with Stan</a></li>
<li><a href="#turning-off-random-fields">Turning off random fields</a></li>
<li><a href="#using-a-custom-fmesher-mesh">Using a custom fmesher mesh</a></li>
<li><a href="#barrier-meshes">Barrier meshes</a></li>
</ul>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>sdmTMB can be installed from CRAN:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"sdmTMB"</span>, dependencies <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Assuming you have a <a href="https://support.posit.co/hc/en-us/articles/200486498-Package-Development-Prerequisites" class="external-link">C++ compiler</a> installed, the development version is recommended and can be installed:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("pak")</span></span>
<span><span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pkg_install.html" class="external-link">pkg_install</a></span><span class="op">(</span><span class="st">"pbs-assess/sdmTMB"</span>, dependencies <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>There are some extra utilities in the <a href="https://github.com/pbs-assess/sdmTMBextra" class="external-link">sdmTMBextra</a> package.</p>
<p><strong>Importantly</strong>, it is recommended to use an optimized BLAS library, which will result in major speed improvements for TMB (and other) models in R (e.g., often 8-fold speed increases for sdmTMB models). Suggested installation instructions for <a href="https://www.mail-archive.com/r-sig-mac@r-project.org/msg06199.html" class="external-link">Mac users</a>, <a href="https://prdm0.github.io/ropenblas/" class="external-link">Linux users</a>, <a href="https://github.com/david-cortes/R-openblas-in-windows" class="external-link">Windows users</a>, and <a href="https://gist.github.com/seananderson/08a51e296a854f227a908ddd365fb9c1" class="external-link">Windows users without admin privileges</a>. To check that youâ€™ve successfully linked the optimized BLAS, start a new session and run:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">1e4</span>; <span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1e3</span>; <span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">3e2</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">m</span><span class="op">*</span><span class="va">k</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">m</span><span class="op">)</span>; <span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="va">k</span><span class="op">)</span>, ncol<span class="op">=</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">)</span></span></code></pre></div>
<p>The result (â€˜elapsedâ€™) should take a fraction of a second (e.g., 0.03 s), not multiple seconds.</p>
</div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>Analyzing geostatistical data (coordinate-referenced observations from some underlying spatial process) is becoming increasingly common in ecology. sdmTMB implements geostatistical spatial and spatiotemporal GLMMs using TMB for model fitting and R-INLA to set up SPDE (stochastic partial differential equation) matrices. One common application is for species distribution models (SDMs), hence the package name. The goal of sdmTMB is to provide a fast, flexible, and user-friendly interfaceâ€”similar to the popular R package glmmTMBâ€”but with a focus on spatial and spatiotemporal models with an SPDE approach. We extend the generalized linear mixed models (GLMMs) familiar to ecologists to include the following optional features:</p>
<ul>
<li>spatial random fields</li>
<li>spatiotemporal random fields that may be independent by year or modelled with random walks or autoregressive processes</li>
<li>smooth terms for covariates, using the familiar <code>s()</code> notation from mgcv</li>
<li>breakpoint (hockey-stick) or logistic covariates</li>
<li>time-varying covariates (coefficients modelled as random walks)</li>
<li>spatially varying coefficient models (SVCs)</li>
<li>interpolation or forecasting over missing or future time slices</li>
<li>a wide range of families: all standard R families plus <code><a href="reference/families.html">tweedie()</a></code>, <code><a href="reference/families.html">nbinom1()</a></code>, <code><a href="reference/families.html">nbinom2()</a></code>, <code><a href="reference/families.html">lognormal()</a></code>, and <code><a href="reference/families.html">student()</a></code>, plus some truncated and censored families</li>
<li>delta/hurdle models including <code><a href="reference/families.html">delta_gamma()</a></code>, <code><a href="reference/families.html">delta_lognormal()</a></code>, and <code><a href="reference/families.html">delta_truncated_nbinom2()</a></code>
</li>
</ul>
<p>Estimation is performed in sdmTMB via maximum marginal likelihood with the objective function calculated in TMB and minimized in R via <code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">stats::nlminb()</a></code> with the random effects integrated over via the Laplace approximation. The sdmTMB package also allows for models to be passed to Stan via tmbstan, allowing for Bayesian model estimation.</p>
<p>See <a href="https://pbs-assess.github.io/sdmTMB/reference/sdmTMB.html"><code>?sdmTMB</code></a> and <a href="https://pbs-assess.github.io/sdmTMB/reference/predict.sdmTMB.html"><code>?predict.sdmTMB</code></a> for the most complete examples. Also see the vignettes (â€˜Articlesâ€™) on the <a href="https://pbs-assess.github.io/sdmTMB/index.html">documentation site</a> and the preprint and appendices linked to below.</p>
</div>
<div class="section level2">
<h2 id="getting-help">Getting help<a class="anchor" aria-label="anchor" href="#getting-help"></a>
</h2>
<p>For questions about how to use sdmTMB or interpret the models, please post on the <a href="https://github.com/pbs-assess/sdmTMB/discussions" class="external-link">discussion board</a>. If you <a href="https://github.com/pbs-assess/sdmTMB/blob/main/DESCRIPTION" class="external-link">email</a> a question, we are likely to respond on the <a href="https://github.com/pbs-assess/sdmTMB/discussions" class="external-link">discussion board</a> with an anonymized version of your question (and without data) if we think it could be helpful to others. Please let us know if you donâ€™t want us to do that.</p>
<p>For bugs or feature requests, please post in the <a href="https://github.com/pbs-assess/sdmTMB/issues" class="external-link">issue tracker</a>.</p>
<p><a href="https://pbs-assess.github.io/sdmTMB-teaching/noaa-psaw-2022/">Slides</a> and <a href="https://www.youtube.com/channel/UCYoFG51RjJVx7m9mZGaj-Ng/videos" class="external-link">recordings</a> from a workshop on sdmTMB.</p>
</div>
<div class="section level2">
<h2 id="citation">Citation<a class="anchor" aria-label="anchor" href="#citation"></a>
</h2>
<p>To cite sdmTMB in publications use:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/citation.html" class="external-link">citation</a></span><span class="op">(</span><span class="st">"sdmTMB"</span><span class="op">)</span></span></code></pre></div>
<p>Anderson, S.C., E.J. Ward, P.A. English, L.A.K. Barnett., J.T. Thorson. 2024. sdmTMB: an R package for fast, flexible, and user-friendly generalized linear mixed effects models with spatial and spatiotemporal random fields. bioRxiv 2022.03.24.485545; doi: <a href="https://doi.org/10.1101/2022.03.24.485545" class="external-link uri">https://doi.org/10.1101/2022.03.24.485545</a></p>
<p>A list of (known) publications that use sdmTMB can be found <a href="https://github.com/pbs-assess/sdmTMB/wiki/Publications-using-sdmTMB" class="external-link">here</a>. Please use the above citation so we can track publications.</p>
</div>
<div class="section level2">
<h2 id="related-software">Related software<a class="anchor" aria-label="anchor" href="#related-software"></a>
</h2>
<p>sdmTMB is heavily inspired by the <a href="https://github.com/James-Thorson-NOAA/VAST" class="external-link">VAST</a> R package:</p>
<p>Thorson, J.T. 2019. Guidance for decisions using the Vector Autoregressive Spatio-Temporal (VAST) package in stock, ecosystem, habitat and climate assessments. Fisheries Research 210: 143â€“161. <a href="https://doi.org/10.1016/j.fishres.2018.10.013" class="external-link uri">https://doi.org/10.1016/j.fishres.2018.10.013</a>.</p>
<p>and the <a href="https://github.com/glmmTMB/glmmTMB" class="external-link">glmmTMB</a> R package:</p>
<p>Brooks, M.E., Kristensen, K., van Benthem, K.J., Magnusson, A., Berg, C.W., Nielsen, A., Skaug, H.J., Maechler, M., and Bolker, B.M. 2017. glmmTMB balances speed and flexibility among packages for zero-inflated generalized linear mixed modeling. The R Journal 9(2): 378â€“400. <a href="https://doi.org/10.32614/rj-2017-066" class="external-link uri">https://doi.org/10.32614/rj-2017-066</a>.</p>
<p><a href="https://www.r-inla.org/" class="external-link">INLA</a> and <a href="https://sites.google.com/inlabru.org/inlabru" class="external-link">inlabru</a> can fit many of the same models as sdmTMB (and many more) in an approximate Bayesian inference framework.</p>
<p><a href="https://cran.r-project.org/package=mgcv" class="external-link">mgcv</a> can fit similar SPDE-based Gaussian random field models with code included in <a href="https://doi.org/10.1007/s13253-019-00377-z" class="external-link">Miller et al.Â (2019)</a>.</p>
<p>A table in the <a href="https://doi.org/10.1101/2022.03.24.485545" class="external-link">sdmTMB preprint</a> describes functionality and timing comparisons between sdmTMB, VAST, INLA/inlabru, and mgcv and the discussion makes suggestions about when you might choose one package over another.</p>
</div>
<div class="section level2">
<h2 id="basic-use">Basic use<a class="anchor" aria-label="anchor" href="#basic-use"></a>
</h2>
<p>An sdmTMB model requires a data frame that contains a response column, columns for any predictors, and columns for spatial coordinates. It usually makes sense to convert the spatial coordinates to an equidistant projection such as UTMs such that distance remains constant throughout the study region [e.g., using <code><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">sf::st_transform()</a></code>]. Here, we illustrate a spatial model fit to Pacific cod (<em>Gadus macrocephalus</em>) trawl survey data from Queen Charlotte Sound, BC, Canada. Our model contains a main effect of depth as a penalized smoother, a spatial random field, and Tweedie observation error. Our data frame <code>pcod</code> (built into the package) has a column <code>year</code> for the year of the survey, <code>density</code> for density of Pacific cod in a given survey tow, <code>present</code> for whether <code>density &gt; 0</code>, <code>depth</code> for depth in meters of that tow, and spatial coordinates <code>X</code> and <code>Y</code>, which are UTM coordinates in kilometres.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pbs-assess.github.io/sdmTMB/">sdmTMB</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 Ã— 6</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="co">#&gt;    year density present depth     X     Y</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co">#&gt;   &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co">#&gt; 1  2003   113.        1   201  446. 5793.</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co">#&gt; 2  2003    41.7       1   212  446. 5800.</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co">#&gt; 3  2003     0         0   220  449. 5802.</span></span></code></pre></div>
<p>We start by creating a mesh object that contains matrices to apply the SPDE approach.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">pcod</span>, xy_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>Here, <code>cutoff</code> defines the minimum allowed distance between points in the units of <code>X</code> and <code>Y</code> (km). Alternatively, we could have created any mesh via the fmesher or INLA packages and supplied it to <code><a href="reference/make_mesh.html">make_mesh()</a></code>. We can inspect our mesh object with the associated plotting method <code>plot(mesh)</code>.</p>
<p>Fit a spatial model with a smoother for depth:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">depth</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"on"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Print the model fit:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span></span>
<span><span class="co">#&gt; Spatial model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: density ~ s(depth)</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Data: pcod</span></span>
<span><span class="co">#&gt; Family: tweedie(link = 'log')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;             coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)     2.37    0.21</span></span>
<span><span class="co">#&gt; sdepth          0.62    2.53</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Smooth terms:</span></span>
<span><span class="co">#&gt;            Std. Dev.</span></span>
<span><span class="co">#&gt; sds(depth)     13.93</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 12.69</span></span>
<span><span class="co">#&gt; Tweedie p: 1.58</span></span>
<span><span class="co">#&gt; MatÃ©rn range: 16.39</span></span>
<span><span class="co">#&gt; Spatial SD: 1.86</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 6402.136</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
<p>The output indicates our model was fit by maximum (marginal) likelihood (<code>ML</code>). We also see the formula, mesh, fitted data, and family. Next we see any estimated main effects including the linear component of the smoother (<code>sdepth</code>), the standard deviation on the smoother weights (<code>sds(depth)</code>), the Tweedie dispersion and power parameters, the MatÃ©rn range distance (distance at which points are effectively independent), the marginal spatial field standard deviation, and the negative log likelihood at convergence.</p>
<p>We can extract parameters as a data frame:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fit</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 Ã— 5</span></span>
<span><span class="co">#&gt;   term        estimate std.error conf.low conf.high</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 (Intercept)     2.37     0.215     1.95      2.79</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fit</span>, effects <span class="op">=</span> <span class="st">"ran_pars"</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 4 Ã— 5</span></span>
<span><span class="co">#&gt;   term      estimate std.error conf.low conf.high</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 range        16.4    4.47        9.60     28.0 </span></span>
<span><span class="co">#&gt; 2 phi          12.7    0.406      11.9      13.5 </span></span>
<span><span class="co">#&gt; 3 sigma_O       1.86   0.218       1.48      2.34</span></span>
<span><span class="co">#&gt; 4 tweedie_p     1.58   0.00998     1.56      1.60</span></span></code></pre></div>
<p>Run some basic sanity checks on our model:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/sanity.html">sanity</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; âœ” Non-linear minimizer suggests successful convergence</span></span>
<span><span class="co">#&gt; âœ” Hessian matrix is positive definite</span></span>
<span><span class="co">#&gt; âœ” No extreme or very small eigenvalues detected</span></span>
<span><span class="co">#&gt; âœ” No gradients with respect to fixed effects are &gt;= 0.001</span></span>
<span><span class="co">#&gt; âœ” No fixed-effect standard errors are NA</span></span>
<span><span class="co">#&gt; âœ” No standard errors look unreasonably large</span></span>
<span><span class="co">#&gt; âœ” No sigma parameters are &lt; 0.01</span></span>
<span><span class="co">#&gt; âœ” No sigma parameters are &gt; 100</span></span>
<span><span class="co">#&gt; âœ” Range parameter doesn't look unreasonably large</span></span></code></pre></div>
<p>Use the <a href="https://github.com/strengejacke/ggeffects" class="external-link">ggeffects</a> package to plot the smoother effect:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggeffects</span><span class="fu">::</span><span class="fu"><a href="https://strengejacke.github.io/ggeffects/reference/ggpredict.html" class="external-link">ggpredict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="st">"depth [50:400, by=2]"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-plot-ggpredict-link-1.png" width="50%"></p>
<p>If the depth effect was parametric and not a penalized smoother, we could have alternatively used <code><a href="https://strengejacke.github.io/ggeffects/reference/ggpredict.html" class="external-link">ggeffects::ggeffect()</a></code> for a fast marginal effect plot.</p>
<p>Next, we can predict on new data. We will use a data frame <code>qcs_grid</code> from the package, which contains all the locations (and covariates) at which we wish to predict. Here, these <code>newdata</code> are a grid, or raster, covering our survey.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">qcs_grid</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 Ã— 7</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="co">#&gt;       X     Y depth   est est_non_rf est_rf omega_s</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="co">#&gt; 1   456  5636  347. -3.06      -3.08 0.0172  0.0172</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="co">#&gt; 2   458  5636  223.  2.03       1.99 0.0460  0.0460</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="co">#&gt; 3   460  5636  204.  2.89       2.82 0.0747  0.0747</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">p</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"sqrt"</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-plot-predictions-1.png" width="50%"></p>
<p>We could switch to a presence-absence model by changing the response column and family:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">present</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">depth</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>, </span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Or a hurdle/delta model by changing the family:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">depth</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="reference/families.html">delta_gamma</a></span><span class="op">(</span>link1 <span class="op">=</span> <span class="st">"logit"</span>, link2 <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span><span class="op">)</span></span></code></pre></div>
<p>We could instead fit a spatiotemporal model by specifying the <code>time</code> column and a spatiotemporal structure:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_spatiotemporal</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">depth</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>, </span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>, </span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>, </span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>, </span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"ar1"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If we wanted to create an area-weighted standardized population index, we could predict on a grid covering the entire survey (<code>qcs_grid</code>) with grid cell area 4 (2 x 2 km) and pass the predictions to <code><a href="reference/get_index.html">get_index()</a></code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid_yrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/replicate_df.html">replicate_df</a></span><span class="op">(</span><span class="va">qcs_grid</span>, <span class="st">"year"</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p_st</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_spatiotemporal</span>, newdata <span class="op">=</span> <span class="va">grid_yrs</span>, </span>
<span>  return_tmb_object <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_index.html">get_index</a></span><span class="op">(</span><span class="va">p_st</span>, area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">grid_yrs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">index</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">est</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lwr</span>, ymax <span class="op">=</span> <span class="va">upr</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"grey90"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">1</span>, colour <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Year"</span>, y <span class="op">=</span> <span class="st">"Biomass (kg)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-plot-index-1.png" width="50%"></p>
<p>Or the center of gravity:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cog</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_index.html">get_cog</a></span><span class="op">(</span><span class="va">p_st</span>, format <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">cog</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">est_x</span>, <span class="va">est_y</span>, colour <span class="op">=</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_pointrange</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">lwr_x</span>, xmax <span class="op">=</span> <span class="va">upr_x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_pointrange</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lwr_y</span>, ymax <span class="op">=</span> <span class="va">upr_y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_colour_viridis_c</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-plot-cog-1.png" width="50%"></p>
<p>For more on these basic features, see the vignettes <a href="https://pbs-assess.github.io/sdmTMB/articles/basic-intro.html">Intro to modelling with sdmTMB</a> and <a href="https://pbs-assess.github.io/sdmTMB/articles/index-standardization.html">Index standardization with sdmTMB</a>.</p>
</div>
<div class="section level2">
<h2 id="advanced-functionality">Advanced functionality<a class="anchor" aria-label="anchor" href="#advanced-functionality"></a>
</h2>
<div class="section level3">
<h3 id="time-varying-coefficients">Time-varying coefficients<a class="anchor" aria-label="anchor" href="#time-varying-coefficients"></a>
</h3>
<p>Time-varying intercept:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">depth</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>, </span>
<span>  time_varying <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>, </span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>, mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,  </span>
<span>  family <span class="op">=</span> <span class="fu"><a href="reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>  silent <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># see progress</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Time-varying (random walk) effect of depth:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="fl">1</span>, </span>
<span>  time_varying <span class="op">=</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">depth_scaled</span> <span class="op">+</span> <span class="va">depth_scaled2</span>,</span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>, mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>,</span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"ar1"</span>,</span>
<span>  silent <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>See the vignette <a href="https://pbs-assess.github.io/sdmTMB/articles/basic-intro.html">Intro to modelling with sdmTMB</a> for more details.</p>
</div>
<div class="section level3">
<h3 id="spatially-varying-coefficients-svc">Spatially varying coefficients (SVC)<a class="anchor" aria-label="anchor" href="#spatially-varying-coefficients-svc"></a>
</h3>
<p>Spatially varying effect of time:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pcod</span><span class="op">$</span><span class="va">year_scaled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">depth</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span> <span class="va">year_scaled</span>,</span>
<span>  spatial_varying <span class="op">=</span> <span class="op">~</span> <span class="va">year_scaled</span>, </span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>, mesh <span class="op">=</span> <span class="va">mesh</span>, </span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"off"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>See <code>zeta_s</code> in the output, which represents the coefficient varying in space. Youâ€™ll want to ensure you set up your model such that it ballpark has a mean of 0 (e.g., by including it in <code>formula</code> too).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid_yrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/replicate_df.html">replicate_df</a></span><span class="op">(</span><span class="va">qcs_grid</span>, <span class="st">"year"</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">grid_yrs</span><span class="op">$</span><span class="va">year_scaled</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">grid_yrs</span><span class="op">$</span><span class="va">year</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">grid_yrs</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2011</span><span class="op">)</span> <span class="co"># any year</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">p</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, fill <span class="op">=</span> <span class="va">zeta_s_year_scaled</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient2</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-plot-zeta-1.png" width="50%"></p>
<p>See the vignette on <a href="https://pbs-assess.github.io/sdmTMB/articles/spatial-trend-models.html">Fitting spatial trend models with sdmTMB</a> for more details.</p>
</div>
<div class="section level3">
<h3 id="random-intercepts">Random intercepts<a class="anchor" aria-label="anchor" href="#random-intercepts"></a>
</h3>
<p>We can use the same syntax (<code>1 | group</code>) as lme4 or glmmTMB to fit random intercepts:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pcod</span><span class="op">$</span><span class="va">year_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">depth</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">year_factor</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>, mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="breakpoint-and-threshold-effects">Breakpoint and threshold effects<a class="anchor" aria-label="anchor" href="#breakpoint-and-threshold-effects"></a>
</h3>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">present</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu">breakpt</span><span class="op">(</span><span class="va">depth_scaled</span><span class="op">)</span>, </span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>, mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">present</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu">logistic</span><span class="op">(</span><span class="va">depth_scaled</span><span class="op">)</span>, </span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>, mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>See the vignette on <a href="https://pbs-assess.github.io/sdmTMB/articles/threshold-models.html">Threshold modeling with sdmTMB</a> for more details.</p>
</div>
<div class="section level3">
<h3 id="simulating-data">Simulating data<a class="anchor" aria-label="anchor" href="#simulating-data"></a>
</h3>
<div class="section level4">
<h4 id="simulating-data-from-scratch">Simulating data from scratch<a class="anchor" aria-label="anchor" href="#simulating-data-from-scratch"></a>
</h4>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictor_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>, Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">predictor_dat</span>, xy_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">sim_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdmTMB_simulate.html">sdmTMB_simulate</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">predictor_dat</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>  range <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  sigma_O <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  B <span class="op">=</span> <span class="fl">1</span> <span class="co"># B0 = intercept</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sim_dat</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 6 Ã— 7</span></span>
<span><span class="co">#&gt;        X     Y omega_s    mu   eta observed `(Intercept)`</span></span>
<span><span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 0          0  -0.154  2.33 0.846        1             1</span></span>
<span><span class="co">#&gt; 2 0.0101     0  -0.197  2.23 0.803        0             1</span></span>
<span><span class="co">#&gt; 3 0.0202     0  -0.240  2.14 0.760        2             1</span></span>
<span><span class="co">#&gt; 4 0.0303     0  -0.282  2.05 0.718        2             1</span></span>
<span><span class="co">#&gt; 5 0.0404     0  -0.325  1.96 0.675        3             1</span></span>
<span><span class="co">#&gt; 6 0.0505     0  -0.367  1.88 0.633        2             1</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># sample 200 points for fitting:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">sim_dat_obs</span> <span class="op">&lt;-</span> <span class="va">sim_dat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">sim_dat</span><span class="op">)</span><span class="op">)</span>, <span class="fl">200</span><span class="op">)</span>, <span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sim_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">eta</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># mean without observation error</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">observed</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">sim_dat_obs</span>, pch <span class="op">=</span> <span class="fl">21</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_size.html" class="external-link">scale_size_area</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-plot-sim-dat-1.png" width="50%"></p>
<p>Fit to the simulated data:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">sim_dat_obs</span>, xy_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">observed</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">sim_dat_obs</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>See <a href="https://pbs-assess.github.io/sdmTMB/reference/sdmTMB_simulate.html"><code>?sdmTMB_simulate</code></a> for more details.</p>
</div>
<div class="section level4">
<h4 id="simulating-from-an-existing-fit">Simulating from an existing fit<a class="anchor" aria-label="anchor" href="#simulating-from-an-existing-fit"></a>
</h4>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit</span>, nsim <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 969 500</span></span>
<span><span class="va">s</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span>
<span><span class="co">#&gt;      [,1]     [,2]     [,3]     [,4]</span></span>
<span><span class="co">#&gt; [1,]    0 59.40310 83.20888  0.00000</span></span>
<span><span class="co">#&gt; [2,]    0 34.56408  0.00000 19.99839</span></span>
<span><span class="co">#&gt; [3,]    0  0.00000  0.00000  0.00000</span></span></code></pre></div>
<p>See the vignette on <a href="https://pbs-assess.github.io/sdmTMB/articles/residual-checking.html">Residual checking with sdmTMB</a>, <a href="https://pbs-assess.github.io/sdmTMB/reference/simulate.sdmTMB.html"><code>?simulate.sdmTMB</code></a>, and <a href="https://pbs-assess.github.io/sdmTMB/reference/dharma_residuals.html"><code>?dharma_residuals</code></a> for more details.</p>
</div>
</div>
<div class="section level3">
<h3 id="sampling-from-the-joint-precision-matrix">Sampling from the joint precision matrix<a class="anchor" aria-label="anchor" href="#sampling-from-the-joint-precision-matrix"></a>
</h3>
<p>We can take samples from the implied parameter distribution assuming an MVN covariance matrix on the internal parameterization:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">samps</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/gather_sims.html">gather_sims</a></span><span class="op">(</span><span class="va">fit</span>, nsim <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">samps</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">.value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">.variable</span>, scales <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span></span>
<span><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre></div>
<p><img src="reference/figures/README-plot-mvn-1.png" width="50%"></p>
<p>See <a href="https://pbs-assess.github.io/sdmTMB/reference/gather_sims.html"><code>?gather_sims</code></a> and <a href="https://pbs-assess.github.io/sdmTMB/reference/get_index_sims.html"><code>?get_index_sims</code></a> for more details.</p>
</div>
<div class="section level3">
<h3 id="calculating-uncertainty-on-spatial-predictions">Calculating uncertainty on spatial predictions<a class="anchor" aria-label="anchor" href="#calculating-uncertainty-on-spatial-predictions"></a>
</h3>
<p>The fastest way to get point-wise prediction uncertainty is to use the MVN samples:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">predictor_dat</span>, nsim <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">predictor_dat</span><span class="op">$</span><span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">p</span>, <span class="fl">1</span>, <span class="va">sd</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">predictor_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, fill <span class="op">=</span> <span class="va">se</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-plot-pred-mvn-1.png" width="50%"></p>
</div>
<div class="section level3">
<h3 id="cross-validation">Cross validation<a class="anchor" aria-label="anchor" href="#cross-validation"></a>
</h3>
<p>sdmTMB has built-in functionality for cross-validation. If we were to set a <code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">future::plan()</a></code>, the folds would be fit in parallel:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">pcod</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">## Set parallel processing if desired:</span></span>
<span><span class="co"># library(future)</span></span>
<span><span class="co"># plan(multisession)</span></span>
<span><span class="va">m_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdmTMB_cv.html">sdmTMB_cv</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">depth</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>, mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>, k_folds <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Running fits with `future.apply()`.</span></span>
<span><span class="co">#&gt; Set a parallel `future::plan()` to use parallel processing.</span></span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sum of log likelihoods of left-out data:</span></span>
<span><span class="va">m_cv</span><span class="op">$</span><span class="va">sum_loglik</span></span>
<span><span class="co">#&gt; [1] -6756.28</span></span></code></pre></div>
<p>See <a href="https://pbs-assess.github.io/sdmTMB/reference/sdmTMB_cv.html"><code>?sdmTMB_cv</code></a> for more details.</p>
</div>
<div class="section level3">
<h3 id="priors">Priors<a class="anchor" aria-label="anchor" href="#priors"></a>
</h3>
<p>Priors/penalties can be placed on most parameters. For example, here we place a PC (penalized complexity) prior on the MatÃ©rn random field parameters, a standard normal prior on the effect of depth, a Normal(0, 10^2) prior on the intercept, and a half-normal prior on the Tweedie dispersion parameter (<code>phi</code>):</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">pcod</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="va">depth_scaled</span>,</span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>, mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="reference/families.html">tweedie</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  priors <span class="op">=</span> <span class="fu"><a href="reference/priors.html">sdmTMBpriors</a></span><span class="op">(</span></span>
<span>    matern_s <span class="op">=</span> <span class="fu"><a href="reference/priors.html">pc_matern</a></span><span class="op">(</span>range_gt <span class="op">=</span> <span class="fl">10</span>, sigma_lt <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>    b <span class="op">=</span> <span class="fu"><a href="reference/priors.html">normal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    phi <span class="op">=</span> <span class="fu"><a href="reference/priors.html">halfnormal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can visualize the PC MatÃ©rn prior:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/plot_pc_matern.html">plot_pc_matern</a></span><span class="op">(</span>range_gt <span class="op">=</span> <span class="fl">10</span>, sigma_lt <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-plot-pc-matern-1.png" width="50%"></p>
<p>See <a href="https://pbs-assess.github.io/sdmTMB/reference/priors.html"><code>?sdmTMBpriors</code></a> for more details.</p>
</div>
<div class="section level3">
<h3 id="bayesian-mcmc-sampling-with-stan">Bayesian MCMC sampling with Stan<a class="anchor" aria-label="anchor" href="#bayesian-mcmc-sampling-with-stan"></a>
</h3>
<p>The fitted model can be passed to the tmbstan package to sample from the posterior with Stan. See the <a href="https://pbs-assess.github.io/sdmTMB/articles/bayesian.html">Bayesian vignette</a>.</p>
</div>
<div class="section level3">
<h3 id="turning-off-random-fields">Turning off random fields<a class="anchor" aria-label="anchor" href="#turning-off-random-fields"></a>
</h3>
<p>We can turn off the random fields for model comparison:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_sdmTMB</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">present</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html" class="external-link">poly</a></span><span class="op">(</span><span class="va">depth_scaled</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>, mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fit_glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span></span>
<span>  <span class="va">present</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html" class="external-link">poly</a></span><span class="op">(</span><span class="va">depth_scaled</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fit_sdmTMB</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 Ã— 3</span></span>
<span><span class="co">#&gt;   term                   estimate std.error</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;                     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 (Intercept)              -0.426    0.0573</span></span>
<span><span class="co">#&gt; 2 poly(depth_scaled, 2)1  -31.7      3.03  </span></span>
<span><span class="co">#&gt; 3 poly(depth_scaled, 2)2  -66.9      4.09</span></span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">broom</span><span class="fu">::</span><span class="fu">tidy</span><span class="op">(</span><span class="va">fit_glm</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 Ã— 5</span></span>
<span><span class="co">#&gt;   term                   estimate std.error statistic  p.value</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;                     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 (Intercept)              -0.426    0.0573     -7.44 1.03e-13</span></span>
<span><span class="co">#&gt; 2 poly(depth_scaled, 2)1  -31.7      3.03      -10.5  1.20e-25</span></span>
<span><span class="co">#&gt; 3 poly(depth_scaled, 2)2  -66.9      4.09      -16.4  3.50e-60</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="using-a-custom-fmesher-mesh">Using a custom fmesher mesh<a class="anchor" aria-label="anchor" href="#using-a-custom-fmesher-mesh"></a>
</h3>
<p>Defining a mesh directly with INLA:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bnd</span> <span class="op">&lt;-</span> <span class="fu">INLA</span><span class="fu">::</span><span class="fu">inla.nonconvex.hull</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">X</span>, <span class="va">pcod</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span>, convex <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">mesh_inla</span> <span class="op">&lt;-</span> <span class="fu">INLA</span><span class="fu">::</span><span class="fu">inla.mesh.2d</span><span class="op">(</span></span>
<span>  boundary <span class="op">=</span> <span class="va">bnd</span>,</span>
<span>  max.edge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">50</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">pcod</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, mesh <span class="op">=</span> <span class="va">mesh_inla</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mesh</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-inla-mesh-1.png" width="30%"></p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">depth</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>, mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="barrier-meshes">Barrier meshes<a class="anchor" aria-label="anchor" href="#barrier-meshes"></a>
</h3>
<p>A barrier mesh limits correlation across barriers (e.g., land or water). See <code><a href="reference/add_barrier_mesh.html">add_barrier_mesh()</a></code> in <a href="https://github.com/pbs-assess/sdmTMBextra" class="external-link">sdmTMBextra</a>.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=sdmTMB" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/pbs-assess/sdmTMB/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/pbs-assess/sdmTMB/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="https://www.r-project.org/Licenses/GPL-3" class="external-link">GPL-3</a></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing sdmTMB</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Sean C. Anderson <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0001-9563-1937" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Eric J. Ward <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0002-4359-0296" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Philina A. English <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0003-2992-6782" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Lewis A. K. Barnett <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0002-9381-8375" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>James T. Thorson <br><small class="roles"> Author, copyright holder </small> <a href="https://orcid.org/0000-0001-7415-1010" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li><a href="authors.html">More about authors...</a></li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://cran.r-project.org/package=sdmTMB" class="external-link"><img src="https://www.r-pkg.org/badges/version/sdmTMB"></a></li>
<li><a href="https://pbs-assess.github.io/sdmTMB/"><img src="https://img.shields.io/badge/documentation-sdmTMB-orange.svg?colorB=E91E63" alt="Documentation"></a></li>
<li><a href="https://github.com/pbs-assess/sdmTMB/actions" class="external-link"><img src="https://github.com/pbs-assess/sdmTMB/workflows/R-CMD-check/badge.svg" alt="R-CMD-check"></a></li>
<li><a href="https://app.codecov.io/gh/pbs-assess/sdmTMB?branch=main" class="external-link"><img src="https://codecov.io/gh/pbs-assess/sdmTMB/branch/main/graph/badge.svg" alt="Codecov test coverage"></a></li>
<li><a href="https://cranlogs.r-pkg.org/" class="external-link"><img src="https://cranlogs.r-pkg.org/badges/sdmTMB" alt="downloads"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sean C. Anderson, Eric J. Ward, Philina A. English, Lewis A. K. Barnett, James T. Thorson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
