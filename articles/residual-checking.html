<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Residual checking with sdmTMB • sdmTMB</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Residual checking with sdmTMB">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sdmTMB</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.4.9024</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/sdmTMB/sdmTMB/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Residual checking with sdmTMB</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/sdmTMB/sdmTMB/blob/main/vignettes/articles/residual-checking.Rmd" class="external-link"><code>vignettes/articles/residual-checking.Rmd</code></a></small>
      <div class="d-none name"><code>residual-checking.Rmd</code></div>
    </div>

    
    
<p><strong>If the code in this vignette has not been evaluated, a
rendered version is available on the <a href="https://sdmTMB.github.io/sdmTMB/index.html">documentation site</a>
under ‘Articles’.</strong></p>
<div class="section level2">
<h2 id="residual-checking-with-worked-examples">Residual checking with worked examples<a class="anchor" aria-label="anchor" href="#residual-checking-with-worked-examples"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sdmTMB.github.io/sdmTMB/">sdmTMB</a></span><span class="op">)</span></span></code></pre></div>
<p>We will start with some data simulated from scratch. We will simulate
from an NB2 negative binomial observation model, a spatial random field,
an intercept, and one predictor named ‘a1’ that will have a linear
effect on the observed data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">predictor_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>, Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>, a1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">predictor_dat</span>, xy_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB_simulate.html">sdmTMB_simulate</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">a1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">predictor_dat</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/families.html">nbinom2</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>  phi <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>  range <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>  sigma_O <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.8</span><span class="op">)</span> <span class="co"># B0 = intercept, B1 = a1 slope</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Next, we will fit model configurations with various families and
predictors. The first model will use the Poisson instead of the NB2. The
2nd model will match the simulated data. The third model is missing the
‘a1’ predictor. We’ll use a penalized complexity (PC) prior on the
Matérn parameters to aid in estimation.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/priors.html">pc_matern</a></span><span class="op">(</span>range_gt <span class="op">=</span> <span class="fl">0.1</span>, sigma_lt <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">a1</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span>, mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  priors <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">sdmTMBpriors</a></span><span class="op">(</span>matern_s <span class="op">=</span> <span class="va">pc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit_pois</span></span>
<span><span class="co">#&gt; Spatial model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: observed ~ 1 + a1</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Data: dat</span></span>
<span><span class="co">#&gt; Family: poisson(link = 'log')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;             coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)     0.27    0.17</span></span>
<span><span class="co">#&gt; a1              0.82    0.02</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matérn range: 0.12</span></span>
<span><span class="co">#&gt; Spatial SD: 1.20</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 2887.957</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span>
<span></span>
<span><span class="va">fit_nb2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">fit_pois</span>, family <span class="op">=</span> <span class="fu"><a href="../reference/families.html">nbinom2</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit_nb2</span></span>
<span><span class="co">#&gt; Spatial model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: observed ~ 1 + a1</span></span>
<span><span class="co">#&gt; Family: nbinom2(link = 'log')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;             coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)     0.52    0.14</span></span>
<span><span class="co">#&gt; a1              0.75    0.06</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 0.41</span></span>
<span><span class="co">#&gt; Matérn range: 0.29</span></span>
<span><span class="co">#&gt; Spatial SD: 0.42</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 1735.452</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span>
<span></span>
<span><span class="va">fit_nb2_miss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">fit_nb2</span>, formula. <span class="op">=</span> <span class="va">observed</span> <span class="op">~</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">fit_nb2_miss</span></span>
<span><span class="co">#&gt; Spatial model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: observed ~ 1</span></span>
<span><span class="co">#&gt; Family: nbinom2(link = 'log')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;             coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)     0.77    0.14</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 0.30</span></span>
<span><span class="co">#&gt; Matérn range: 0.21</span></span>
<span><span class="co">#&gt; Spatial SD: 0.56</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 1817.332</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
<p>We can see just by looking at these fits that the Poisson model
inflates the spatial random field standard deviation (SD) compared to
the truth. The model missing the ‘a1’ predictor does so to a lesser
degree.</p>
<div class="section level3">
<h3 id="analytical-randomized-quantile-residuals">Analytical randomized-quantile residuals<a class="anchor" aria-label="anchor" href="#analytical-randomized-quantile-residuals"></a>
</h3>
<p>Here are randomized quantile residuals with fixed effect at their
MLEs (Maximum Likelihood Estimates) and random effects taken from a
single sample of their approximate distribution (more details
below):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">rq_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit_pois</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span></span>
<span><span class="va">rq_res</span> <span class="op">&lt;-</span> <span class="va">rq_res</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">rq_res</span><span class="op">)</span><span class="op">]</span> <span class="co"># some Inf</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">rq_res</span><span class="op">)</span>;<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-3-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">rq_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit_nb2</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">rq_res</span><span class="op">)</span>;<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-3-2.png" class="r-plt" width="672"></p>
<p>These use the randomized quantile approach from Dunn and Smyth
(1996). They are also known as PIT (probability-integral-transform)
residuals. They apply randomization to integer response values,
transform the residuals using the distribution function (e.g.,
<code><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm()</a></code>) to reflect a uniform(0, 1) distribution, and
transform those values such that they would be normal(0, 1) if
consistent with the model. You can see the source code at <a href="https://github.com/sdmTMB/sdmTMB/blob/master/R/residuals.R" class="external-link uri">https://github.com/sdmTMB/sdmTMB/blob/master/R/residuals.R</a></p>
<p>We can see here that there are likely issues with the Poisson model
in the tails.</p>
</div>
<div class="section level3">
<h3 id="mcmc-based-randomized-quantile-residuals">MCMC-based randomized-quantile residuals<a class="anchor" aria-label="anchor" href="#mcmc-based-randomized-quantile-residuals"></a>
</h3>
<p>The above approach assumes an observation of the random effects can
be approximated by a multivariate normal distribution. If we want to
relax that assumption, we can sample the random effects with MCMC with
the fixed effects held at their MLEs. We do this with the
<code><a href="https://rdrr.io/pkg/sdmTMBextra/man/predict_mle_mcmc.html" class="external-link">sdmTMBextra::predict_mle_mcmc()</a></code> function in the <a href="https://github.com/sdmTMB/sdmTMBextra" class="external-link">sdmTMBextra</a>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">samps</span> <span class="op">&lt;-</span> <span class="fu">sdmTMBextra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sdmTMBextra/man/predict_mle_mcmc.html" class="external-link">predict_mle_mcmc</a></span><span class="op">(</span><span class="va">fit_nb2</span>, mcmc_iter <span class="op">=</span> <span class="fl">800</span>, mcmc_warmup <span class="op">=</span> <span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'tmb_generic' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 0.0011 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 11 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:   1 / 800 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  80 / 800 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 160 / 800 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 240 / 800 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 320 / 800 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 400 / 800 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 401 / 800 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 480 / 800 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 560 / 800 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 640 / 800 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 720 / 800 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 800 / 800 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 6.777 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                4.906 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                11.683 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1:</span></span>
<span><span class="va">mcmc_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit_nb2</span>, type <span class="op">=</span> <span class="st">"mle-mcmc"</span>, mcmc_samples <span class="op">=</span> <span class="va">samps</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">mcmc_res</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-4-1.png" class="r-plt" width="672"></p>
</div>
<div class="section level3">
<h3 id="simulation-based-randomized-quantile-residuals">Simulation-based randomized-quantile residuals<a class="anchor" aria-label="anchor" href="#simulation-based-randomized-quantile-residuals"></a>
</h3>
<p>We can also take simulations from the fitted model to use with
simulation-based randomized quantile residuals:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s_pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit_pois</span>, nsim <span class="op">=</span> <span class="fl">500</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span></span>
<span><span class="va">s_nb2_miss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit_nb2_miss</span>, nsim <span class="op">=</span> <span class="fl">500</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span></span>
<span><span class="va">s_nb2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit_nb2</span>, nsim <span class="op">=</span> <span class="fl">500</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span></span></code></pre></div>
<p>These return a matrix where each row represents a row of data and
each column is a simulation draw:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">s_pois</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1000  500</span></span></code></pre></div>
<p>We can look at whether fitted models are consistent with the observed
number of zeros:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">observed</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">observed</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.527</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s_pois</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">s_pois</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.292788</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s_nb2</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">s_nb2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.524644</span></span></code></pre></div>
<p>There are obviously too few zeros in the data simulated from the
Poisson model but the NB2 model seems reasonable.</p>
<p>Plot DHARMa residuals:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dharma_residuals.html">dharma_residuals</a></span><span class="op">(</span><span class="va">s_pois</span>, <span class="va">fit_pois</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-8-1.png" class="r-plt" width="672"></p>
<p>We could also return the DHARMa object, which lets us use other
DHARMa tools:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r_pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dharma_residuals.html">dharma_residuals</a></span><span class="op">(</span><span class="va">s_pois</span>, <span class="va">fit_pois</span>, return_DHARMa <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r_pois</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-9-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DHARMa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DHARMa/man/testResiduals.html" class="external-link">testResiduals</a></span><span class="op">(</span><span class="va">r_pois</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-9-2.png" class="r-plt" width="672"></p>
<pre><code><span><span class="co">#&gt; $uniformity</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Asymptotic one-sample Kolmogorov-Smirnov test</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  simulationOutput$scaledResiduals</span></span>
<span><span class="co">#&gt; D = 0.23338, p-value &lt; 2.2e-16</span></span>
<span><span class="co">#&gt; alternative hypothesis: two-sided</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dispersion</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  DHARMa nonparametric dispersion test via sd of residuals fitted vs.</span></span>
<span><span class="co">#&gt;  simulated</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  simulationOutput</span></span>
<span><span class="co">#&gt; dispersion = 8.6989, p-value &lt; 2.2e-16</span></span>
<span><span class="co">#&gt; alternative hypothesis: two.sided</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $outliers</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  DHARMa outlier test based on exact binomial test with approximate</span></span>
<span><span class="co">#&gt;  expectations</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  simulationOutput</span></span>
<span><span class="co">#&gt; outliers at both margin(s) = 111, observations = 1000, p-value &lt;</span></span>
<span><span class="co">#&gt; 2.2e-16</span></span>
<span><span class="co">#&gt; alternative hypothesis: true probability of success is not equal to 0.003992016</span></span>
<span><span class="co">#&gt; 95 percent confidence interval:</span></span>
<span><span class="co">#&gt;  0.09219791 0.13212606</span></span>
<span><span class="co">#&gt; sample estimates:</span></span>
<span><span class="co">#&gt; frequency of outliers (expected: 0.00399201596806387 ) </span></span>
<span><span class="co">#&gt;                                                  0.111</span></span>
<span><span class="fu">DHARMa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DHARMa/man/testSpatialAutocorrelation.html" class="external-link">testSpatialAutocorrelation</a></span><span class="op">(</span><span class="va">r_pois</span>, x <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">X</span>, y <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span></span></code></pre>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-9-3.png" class="r-plt" width="672"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  DHARMa Moran's I test for distance-based autocorrelation</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  r_pois</span></span>
<span><span class="co">#&gt; observed = -0.0022978, expected = -0.0010010, sd = 0.0026264, p-value =</span></span>
<span><span class="co">#&gt; 0.6215</span></span>
<span><span class="co">#&gt; alternative hypothesis: Distance-based autocorrelation</span></span>
<span><span class="fu">DHARMa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DHARMa/man/testZeroInflation.html" class="external-link">testZeroInflation</a></span><span class="op">(</span><span class="va">r_pois</span><span class="op">)</span></span></code></pre>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-9-4.png" class="r-plt" width="672"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  DHARMa zero-inflation test via comparison to expected zeros with</span></span>
<span><span class="co">#&gt;  simulation under H0 = fitted model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  simulationOutput</span></span>
<span><span class="co">#&gt; ratioObsSim = 1.7999, p-value &lt; 2.2e-16</span></span>
<span><span class="co">#&gt; alternative hypothesis: two.sided</span></span></code></pre>
<p>In the QQ residual plots we clearly see evidence of overdispersion
compared to the Poisson. Note the values clumping near 1.0 on the
observed axis and deviating downwards towards 0.0 observed. This is
indicative of too many zeros and the variance scaling too rapidly with
the mean (resulting in some large outlying value) for the Poisson
distribution.</p>
<p>Lets try with the correct model:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r_nb2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dharma_residuals.html">dharma_residuals</a></span><span class="op">(</span><span class="va">s_nb2</span>, <span class="va">fit_nb2</span>, return_DHARMa <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r_nb2</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-10-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DHARMa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DHARMa/man/testZeroInflation.html" class="external-link">testZeroInflation</a></span><span class="op">(</span><span class="va">r_nb2</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-10-2.png" class="r-plt" width="672"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  DHARMa zero-inflation test via comparison to expected zeros with</span></span>
<span><span class="co">#&gt;  simulation under H0 = fitted model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  simulationOutput</span></span>
<span><span class="co">#&gt; ratioObsSim = 1.0045, p-value = 0.908</span></span>
<span><span class="co">#&gt; alternative hypothesis: two.sided</span></span></code></pre>
<p>Everything looks fine.</p>
<p>What about the model where we were missing a predictor?</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r_nb2_miss</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dharma_residuals.html">dharma_residuals</a></span><span class="op">(</span><span class="va">s_nb2_miss</span>, <span class="va">fit_nb2_miss</span>, return_DHARMa <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r_nb2_miss</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-11-1.png" class="r-plt" width="672"></p>
<p>The plot on the right represents simulated residuals against the
prediction without the random effects, which here is just an intercept.
Lets try plotting the residuals against the missing predictor:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DHARMa</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DHARMa/man/plotResiduals.html" class="external-link">plotResiduals</a></span><span class="op">(</span><span class="va">r_nb2_miss</span>, form <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">a1</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-12-1.png" class="r-plt" width="672"></p>
<p>We can see a trend in the residuals against ‘a1’ since we have missed
including it in the model.</p>
<p>We can also see the difference in the log likelihood or the AIC:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">fit_nb2_miss</span>, <span class="va">fit_nb2</span><span class="op">)</span></span>
<span><span class="co">#&gt;              df      AIC</span></span>
<span><span class="co">#&gt; fit_nb2_miss  4 3642.665</span></span>
<span><span class="co">#&gt; fit_nb2       5 3480.904</span></span></code></pre></div>
<p>AIC also supports including the ‘a1’ predictor.</p>
<p>For help interpreting the DHARMa residual plots, see
<code><a href="https://cran.rstudio.com/web/packages/DHARMa/vignettes/DHARMa.html" class="external-link">vignette("DHARMa", package="DHARMa")</a></code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="the-need-for-one-sample-residuals">The need for one-sample residuals<a class="anchor" aria-label="anchor" href="#the-need-for-one-sample-residuals"></a>
</h2>
<p>The above used random effects drawn as if they were observed
once.</p>
<p>The approach is described in Waagepetersen (2006) and is <a href="https://github.com/kaskr/adcomp/blob/c62bab02d60138d7a480b7c8bc30533efc7f2ce0/TMB/R/validation.R#L628-L640" class="external-link">summarized
nicely</a> in an unexported function oneSamplePosterior within TMB.
Thygesen et al. (2017) also describes them in the context of one-sample
MCMC residuals.</p>
<p>Here we will show why this is necessary.</p>
<p>We’ll start by simulating some data with Gaussian observation error
and spatial and spatiotemporal random effects.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">predictor_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>, Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>,</span>
<span>  year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, each <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">predictor_dat</span>, xy_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">sim_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB_simulate.html">sdmTMB_simulate</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">predictor_dat</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  range <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  sigma_E <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  phi <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  sigma_O <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  B <span class="op">=</span> <span class="fl">0.2</span> <span class="co"># intercept</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">sim_dat</span>, time <span class="op">=</span> <span class="st">"year"</span>, mesh <span class="op">=</span> <span class="va">mesh</span><span class="op">)</span></span></code></pre></div>
<p>If we use the empirical Bayes (EB) random effect values (the values
of the random effects that maximize the log likelihood conditional on
the estimated fixed effects), our residuals look off even though our
model is perfectly matched to our simulated data:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">r1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit</span>, type <span class="op">=</span> <span class="st">"mle-eb"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">r1</span><span class="op">)</span>;<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-15-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/ks.test.html" class="external-link">ks.test</a></span><span class="op">(</span><span class="va">r1</span>, <span class="va">pnorm</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Asymptotic one-sample Kolmogorov-Smirnov test</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  r1</span></span>
<span><span class="co">#&gt; D = 0.058629, p-value = 0.002067</span></span>
<span><span class="co">#&gt; alternative hypothesis: two-sided</span></span></code></pre></div>
<p>Indeed, our test (incorrectly) rejects the null hypothesis that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mn>1</mn></msub><mo>∼</mo><mo>N</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">r_1 \sim \operatorname{N}(0, 1)</annotation></semantics></math>,
when if calculated correctly we know they do come from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>N</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\operatorname{N}(0, 1)</annotation></semantics></math></p>
<p>If instead we returned to our single sample from the assumed MVN
random effect distribution, we get the ‘correct’ residuals:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">r2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">r2</span><span class="op">)</span>;<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-16-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/ks.test.html" class="external-link">ks.test</a></span><span class="op">(</span><span class="va">r2</span>, <span class="va">pnorm</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Asymptotic one-sample Kolmogorov-Smirnov test</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  r2</span></span>
<span><span class="co">#&gt; D = 0.020639, p-value = 0.7879</span></span>
<span><span class="co">#&gt; alternative hypothesis: two-sided</span></span></code></pre></div>
<p>Here, we would (correctly) fail to reject the hypothesis that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mn>2</mn></msub><mo>∼</mo><mo>N</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">r_2 \sim \operatorname{N}(0, 1)</annotation></semantics></math>.</p>
<p>We could also sample that observation of random effects using MCMC
(with the fixed effects still held at their MLEs), which relaxes our
assumptions, but is much more time intensive for large models.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">samp</span> <span class="op">&lt;-</span> <span class="fu">sdmTMBextra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sdmTMBextra/man/predict_mle_mcmc.html" class="external-link">predict_mle_mcmc</a></span><span class="op">(</span><span class="va">fit</span>, mcmc_iter <span class="op">=</span> <span class="fl">400</span>, mcmc_warmup <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'tmb_generic' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 0.002162 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 21.62 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:   1 / 400 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  40 / 400 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  80 / 400 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 120 / 400 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 160 / 400 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 200 / 400 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 201 / 400 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 240 / 400 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 280 / 400 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 320 / 400 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 360 / 400 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 400 / 400 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 32.987 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                32.58 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                65.567 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1:</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is 1.07, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span>
<span><span class="va">r3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit</span>, type <span class="op">=</span> <span class="st">"mle-mcmc"</span>, mcmc_samples <span class="op">=</span> <span class="va">samp</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">r3</span><span class="op">)</span>;<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-17-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/ks.test.html" class="external-link">ks.test</a></span><span class="op">(</span><span class="va">r3</span>, <span class="va">pnorm</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Asymptotic one-sample Kolmogorov-Smirnov test</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  r3</span></span>
<span><span class="co">#&gt; D = 0.024973, p-value = 0.561</span></span>
<span><span class="co">#&gt; alternative hypothesis: two-sided</span></span></code></pre></div>
<p>Here that gets us something similar and we would (correctly) fail to
reject the hypothesis that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mn>3</mn></msub><mo>∼</mo><mo>N</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">r_3 \sim \operatorname{N}(0, 1)</annotation></semantics></math>.</p>
<p>A similar issue applies to simulation-based quantile residuals, as
implemented in the DHARMa package.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit</span>, nsim <span class="op">=</span> <span class="fl">500</span>, type <span class="op">=</span> <span class="st">"mle-eb"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/dharma_residuals.html">dharma_residuals</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: It is recommended to use `simulate.sdmTMB(fit, type = 'mle-mvn')` if simulating</span></span>
<span><span class="co">#&gt; for DHARMa residuals. See the description in ?residuals.sdmTMB under the types</span></span>
<span><span class="co">#&gt; of residuals section.</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-18-1.png" class="r-plt" width="672"></p>
<p>Instead we can use a draw from the random effects ‘posterior’
assuming an MVN distribution.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit</span>, nsim <span class="op">=</span> <span class="fl">500</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/dharma_residuals.html">dharma_residuals</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-19-1.png" class="r-plt" width="672"></p>
<p>And now that looks correct.</p>
<p>However, what happens if we were to sample the random effects with
each simulation?</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit</span>, nsim <span class="op">=</span> <span class="fl">1</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span>, simplify <span class="op">=</span> <span class="st">"matrix"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"type"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"mle-mvn"</span></span>
<span><span class="fu"><a href="../reference/dharma_residuals.html">dharma_residuals</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-20-1.png" class="r-plt" width="672"></p>
<p>We get back to something with the incorrect distribution for
comparison! So, we need a single random effects sample per set of
simulations.</p>
</div>
<div class="section level2">
<h2 id="how-much-this-matters-depends-on-the-ratio-of-observation-error-variance-vs--random-effect-variance">How much this matters depends on the ratio of observation error
variance vs. random effect variance<a class="anchor" aria-label="anchor" href="#how-much-this-matters-depends-on-the-ratio-of-observation-error-variance-vs--random-effect-variance"></a>
</h2>
<p>Lets simulate data again but with large observation error
(<code>phi</code> here, which is the Gaussian error SD in this case) and
with smaller levels of random field variance (<code>sigma_E</code> and
<code>sigma_O</code>):</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">sim_dat2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB_simulate.html">sdmTMB_simulate</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">predictor_dat</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  range <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  sigma_E <span class="op">=</span> <span class="fl">0.1</span>, <span class="co"># smaller than before</span></span>
<span>  sigma_O <span class="op">=</span> <span class="fl">0.1</span>, <span class="co"># smaller than before</span></span>
<span>  phi <span class="op">=</span> <span class="fl">0.5</span>, <span class="co"># bigger than before</span></span>
<span>  seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  B <span class="op">=</span> <span class="fl">0.2</span> </span>
<span><span class="op">)</span></span>
<span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">sim_dat2</span>, time <span class="op">=</span> <span class="st">"year"</span>, mesh <span class="op">=</span> <span class="va">mesh</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sanity.html">sanity</a></span><span class="op">(</span><span class="va">fit2</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Non-linear minimizer suggests successful convergence</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Hessian matrix is positive definite</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> No extreme or very small eigenvalues detected</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> No gradients with respect to fixed effects are &gt;= 0.001</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> No fixed-effect standard errors are NA</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> No standard errors look unreasonably large</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> No sigma parameters are &lt; 0.01</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> No sigma parameters are &gt; 100</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Range parameter doesn't look unreasonably large</span></span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">r1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit2</span>, type <span class="op">=</span> <span class="st">"mle-eb"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">r1</span><span class="op">)</span>;<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-22-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/ks.test.html" class="external-link">ks.test</a></span><span class="op">(</span><span class="va">r1</span>, <span class="va">pnorm</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Asymptotic one-sample Kolmogorov-Smirnov test</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  r1</span></span>
<span><span class="co">#&gt; D = 0.021085, p-value = 0.7656</span></span>
<span><span class="co">#&gt; alternative hypothesis: two-sided</span></span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit2</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">r2</span><span class="op">)</span>;<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-23-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/ks.test.html" class="external-link">ks.test</a></span><span class="op">(</span><span class="va">r2</span>, <span class="va">pnorm</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Asymptotic one-sample Kolmogorov-Smirnov test</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  r2</span></span>
<span><span class="co">#&gt; D = 0.016869, p-value = 0.9385</span></span>
<span><span class="co">#&gt; alternative hypothesis: two-sided</span></span></code></pre></div>
<p>Now, it doesn’t really matter since the ‘incorrect’ random effect
distribution is swamped by the observation error effect on the
distribution. Technically, the first set is ‘wrong’ and the second set
is ‘right’, but functionally we’d come to a similar conclusion in this
case.</p>
</div>
<div class="section level2">
<h2 id="notes-on-uniform-vs--normal-quantile-residuals">Notes on uniform vs. normal quantile residuals<a class="anchor" aria-label="anchor" href="#notes-on-uniform-vs--normal-quantile-residuals"></a>
</h2>
<p>The randomized quantile residuals in <code><a href="../reference/residuals.sdmTMB.html">residuals.sdmTMB()</a></code>
are returned such that they will be normal(0, 1) if the model is
consistent with the data. DHARMa residuals, however, are returned as
uniform(0, 1) under those same circumstances. Both are valid, and which
to use is preference, but it’s important to appreciate how this changes
the appearance of the expected residuals.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit2</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span></span></code></pre></div>
<p>Analytical normal(0, 1):</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">r2</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-25-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">r2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-25-2.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/ks.test.html" class="external-link">ks.test</a></span><span class="op">(</span><span class="va">r2</span>, <span class="va">pnorm</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Asymptotic one-sample Kolmogorov-Smirnov test</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  r2</span></span>
<span><span class="co">#&gt; D = 0.025614, p-value = 0.528</span></span>
<span><span class="co">#&gt; alternative hypothesis: two-sided</span></span></code></pre></div>
<p>Analytical uniform(0, 1):</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">r2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-26-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">n</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqplot</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">u</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/ks.test.html" class="external-link">ks.test</a></span><span class="op">(</span><span class="va">u</span>, <span class="va">punif</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Asymptotic one-sample Kolmogorov-Smirnov test</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  u</span></span>
<span><span class="co">#&gt; D = 0.025614, p-value = 0.528</span></span>
<span><span class="co">#&gt; alternative hypothesis: two-sided</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-26-2.png" class="r-plt" width="672"></p>
<p>Simulation-based uniform(0, 1):</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit2</span>, nsim <span class="op">=</span> <span class="fl">500</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/dharma_residuals.html">dharma_residuals</a></span><span class="op">(</span><span class="va">fit2</span>, return_DHARMa <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">scaledResiduals</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-27-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">u</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">scaledResiduals</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span><span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqplot</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">u</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-27-2.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/ks.test.html" class="external-link">ks.test</a></span><span class="op">(</span><span class="va">u</span>, <span class="va">punif</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Asymptotic one-sample Kolmogorov-Smirnov test</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  u</span></span>
<span><span class="co">#&gt; D = 0.026, p-value = 0.5085</span></span>
<span><span class="co">#&gt; alternative hypothesis: two-sided</span></span></code></pre></div>
<p>Simulation-based normal(0, 1):</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit2</span>, nsim <span class="op">=</span> <span class="fl">1500</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/dharma_residuals.html">dharma_residuals</a></span><span class="op">(</span><span class="va">fit2</span>, return_DHARMa <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">u</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">scaledResiduals</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-28-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/ks.test.html" class="external-link">ks.test</a></span><span class="op">(</span><span class="va">u</span>, <span class="va">punif</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Asymptotic one-sample Kolmogorov-Smirnov test</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data:  u</span></span>
<span><span class="co">#&gt; D = 0.028, p-value = 0.4131</span></span>
<span><span class="co">#&gt; alternative hypothesis: two-sided</span></span></code></pre></div>
<p>Conclusions:</p>
<p>The normal(0, 1) residuals are probably more familiar to most
people.</p>
<p>The normal(0, 1) residuals put more emphasis on the tails. This is
good and bad: it’s easier to examine tail behaviour, but these can often
look ‘off’ even when the model is fine (as in this example) because
observations in the tails of the distribution are by definition rarely
observed.</p>
<p>Uniform(0, 1) residuals give all data points equal visual weight and
emphasize consistency of the overall distribution rather than the
tails.</p>
<p>Either is valid, but you do need to switch your mindset about what
you expect to see accordingly. For example, poor tail behaviour may look
like a minor issue with uniform residuals; conversely the tails of
normal(0, 1) residuals are unlikely to ever look ‘perfect’ without large
sample sizes.</p>
</div>
<div class="section level2">
<h2 id="how-do-those-randomized-quantile-residuals-work">How do those randomized-quantile residuals work?<a class="anchor" aria-label="anchor" href="#how-do-those-randomized-quantile-residuals-work"></a>
</h2>
<p>Let’s work through a simple example with the gamma distribution:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">phi</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span>, shape <span class="op">=</span> <span class="va">phi</span>, scale <span class="op">=</span> <span class="va">mu</span> <span class="op">/</span> <span class="va">phi</span><span class="op">)</span></span></code></pre></div>
<p>To get quantile residuals, we transform those to uniform(0, 1) using
<code><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">pgamma()</a></code> and then (optionally) convert those to normal(0,
1) with <code><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm()</a></code>:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">pgamma</a></span><span class="op">(</span>q <span class="op">=</span> <span class="va">y</span>, shape <span class="op">=</span> <span class="va">phi</span>, scale <span class="op">=</span> <span class="va">mu</span> <span class="op">/</span> <span class="va">phi</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-30-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-30-2.png" class="r-plt" width="672"></p>
<p>This works for any distribution if we can define the quantile
function.</p>
<p>If we have integer values, we need to add randomization in an
additional step. Let’s work with a Poisson sample:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span>, <span class="va">mu</span><span class="op">)</span></span></code></pre></div>
<p>The gamma example above illustrated how we can use the distribution
function (there <code><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">pgamma()</a></code>) to take a gamma-distributed
variable and turn it into a uniform-distributed variable.</p>
<p>Now we need to do the same with the Poisson equivalent:
<code><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">ppois()</a></code>. The <code>ppois(y)</code> function gives us the
cumulative probability density up to value <code>y</code>. Say we have a
Poisson variable with a mean (lambda) of 5 and we have an observation
with a value of 3. We can calculate the density up to the value of 3
as:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">ppois</a></span><span class="op">(</span><span class="fl">3</span>, <span class="va">lambda</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.2650259</span></span></code></pre></div>
<p>I.e., that is the same as:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">lambda</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">lambda</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">lambda</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="fl">3</span>, <span class="va">lambda</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.2650259</span></span></code></pre></div>
<p>But, if we naively apply <code><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">ppois()</a></code> to the observed values
we’ll end up with discrete cumulative probabilities that aren’t very
useful for comparing against the continuous uniform.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">ppois</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">mu</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-34-1.png" class="r-plt" width="672"></p>
<p>Instead, we need to get the probability density up the value below
the one we observed and “fill in” the values up to the observed value
with the desired uniformly distributed samples. First, get the density
up to the value below and the observed value:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">ppois</a></span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="fl">1</span>, <span class="va">mu</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-35-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">ppois</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">mu</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-35-2.png" class="r-plt" width="672"></p>
<p>Then we can add randomization between these using
<code><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif()</a></code> since our expectation is a uniform distribution at
this stage to fill in the values between:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, min <span class="op">=</span> <span class="va">a</span>, max <span class="op">=</span> <span class="va">b</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-36-1.png" class="r-plt" width="672"></p>
<p>Then we optionally apply <code><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm()</a></code>:</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="residual-checking_files/figure-html/unnamed-chunk-37-1.png" class="r-plt" width="672"></p>
</div>
<div class="section level2">
<h2 id="how-do-those-simulation-based-residuals-work">How do those simulation-based residuals work?<a class="anchor" aria-label="anchor" href="#how-do-those-simulation-based-residuals-work"></a>
</h2>
<p>DHARMa uses simulation-based quantile residuals. As a result, we
don’t need to define the quantile function analytically. So, instead of
a line like this:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">pgamma</a></span><span class="op">(</span>q <span class="op">=</span> <span class="va">y</span>, shape <span class="op">=</span> <span class="va">phi</span>, scale <span class="op">=</span> <span class="va">mu</span> <span class="op">/</span> <span class="va">phi</span><span class="op">)</span></span></code></pre></div>
<p>We simulate from our model repeatedly, see where our observation
falls within the simulated values, and get our quantile that way. For
example, instead of this:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="fl">2.2</span>, mean <span class="op">=</span> <span class="fl">0.5</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.9554345</span></span></code></pre></div>
<p>we could do this:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1e6</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span> <span class="co"># equivalent of simulate()ing from our model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">s</span> <span class="op">&lt;</span> <span class="fl">2.2</span><span class="op">)</span> <span class="co"># equivalent of pnorm()</span></span>
<span><span class="co">#&gt; [1] 0.955308</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Dunn, P.K., and Smyth, G.K. 1996. Randomized Quantile Residuals.
Journal of Computational and Graphical Statistics 5(3): 236–244.</p>
<p>Waagepetersen, R. 2006. A Simulation-Based Goodness-of-Fit Test for
Random Effects in Generalized Linear Mixed Models. Scandinavian Journal
of Statistics 33(4): 721–731.</p>
<p>Thygesen, U.H., Albertsen, C.M., Berg, C.W., Kristensen, K., and
Nielsen, A. 2017. Validation of ecological state space models using the
Laplace approximation. Environ Ecol Stat 24(2): 317–339.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sean C. Anderson, Eric J. Ward, Philina A. English, Lewis A. K. Barnett, James T. Thorson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
