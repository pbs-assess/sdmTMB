<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Index standardization with sdmTMB • sdmTMB</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Index standardization with sdmTMB">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sdmTMB</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.0.9032</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/basic-intro.html">Introduction to modelling with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/bayesian.html">Bayesian estimation with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/cross-validation.html">Cross-validation for model evaluation and comparison</a></li>
    <li><a class="dropdown-item" href="../articles/delta-models.html">Fitting delta (hurdle) models with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/forecasting.html">Forecasting with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/ggeffects.html">Visualizing marginal effects in sdmTMB models with ggeffects</a></li>
    <li><a class="dropdown-item" href="../articles/index-standardization.html">Index standardization with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/model-description.html">sdmTMB model description</a></li>
    <li><a class="dropdown-item" href="../articles/multispecies.html">Fitting multispecies models with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/poisson-link.html">Poisson-link delta models</a></li>
    <li><a class="dropdown-item" href="../articles/presence-only.html">Spatial Modeling of Presence-Only Data with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/pretty-plots.html">Making pretty maps with sdmTMB output</a></li>
    <li><a class="dropdown-item" href="../articles/residual-checking.html">Residual checking with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/spatial-trend-models.html">Fitting spatial trend models with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/threshold-models.html">Threshold modeling with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/visreg.html">Visualizing sdmTMB conditional effects using visreg</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pbs-assess/sdmTMB/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Index standardization with sdmTMB</h1>
            
            <h4 data-toc-skip class="date">2025-03-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/pbs-assess/sdmTMB/blob/main/vignettes/articles/index-standardization.Rmd" class="external-link"><code>vignettes/articles/index-standardization.Rmd</code></a></small>
      <div class="d-none name"><code>index-standardization.Rmd</code></div>
    </div>

    
    
<p><strong>If the code in this vignette has not been evaluated, a
rendered version is available on the <a href="https://pbs-assess.github.io/sdmTMB/index.html">documentation
site</a> under ‘Articles’.</strong></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pbs-assess.github.io/sdmTMB/">sdmTMB</a></span><span class="op">)</span></span></code></pre></div>
<p>Let’s perform index standardization with the built-in data for
Pacific cod.</p>
<ul>
<li>The density units should be kg/km<sup>2</sup>.</li>
<li>Here, X and Y are coordinates in UTM zone 9.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 2,143</span></span>
<span><span class="co">#&gt; Columns: 12</span></span>
<span><span class="co">#&gt; $ year          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 2003, 2003, 2003, 2003, 2003, 2003, 2003, 2003, 2003, 20…</span></span>
<span><span class="co">#&gt; $ X             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 446.4752, 446.4594, 448.5987, 436.9157, 420.6101, 417.71…</span></span>
<span><span class="co">#&gt; $ Y             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 5793.426, 5800.136, 5801.687, 5802.305, 5771.055, 5772.2…</span></span>
<span><span class="co">#&gt; $ depth         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 201, 212, 220, 197, 256, 293, 410, 387, 285, 270, 381, 1…</span></span>
<span><span class="co">#&gt; $ density       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 113.138476, 41.704922, 0.000000, 15.706138, 0.000000, 0.…</span></span>
<span><span class="co">#&gt; $ present       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,…</span></span>
<span><span class="co">#&gt; $ lat           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 52.28858, 52.34890, 52.36305, 52.36738, 52.08437, 52.094…</span></span>
<span><span class="co">#&gt; $ lon           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -129.7847, -129.7860, -129.7549, -129.9265, -130.1586, -…</span></span>
<span><span class="co">#&gt; $ depth_mean    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 5.155194, 5.155194, 5.155194, 5.155194, 5.155194, 5.1551…</span></span>
<span><span class="co">#&gt; $ depth_sd      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.4448783, 0.4448783, 0.4448783, 0.4448783, 0.4448783, 0…</span></span>
<span><span class="co">#&gt; $ depth_scaled  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.3329252, 0.4526914, 0.5359529, 0.2877417, 0.8766077, 1…</span></span>
<span><span class="co">#&gt; $ depth_scaled2 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.11083919, 0.20492947, 0.28724555, 0.08279527, 0.768440…</span></span></code></pre></div>
<p>First we will create our SPDE mesh. We will use a relatively course
mesh for a balance between speed and accuracy in this vignette
(<code>cutoff = 10</code> where cutoff is in the units of X and Y (km
here) and represents the minimum distance between points before a new
mesh vertex is added). You will likely want to use a higher resolution
mesh for applied scenarios. You will want to make sure that increasing
the number of knots does not change the conclusions.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pcod_spde</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">pcod</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pcod_spde</span><span class="op">)</span></span></code></pre></div>
<p><img src="index-standardization_files/figure-html/spde-1.png" width="672"></p>
<p>Let’s fit a GLMM. Note that if you want to use this model for index
standardization then you will likely want to include
<code>0 + as.factor(year)</code> or <code>-1 + as.factor(year)</code> so
that there is a factor predictor that represents the mean estimate for
each time slice.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>, </span>
<span>  formula <span class="op">=</span> <span class="va">density</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>, mesh <span class="op">=</span> <span class="va">pcod_spde</span>, family <span class="op">=</span> <span class="fu"><a href="../reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can inspect randomized quantile residuals:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pcod</span><span class="op">$</span><span class="va">resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="co"># randomized quantile residuals</span></span>
<span><span class="co">#&gt; Note what used to be the default sdmTMB residuals (before version 0.4.3.9005)</span></span>
<span><span class="co">#&gt; are now `type = 'mle-eb'`. We recommend using the current default `'mle-mvn'`,</span></span>
<span><span class="co">#&gt; which takes one sample from the approximate posterior of the random effects or</span></span>
<span><span class="co">#&gt; `dharma_residuals()` using a similar approach.</span></span>
<span><span class="co"># Also see residuals(..., type = "mle-mcmc") which are better but slower</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">resids</span><span class="op">)</span></span></code></pre></div>
<p><img src="index-standardization_files/figure-html/residuals-1.png" width="768"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">resids</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">0</span>, b <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="index-standardization_files/figure-html/residuals-2.png" width="768"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pcod</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, col <span class="op">=</span> <span class="va">resids</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_colour_gradient2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="index-standardization_files/figure-html/residuals-3.png" width="768"></p>
<p>Now we want to predict on a fine-scale grid on the entire survey
domain. There is a grid built into the package for Queen Charlotte Sound
named <code>qcs_grid</code>. Our prediction grid also needs to have all
the covariates that we used in the model above.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">qcs_grid</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 7,314</span></span>
<span><span class="co">#&gt; Columns: 5</span></span>
<span><span class="co">#&gt; $ X             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 456, 458, 460, 462, 464, 466, 468, 470, 472, 474, 476, 4…</span></span>
<span><span class="co">#&gt; $ Y             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 5636, 5636, 5636, 5636, 5636, 5636, 5636, 5636, 5636, 56…</span></span>
<span><span class="co">#&gt; $ depth         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 347.08345, 223.33479, 203.74085, 183.29868, 182.99983, 1…</span></span>
<span><span class="co">#&gt; $ depth_scaled  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1.56081222, 0.56976988, 0.36336929, 0.12570465, 0.122036…</span></span>
<span><span class="co">#&gt; $ depth_scaled2 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 2.436134794, 0.324637712, 0.132037240, 0.015801659, 0.01…</span></span></code></pre></div>
<p>We can replicate our grid across all years:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid_yrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/replicate_df.html">replicate_df</a></span><span class="op">(</span><span class="va">qcs_grid</span>, <span class="st">"year"</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now make the predictions on new data.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span>, newdata <span class="op">=</span> <span class="va">grid_yrs</span>, return_tmb_object <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Let’s make a small function to make maps.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_map</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">column</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, fill <span class="op">=</span> <span class="op">{</span><span class="op">{</span> <span class="va">column</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>There are four kinds of predictions that we get out of the model.
First we will show the predictions that incorporate all fixed effects
and random effects:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_map</span><span class="op">(</span><span class="va">predictions</span><span class="op">$</span><span class="va">data</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"sqrt"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Prediction (fixed effects + all random effects)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="index-standardization_files/figure-html/plot-all-effects-1.png" width="768"></p>
<p>We can also look at just the fixed effects, here year:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_map</span><span class="op">(</span><span class="va">predictions</span><span class="op">$</span><span class="va">data</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">est_non_rf</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Prediction (fixed effects only)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"sqrt"</span><span class="op">)</span></span></code></pre></div>
<p><img src="index-standardization_files/figure-html/plot-fix-defects-1.png" width="768"></p>
<p>We can look at the spatial random effects that represent consistent
deviations in space through time that are not accounted for by our fixed
effects. In other words, these deviations represent consistent biotic
and abiotic factors that are affecting biomass density but are not
accounted for in the model.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_map</span><span class="op">(</span><span class="va">predictions</span><span class="op">$</span><span class="va">data</span>, <span class="va">omega_s</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Spatial random effects only"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient2</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="index-standardization_files/figure-html/plot-spatial-effects-1.png" width="768"></p>
<p>And finally we can look at the spatiotemporal random effects that
represent deviation from the fixed effect predictions and the spatial
random effect deviations. These represent biotic and abiotic factors
that are changing through time and are not accounted for in the
model.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_map</span><span class="op">(</span><span class="va">predictions</span><span class="op">$</span><span class="va">data</span>, <span class="va">epsilon_st</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Spatiotemporal random effects only"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient2</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="index-standardization_files/figure-html/plot-spatiotemporal-effects-1.png" width="768"></p>
<p>When we ran our <code>predict.sdmTBM()</code> function, it also
returned a report from TMB in the output because we included
<code>return_tmb_object = TRUE</code>. We can then run our
<code><a href="../reference/get_index.html">get_index()</a></code> function to extract the total biomass
calculations and standard errors.</p>
<p>We will need to set the <code>area</code> argument to 4
km<sup>2</sup> since our grid cells are 2 km x 2 km. If some grid cells
were not fully in the survey domain (or were on land), we could feed a
vector of grid areas to the <code>area</code> argument that matched the
number of grid cells.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_index.html">get_index</a></span><span class="op">(</span><span class="va">predictions</span>, area <span class="op">=</span> <span class="fl">4</span>, bias_correct <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">index</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">est</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lwr</span>, ymax <span class="op">=</span> <span class="va">upr</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">'Year'</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">'Biomass estimate (kg)'</span><span class="op">)</span></span></code></pre></div>
<p><img src="index-standardization_files/figure-html/plot-index-1.png" width="672"></p>
<p>These are our biomass estimates:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">index</span>, cv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">se</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">log_est</span>, <span class="op">-</span><span class="va">se</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>format <span class="op">=</span> <span class="st">"pandoc"</span>, digits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">year</th>
<th align="right">est</th>
<th align="right">lwr</th>
<th align="right">upr</th>
<th align="left">type</th>
<th align="right">cv</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">2003</td>
<td align="right">936176</td>
<td align="right">653699</td>
<td align="right">1340716</td>
<td align="left">index</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">2004</td>
<td align="right">1832130</td>
<td align="right">1359020</td>
<td align="right">2469943</td>
<td align="left">index</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">2005</td>
<td align="right">1757227</td>
<td align="right">1224189</td>
<td align="right">2522360</td>
<td align="left">index</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">2007</td>
<td align="right">452112</td>
<td align="right">328786</td>
<td align="right">621698</td>
<td align="left">index</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">2009</td>
<td align="right">722982</td>
<td align="right">518713</td>
<td align="right">1007692</td>
<td align="left">index</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">2011</td>
<td align="right">1357885</td>
<td align="right">1028851</td>
<td align="right">1792147</td>
<td align="left">index</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">2013</td>
<td align="right">1422648</td>
<td align="right">1037721</td>
<td align="right">1950358</td>
<td align="left">index</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">2015</td>
<td align="right">1487473</td>
<td align="right">1116301</td>
<td align="right">1982062</td>
<td align="left">index</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">2017</td>
<td align="right">750051</td>
<td align="right">543622</td>
<td align="right">1034867</td>
<td align="left">index</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p>We can also calculate an index for part of the survey domain. We’ll
make an index for everything south of UTM 5700 by subsetting our
prediction grid. For more complicated spatial polygons you could
intersect the polygon on the prediction grid using something like
<code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html" class="external-link">sf::st_intersects()</a></code>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">qcs_grid_south</span> <span class="op">&lt;-</span> <span class="va">grid_yrs</span><span class="op">[</span><span class="va">grid_yrs</span><span class="op">$</span><span class="va">Y</span> <span class="op">&lt;</span> <span class="fl">5700</span>, <span class="op">]</span></span>
<span><span class="va">predictions_south</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span>, newdata <span class="op">=</span> <span class="va">qcs_grid_south</span>, </span>
<span>  return_tmb_object <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">index_south</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_index.html">get_index</a></span><span class="op">(</span><span class="va">predictions_south</span>, area <span class="op">=</span> <span class="fl">4</span>, bias_correct <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">index_south</span><span class="op">)</span></span>
<span><span class="co">#&gt;   year      est      lwr      upr  log_est        se  type</span></span>
<span><span class="co">#&gt; 1 2003 264679.9 156368.9 448013.9 12.48628 0.2685270 index</span></span>
<span><span class="co">#&gt; 2 2004 602466.8 403037.0 900577.8 13.30879 0.2051079 index</span></span>
<span><span class="co">#&gt; 3 2005 411739.0 263138.9 644256.8 12.92814 0.2284265 index</span></span>
<span><span class="co">#&gt; 4 2007 184945.7 117598.4 290861.9 12.12782 0.2310178 index</span></span>
<span><span class="co">#&gt; 5 2009 316483.8 203600.9 491952.5 12.66503 0.2250603 index</span></span>
<span><span class="co">#&gt; 6 2011 432243.6 292909.8 637857.0 12.97674 0.1985366 index</span></span></code></pre></div>
<p>We can visually compare the two indexes:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">index</span>, region <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">index_south</span>, region <span class="op">=</span> <span class="st">"south"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">est</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="va">region</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lwr</span>, ymax <span class="op">=</span> <span class="va">upr</span>, fill <span class="op">=</span> <span class="va">region</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span></code></pre></div>
<p><img src="index-standardization_files/figure-html/south-index-plot-1.png" width="672"></p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sean C. Anderson, Eric J. Ward, Philina A. English, Lewis A. K. Barnett, James T. Thorson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
