<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Fitting multispecies models with sdmTMB • sdmTMB</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fitting multispecies models with sdmTMB">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sdmTMB</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.0.9030</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/basic-intro.html">Introduction to modelling with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/bayesian.html">Bayesian estimation with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/cross-validation.html">Cross-validation for model evaluation and comparison</a></li>
    <li><a class="dropdown-item" href="../articles/delta-models.html">Fitting delta (hurdle) models with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/ggeffects.html">Visualizing marginal effects in sdmTMB models with ggeffects</a></li>
    <li><a class="dropdown-item" href="../articles/index-standardization.html">Index standardization with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/model-description.html">sdmTMB model description</a></li>
    <li><a class="dropdown-item" href="../articles/multispecies.html">Fitting multispecies models with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/poisson-link.html">Poisson-link delta models</a></li>
    <li><a class="dropdown-item" href="../articles/pretty-plots.html">Making pretty maps with sdmTMB output</a></li>
    <li><a class="dropdown-item" href="../articles/residual-checking.html">Residual checking with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/spatial-trend-models.html">Fitting spatial trend models with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/threshold-models.html">Threshold modeling with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/visreg.html">Visualizing sdmTMB conditional effects using visreg</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pbs-assess/sdmTMB/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Fitting multispecies models with sdmTMB</h1>
            
            <h4 data-toc-skip class="date">2025-03-04</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/pbs-assess/sdmTMB/blob/main/vignettes/articles/multispecies.Rmd" class="external-link"><code>vignettes/articles/multispecies.Rmd</code></a></small>
      <div class="d-none name"><code>multispecies.Rmd</code></div>
    </div>

    
    
<p><strong>If the code in this vignette has not been evaluated, a
rendered version is available on the <a href="https://pbs-assess.github.io/sdmTMB/index.html">documentation
site</a> under ‘Articles’.</strong></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pbs-assess.github.io/sdmTMB/">sdmTMB</a></span><span class="op">)</span></span></code></pre></div>
<p>For some applications, we might be interested in fitting a model that
includes multiple responses such as 2+ species, or multiple size or age
classes within a species. This is a form of multivariate model. The most
important step in fitting these models is understanding which parameters
are shared, and which parameters are species-specific.</p>
<p>Below, we illustrate a series of models. We’ll start by simulating a
2-species dataset. Each species is allowed to have unique spatial
standard deviations (<code>sigma_O</code>) as well as different year
effects.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">predictor_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>, Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>,</span>
<span>  year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, each <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">predictor_dat</span><span class="op">$</span><span class="va">fyear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">predictor_dat</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span>
<span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">predictor_dat</span>, xy_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">sim_dat_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB_simulate.html">sdmTMB_simulate</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">fyear</span>,</span>
<span>  data <span class="op">=</span> <span class="va">predictor_dat</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  range <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">42</span>,</span>
<span>  sigma_O <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  phi <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  sigma_E <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">5</span>, min <span class="op">=</span> <span class="fl">5</span>, max <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="co"># 5 random year effects</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sim_dat_A</span><span class="op">$</span><span class="va">species</span> <span class="op">&lt;-</span> <span class="st">"A"</span></span>
<span><span class="va">sim_dat_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB_simulate.html">sdmTMB_simulate</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">fyear</span>,</span>
<span>  data <span class="op">=</span> <span class="va">predictor_dat</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  range <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">43</span>,</span>
<span>  sigma_O <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  phi <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  sigma_E <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">5</span>, min <span class="op">=</span> <span class="fl">5</span>, max <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="co"># 5 random year effects</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sim_dat_B</span><span class="op">$</span><span class="va">species</span> <span class="op">&lt;-</span> <span class="st">"B"</span></span>
<span><span class="va">sim_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">sim_dat_A</span>, <span class="va">sim_dat_B</span><span class="op">)</span></span>
<span><span class="va">sim_dat</span><span class="op">$</span><span class="va">fyear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sim_dat</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span></code></pre></div>
<p>We’ll start by making an SPDE mesh across the full dataset.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">sim_dat</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mesh</span><span class="op">)</span></span></code></pre></div>
<p><img src="multispecies_files/figure-html/mesh_fig-1.png" width="672"></p>
<div class="section level3">
<h3 id="model-1-species-specific-intercepts">Model 1: species-specific intercepts<a class="anchor" aria-label="anchor" href="#model-1-species-specific-intercepts"></a>
</h3>
<p>As a first model, we can include species-specific year effects. This
can be done in a couple ways. One option would be to estimate the
<code>species * year</code> interaction, letting the year effects for
each species be independent. Here, all other parameters and random
effect values (range, spatial field, spatial variance, spatiotemporal
fields, spatiotemporal variances) are shared.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">observed</span> <span class="op">~</span> <span class="va">fyear</span> <span class="op">*</span> <span class="va">species</span>,</span>
<span>  data <span class="op">=</span> <span class="va">sim_dat</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"iid"</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fit</span></span>
<span><span class="co">#&gt; Spatiotemporal model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: observed ~ fyear * species</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Time column: year</span></span>
<span><span class="co">#&gt; Data: sim_dat</span></span>
<span><span class="co">#&gt; Family: gaussian(link = 'identity')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;                 coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)         7.59    0.05</span></span>
<span><span class="co">#&gt; fyear2              0.36    0.05</span></span>
<span><span class="co">#&gt; fyear3              0.02    0.05</span></span>
<span><span class="co">#&gt; fyear4             -1.19    0.05</span></span>
<span><span class="co">#&gt; fyear5             -1.93    0.05</span></span>
<span><span class="co">#&gt; speciesB           -1.49    0.03</span></span>
<span><span class="co">#&gt; fyear2:speciesB     0.02    0.04</span></span>
<span><span class="co">#&gt; fyear3:speciesB    -0.71    0.04</span></span>
<span><span class="co">#&gt; fyear4:speciesB     0.70    0.04</span></span>
<span><span class="co">#&gt; fyear5:speciesB     3.45    0.04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 0.27</span></span>
<span><span class="co">#&gt; Matérn range: 0.19</span></span>
<span><span class="co">#&gt; Spatial SD: 0.17</span></span>
<span><span class="co">#&gt; Spatiotemporal IID SD: 0.14</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 329.263</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-2-species-specific-spatial-fields">Model 2: species-specific spatial fields<a class="anchor" aria-label="anchor" href="#model-2-species-specific-spatial-fields"></a>
</h3>
<p>We may be interested in fitting a model that lets the spatial
patterning differ by species. These kinds of models can be expressed
using spatially varying coefficients. Note that we use
<code>spatial = off</code> because this represents a global spatial
intercept—turning this off is akin to using a <code>-1</code> of
<code>0</code> in a main formula including a factor. Both species take
their spatial fields from the <code>spatial_varying</code> field
here.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">observed</span> <span class="op">~</span> <span class="va">fyear</span> <span class="op">*</span> <span class="va">species</span>,</span>
<span>  data <span class="op">=</span> <span class="va">sim_dat</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"iid"</span>,</span>
<span>  spatial_varying <span class="op">=</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fit</span></span>
<span><span class="co">#&gt; Spatiotemporal model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: observed ~ fyear * species</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Time column: year</span></span>
<span><span class="co">#&gt; Data: sim_dat</span></span>
<span><span class="co">#&gt; Family: gaussian(link = 'identity')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;                 coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)         7.60    0.06</span></span>
<span><span class="co">#&gt; fyear2              0.36    0.05</span></span>
<span><span class="co">#&gt; fyear3              0.04    0.05</span></span>
<span><span class="co">#&gt; fyear4             -1.22    0.05</span></span>
<span><span class="co">#&gt; fyear5             -1.94    0.05</span></span>
<span><span class="co">#&gt; speciesB           -1.51    0.08</span></span>
<span><span class="co">#&gt; fyear2:speciesB     0.02    0.03</span></span>
<span><span class="co">#&gt; fyear3:speciesB    -0.75    0.03</span></span>
<span><span class="co">#&gt; fyear4:speciesB     0.76    0.03</span></span>
<span><span class="co">#&gt; fyear5:speciesB     3.48    0.03</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 0.19</span></span>
<span><span class="co">#&gt; Matérn range: 0.18</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (factor(species)A): 0.25</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (factor(species)B): 0.30</span></span>
<span><span class="co">#&gt; Spatiotemporal IID SD: 0.16</span></span>
<span><span class="co">#&gt; ML criterion at convergence: -170.949</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
<p>You’ll notice that there are two rows of entries for
<code>sigma_Z</code> our spatially varying random field standard
deviation:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fit</span>, <span class="st">"ran_pars"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 5</span></span></span>
<span><span class="co">#&gt;   term    estimate std.error conf.low conf.high</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> range      0.181   0.025<span style="text-decoration: underline;">0</span>     0.139     0.238</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> phi        0.189   0.003<span style="text-decoration: underline;">30</span>    0.183     0.195</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> sigma_E    0.162   0.012<span style="text-decoration: underline;">9</span>     0.139     0.190</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> sigma_Z    0.250   0.026<span style="text-decoration: underline;">8</span>     0.203     0.308</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> sigma_Z    0.302   0.030<span style="text-decoration: underline;">3</span>     0.248     0.367</span></span></code></pre></div>
<p>This means that our model is trying to estimate separate
species-specific variance terms for the species-specific spatial fields
(say <em>that</em> 10 times fast!). Here, that matches how we simulated
the data. In other contexts, especially if we ran into estimation
issues, we might want to share those SDs.</p>
<p>If we wanted to estimate species-specific spatial fields with a
single shared variance (meaning the net magnitude of the peaks and
valleys in the fields were similar but the wiggles themselves were
species specific), we could do that by specifying a custom map argument
and passing it into <code><a href="../reference/sdmTMBcontrol.html">sdmTMBcontrol()</a></code>. Any shared factor
levels in the <code>map</code> are gathered to have ‘mirrored’ or shared
parameter values. We assign these to <code>ln_tau_Z</code> because,
internally, this is the parameter that gets converted into the
spatially-varying field variances (the SDs of those fields are
<code>sigma_Z</code>).</p>
<p>This case is pretty simple, but for more complicated cases we could
figure out the structure of our needed <code>map</code> vector as
follows:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">sim_dat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "factor(species)A" "factor(species)B"</span></span></code></pre></div>
<p>So, we need a vector of length two with shared factor values:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">map_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ln_tau_Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Then, we can use our map list to share the spatially varying
coefficient SDs:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">observed</span> <span class="op">~</span> <span class="va">fyear</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">sim_dat</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"iid"</span>,</span>
<span>  spatial_varying <span class="op">=</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="../reference/sdmTMBcontrol.html">sdmTMBcontrol</a></span><span class="op">(</span>map <span class="op">=</span> <span class="va">map_list</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fit</span></span>
<span><span class="co">#&gt; Spatiotemporal model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: observed ~ fyear * factor(species)</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Time column: year</span></span>
<span><span class="co">#&gt; Data: sim_dat</span></span>
<span><span class="co">#&gt; Family: gaussian(link = 'identity')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;                         coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)                 7.60    0.06</span></span>
<span><span class="co">#&gt; fyear2                      0.35    0.05</span></span>
<span><span class="co">#&gt; fyear3                      0.04    0.05</span></span>
<span><span class="co">#&gt; fyear4                     -1.23    0.05</span></span>
<span><span class="co">#&gt; fyear5                     -1.94    0.05</span></span>
<span><span class="co">#&gt; factor(species)B           -1.51    0.08</span></span>
<span><span class="co">#&gt; fyear2:factor(species)B     0.02    0.03</span></span>
<span><span class="co">#&gt; fyear3:factor(species)B    -0.75    0.03</span></span>
<span><span class="co">#&gt; fyear4:factor(species)B     0.76    0.03</span></span>
<span><span class="co">#&gt; fyear5:factor(species)B     3.48    0.03</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 0.19</span></span>
<span><span class="co">#&gt; Matérn range: 0.18</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (factor(species)A): 0.28</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (factor(species)B): 0.28</span></span>
<span><span class="co">#&gt; Spatiotemporal IID SD: 0.16</span></span>
<span><span class="co">#&gt; ML criterion at convergence: -170.110</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
<p>Notice the spatially varying coefficient SD is now shared.</p>
</div>
<div class="section level3">
<h3 id="model-3-species-specific-spatiotemporal-fields">Model 3: species-specific spatiotemporal fields<a class="anchor" aria-label="anchor" href="#model-3-species-specific-spatiotemporal-fields"></a>
</h3>
<p>In all of the examples above, spatiotemporal fields are included, but
shared among species. As another example, we can extend the above
approaches to set up a model that includes spatiotemporal fields unique
to each species.</p>
<p>One approach to including separate spatiotemporal fields by species
is creating a new variable that is a concatenation of species and year
(or any given time step factor). For example, we can then implement this
form of species-specific spatiotemporal variation by changing the
<code>time</code> argument to be <code>time = "species_year"</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_dat</span><span class="op">$</span><span class="va">species_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">sim_dat</span><span class="op">$</span><span class="va">species</span>, <span class="va">sim_dat</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">map_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ln_tau_Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">observed</span> <span class="op">~</span> <span class="va">fyear</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">sim_dat</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"on"</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"species_year"</span>,</span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"iid"</span>,</span>
<span>  spatial_varying <span class="op">=</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="../reference/sdmTMBcontrol.html">sdmTMBcontrol</a></span><span class="op">(</span>map <span class="op">=</span> <span class="va">map_list</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fit</span></span>
<span><span class="co">#&gt; Spatiotemporal model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: observed ~ fyear * factor(species)</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Time column: species_year</span></span>
<span><span class="co">#&gt; Data: sim_dat</span></span>
<span><span class="co">#&gt; Family: gaussian(link = 'identity')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;                         coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)                 7.56    0.07</span></span>
<span><span class="co">#&gt; fyear2                      0.38    0.08</span></span>
<span><span class="co">#&gt; fyear3                      0.06    0.08</span></span>
<span><span class="co">#&gt; fyear4                     -1.19    0.08</span></span>
<span><span class="co">#&gt; fyear5                     -1.92    0.08</span></span>
<span><span class="co">#&gt; factor(species)B           -1.43    0.10</span></span>
<span><span class="co">#&gt; fyear2:factor(species)B    -0.03    0.11</span></span>
<span><span class="co">#&gt; fyear3:factor(species)B    -0.79    0.11</span></span>
<span><span class="co">#&gt; fyear4:factor(species)B     0.67    0.11</span></span>
<span><span class="co">#&gt; fyear5:factor(species)B     3.41    0.11</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 0.10</span></span>
<span><span class="co">#&gt; Matérn range: 0.16</span></span>
<span><span class="co">#&gt; Spatial SD: 0.06</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (factor(species)A): 0.24</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (factor(species)B): 0.24</span></span>
<span><span class="co">#&gt; Spatiotemporal IID SD: 0.31</span></span>
<span><span class="co">#&gt; ML criterion at convergence: -917.577</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-4-species-specific-spatiotemporal-fields-using-the-spatial_varying-argument">Model 4: species-specific spatiotemporal fields using the
<code>spatial_varying</code> argument<a class="anchor" aria-label="anchor" href="#model-4-species-specific-spatiotemporal-fields-using-the-spatial_varying-argument"></a>
</h3>
<p>We can fit the same model by using the <code>spatial_varying</code>
argument. This would give us the added flexibility of letting each
species’ spatiotemporal field have its own variance if we wanted or if
expanding our model to have another category of independent random
fields. E.g., we might also have age or length bins.</p>
<p>First, we’ll have the spatial fields share their variance and the
spatiotemporal fields share their variance:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># quick hack to force all levels of species and species:factor interactions in formula:</span></span>
<span><span class="va">mm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>, <span class="va">sim_dat</span><span class="op">)</span></span>
<span><span class="va">mm2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>, <span class="va">sim_dat</span><span class="op">)</span></span>
<span><span class="va">mm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">mm1</span>, <span class="va">mm2</span><span class="op">)</span></span>
<span><span class="va">sim_dat2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">sim_dat</span>, <span class="va">mm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make our map vector:</span></span>
<span><span class="va">n_sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">mm1</span><span class="op">)</span></span>
<span><span class="va">n_st</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">mm2</span><span class="op">)</span></span>
<span><span class="va">map_list2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ln_tau_Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_sp</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">n_st</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">map_list2</span></span>
<span><span class="co">#&gt; $ln_tau_Z</span></span>
<span><span class="co">#&gt;  [1] 1 1 2 2 2 2 2 2 2 2 2 2</span></span>
<span><span class="co">#&gt; Levels: 1 2</span></span>
<span></span>
<span><span class="co"># hack together a model formula based on our hand constructed model matrix:</span></span>
<span><span class="va">svc_formula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"~ `"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">"` + `"</span><span class="op">)</span>, <span class="st">"`"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">svc_formula</span></span>
<span><span class="co">#&gt; ~`factor(species)A` + `factor(species)B` + `factor(year)1:factor(species)A` + </span></span>
<span><span class="co">#&gt;     `factor(year)2:factor(species)A` + `factor(year)3:factor(species)A` + </span></span>
<span><span class="co">#&gt;     `factor(year)4:factor(species)A` + `factor(year)5:factor(species)A` + </span></span>
<span><span class="co">#&gt;     `factor(year)1:factor(species)B` + `factor(year)2:factor(species)B` + </span></span>
<span><span class="co">#&gt;     `factor(year)3:factor(species)B` + `factor(year)4:factor(species)B` + </span></span>
<span><span class="co">#&gt;     `factor(year)5:factor(species)B`</span></span>
<span></span>
<span><span class="va">fit_svc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">observed</span> <span class="op">~</span> <span class="va">fyear</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">sim_dat2</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"off"</span>,</span>
<span>  spatial_varying <span class="op">=</span> <span class="va">svc_formula</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="../reference/sdmTMBcontrol.html">sdmTMBcontrol</a></span><span class="op">(</span>map <span class="op">=</span> <span class="va">map_list2</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We now have exactly the same model, just specified differently:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'log Lik.' 917.5774 (df=15)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik</a></span><span class="op">(</span><span class="va">fit_svc</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'log Lik.' 917.5177 (df=14)</span></span></code></pre></div>
<p>Say we wanted to let the spatial and spatiotemporal variances be
different for each species. We could do that by changing the map
vector:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "factor(species)A"               "factor(species)B"              </span></span>
<span><span class="co">#&gt;  [3] "factor(year)1:factor(species)A" "factor(year)2:factor(species)A"</span></span>
<span><span class="co">#&gt;  [5] "factor(year)3:factor(species)A" "factor(year)4:factor(species)A"</span></span>
<span><span class="co">#&gt;  [7] "factor(year)5:factor(species)A" "factor(year)1:factor(species)B"</span></span>
<span><span class="co">#&gt;  [9] "factor(year)2:factor(species)B" "factor(year)3:factor(species)B"</span></span>
<span><span class="co">#&gt; [11] "factor(year)4:factor(species)B" "factor(year)5:factor(species)B"</span></span>
<span><span class="va">map_list3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ln_tau_Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">3</span>, <span class="va">n_st</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">4</span>, <span class="va">n_st</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># check:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>map_value <span class="op">=</span> <span class="va">map_list3</span><span class="op">$</span><span class="va">ln_tau_Z</span>, svc_term <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    map_value                       svc_term</span></span>
<span><span class="co">#&gt; 1          1               factor(species)A</span></span>
<span><span class="co">#&gt; 2          2               factor(species)B</span></span>
<span><span class="co">#&gt; 3          3 factor(year)1:factor(species)A</span></span>
<span><span class="co">#&gt; 4          3 factor(year)2:factor(species)A</span></span>
<span><span class="co">#&gt; 5          3 factor(year)3:factor(species)A</span></span>
<span><span class="co">#&gt; 6          3 factor(year)4:factor(species)A</span></span>
<span><span class="co">#&gt; 7          3 factor(year)5:factor(species)A</span></span>
<span><span class="co">#&gt; 8          4 factor(year)1:factor(species)B</span></span>
<span><span class="co">#&gt; 9          4 factor(year)2:factor(species)B</span></span>
<span><span class="co">#&gt; 10         4 factor(year)3:factor(species)B</span></span>
<span><span class="co">#&gt; 11         4 factor(year)4:factor(species)B</span></span>
<span><span class="co">#&gt; 12         4 factor(year)5:factor(species)B</span></span>
<span></span>
<span><span class="va">fit_svc_separate</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">observed</span> <span class="op">~</span> <span class="va">fyear</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">sim_dat2</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"off"</span>,</span>
<span>  spatial_varying <span class="op">=</span> <span class="va">svc_formula</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="../reference/sdmTMBcontrol.html">sdmTMBcontrol</a></span><span class="op">(</span>map <span class="op">=</span> <span class="va">map_list3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fit_svc_separate</span></span>
<span><span class="co">#&gt; Spatial model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: observed ~ fyear * factor(species)</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Time column: year</span></span>
<span><span class="co">#&gt; Data: sim_dat2</span></span>
<span><span class="co">#&gt; Family: gaussian(link = 'identity')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;                         coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)                 7.56    0.07</span></span>
<span><span class="co">#&gt; fyear2                      0.38    0.08</span></span>
<span><span class="co">#&gt; fyear3                      0.06    0.08</span></span>
<span><span class="co">#&gt; fyear4                     -1.19    0.08</span></span>
<span><span class="co">#&gt; fyear5                     -1.92    0.08</span></span>
<span><span class="co">#&gt; factor(species)B           -1.43    0.10</span></span>
<span><span class="co">#&gt; fyear2:factor(species)B    -0.03    0.11</span></span>
<span><span class="co">#&gt; fyear3:factor(species)B    -0.79    0.11</span></span>
<span><span class="co">#&gt; fyear4:factor(species)B     0.67    0.11</span></span>
<span><span class="co">#&gt; fyear5:factor(species)B     3.42    0.11</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 0.10</span></span>
<span><span class="co">#&gt; Matérn range: 0.16</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(species)A`): 0.21</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(species)B`): 0.28</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)1:factor(species)A`): 0.31</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2:factor(species)A`): 0.31</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)3:factor(species)A`): 0.31</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)4:factor(species)A`): 0.31</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)5:factor(species)A`): 0.31</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)1:factor(species)B`): 0.30</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2:factor(species)B`): 0.30</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)3:factor(species)B`): 0.30</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)4:factor(species)B`): 0.30</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)5:factor(species)B`): 0.30</span></span>
<span><span class="co">#&gt; ML criterion at convergence: -918.900</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
<p>Now we have separate SDs for the spatial and spatiotemporal fields
across species.</p>
<p>But in this case, marginal AIC does not indicate an improvement from
this added flexibility:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">fit_svc</span>, <span class="va">fit_svc_separate</span><span class="op">)</span></span>
<span><span class="co">#&gt;                  df       AIC</span></span>
<span><span class="co">#&gt; fit_svc          14 -1807.035</span></span>
<span><span class="co">#&gt; fit_svc_separate 16 -1805.801</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-5-hack-species-into-the-time-element-for-spatial-models">Model 5: hack species into the time element for spatial models<a class="anchor" aria-label="anchor" href="#model-5-hack-species-into-the-time-element-for-spatial-models"></a>
</h3>
<p>If we only wanted to fit a spatial model but had several species (or
other groups), one approach is to pretend our species (or other group)
is the time element.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_dat</span><span class="op">$</span><span class="va">numeric_species</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sim_dat</span><span class="op">$</span><span class="va">species</span><span class="op">)</span><span class="op">)</span> <span class="co"># needs to be numeric</span></span>
<span><span class="va">fit_fake_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">observed</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">sim_dat</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"numeric_species"</span>, <span class="co">#&lt; hack</span></span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"iid"</span> <span class="co">#&lt; 'AR1' or 'RW' probably wouldn't make sense here</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fit_fake_time</span></span>
<span><span class="co">#&gt; Spatiotemporal model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: observed ~ 0 + factor(species)</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Time column: numeric_species</span></span>
<span><span class="co">#&gt; Data: sim_dat</span></span>
<span><span class="co">#&gt; Family: gaussian(link = 'identity')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;                  coef.est coef.se</span></span>
<span><span class="co">#&gt; factor(species)A     7.01    0.08</span></span>
<span><span class="co">#&gt; factor(species)B     6.27    0.08</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 0.86</span></span>
<span><span class="co">#&gt; Matérn range: 0.33</span></span>
<span><span class="co">#&gt; Spatiotemporal IID SD: 0.21</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 2568.873</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
<p>This is just a convenience though. We could instead do the same thing
using the <code>spatial_varying</code> argument making sure to ‘map’ the
field variances to be shared to match the above:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_svc3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">observed</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">sim_dat</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>,</span>
<span>  spatial_varying <span class="op">=</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="../reference/sdmTMBcontrol.html">sdmTMBcontrol</a></span><span class="op">(</span>map <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ln_tau_Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fit_svc3</span></span>
<span><span class="co">#&gt; Spatial model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: observed ~ 0 + factor(species)</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Data: sim_dat</span></span>
<span><span class="co">#&gt; Family: gaussian(link = 'identity')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;                  coef.est coef.se</span></span>
<span><span class="co">#&gt; factor(species)A     7.01    0.08</span></span>
<span><span class="co">#&gt; factor(species)B     6.27    0.08</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 0.86</span></span>
<span><span class="co">#&gt; Matérn range: 0.33</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (factor(species)A): 0.21</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (factor(species)B): 0.21</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 2568.873</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
<p>We can prove they’re identical:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik</a></span><span class="op">(</span><span class="va">fit_fake_time</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'log Lik.' -2568.873 (df=5)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik</a></span><span class="op">(</span><span class="va">fit_svc3</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'log Lik.' -2568.873 (df=5)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="putting-it-all-together">Putting it all together<a class="anchor" aria-label="anchor" href="#putting-it-all-together"></a>
</h3>
<p>These examples illustrate a number of ways that species-specific
effects can be included in <code>sdmTMB</code> models, and can be
extended to other categories/groups/cohorts within a species for which
one wants to control the amount of information shared between groups
(e.g., age-, size-, or stage-specific estimates). A brief summary of
these approaches can be summarized as:</p>
<table class="table">
<colgroup>
<col width="50%">
<col width="49%">
</colgroup>
<thead><tr class="header">
<th align="left">Form</th>
<th align="left">Implementation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Main effects</td>
<td align="left">Year-by-species interactions or smooths by year</td>
</tr>
<tr class="even">
<td align="left">Spatial effects</td>
<td align="left">Spatially varying coefficients</td>
</tr>
<tr class="odd">
<td align="left">Spatial effects, shared variance</td>
<td align="left">Spatially varying coefficients + map argument</td>
</tr>
<tr class="even">
<td align="left">Spatiotemporal effects, shared variance</td>
<td align="left">Species-year factor as time variable</td>
</tr>
<tr class="odd">
<td align="left">Spatiotemporal effects, group-specific variances</td>
<td align="left">Spatially varying coefficients + map argument</td>
</tr>
<tr class="even">
<td align="left">Any set of spatial and spatiotemporal effects</td>
<td align="left">Spatially varying coefficients + map argument</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="further-extensions">Further extensions<a class="anchor" aria-label="anchor" href="#further-extensions"></a>
</h3>
<p>As long as you’re willing to treat spatiotemporal and group-level
fields (e.g., for different species or age cohorts) as independent,
sdmTMB can be used to fit models to these data. For example, this allows
sdmTMB to be used for standardization of age or length composition data
as in <a href="https://doi.org/10.1139/cjfas-2018-0015" class="external-link">Thorson and
Haltuch (2018) CJFAS</a>. The approach is to similar to the above and we
plan to write a separate vignette on the topic.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sean C. Anderson, Eric J. Ward, Philina A. English, Lewis A. K. Barnett, James T. Thorson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
