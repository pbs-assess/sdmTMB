<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Visualizing sdmTMB conditional effects using visreg • sdmTMB</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Visualizing sdmTMB conditional effects using visreg">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sdmTMB</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.0.9014</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/basic-intro.html">Introduction to modelling with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/bayesian.html">Bayesian estimation with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/cross-validation.html">Cross-validation for model evaluation and comparison</a></li>
    <li><a class="dropdown-item" href="../articles/delta-models.html">Fitting delta (hurdle) models with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/ggeffects.html">Visualizing marginal effects in sdmTMB models with ggeffects</a></li>
    <li><a class="dropdown-item" href="../articles/index-standardization.html">Index standardization with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/model-description.html">sdmTMB model description</a></li>
    <li><a class="dropdown-item" href="../articles/poisson-link.html">Poisson-link delta models</a></li>
    <li><a class="dropdown-item" href="../articles/pretty-plots.html">Making pretty maps with sdmTMB output</a></li>
    <li><a class="dropdown-item" href="../articles/residual-checking.html">Residual checking with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/spatial-trend-models.html">Fitting spatial trend models with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/threshold-models.html">Threshold modeling with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/visreg.html">Visualizing sdmTMB conditional effects using visreg</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pbs-assess/sdmTMB/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Visualizing sdmTMB conditional effects using visreg</h1>
                        <h4 data-toc-skip class="author">Julia Indivero,
Sean Anderson, Lewis Barnett, Philina English, Eric Ward</h4>
            
            <h4 data-toc-skip class="date">2024-11-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/pbs-assess/sdmTMB/blob/main/vignettes/articles/visreg.Rmd" class="external-link"><code>vignettes/articles/visreg.Rmd</code></a></small>
      <div class="d-none name"><code>visreg.Rmd</code></div>
    </div>

    
    
<p><strong>If the code in this vignette has not been evaluated, a
rendered version is available on the <a href="https://pbs-assess.github.io/sdmTMB/index.html">documentation
site</a> under ‘Articles’.</strong></p>
<p>We can use the <a href="https://CRAN.R-project.org/package=visreg" class="external-link">visreg</a> package to
visually inspect the conditional effects of explanatory variables in
sdmTMB models.</p>
<p>We will use the built-in Pacific cod survey data for this example. We
will fit a model with scaled depth and a factor effect of year using a
Tweedie distribution.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pcod_2011</span><span class="op">$</span><span class="va">fyear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">pcod_2011</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span>
<span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">pcod_2011</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">depth_scaled</span><span class="op">)</span> <span class="op">+</span> <span class="va">fyear</span>,</span>
<span>  data <span class="op">=</span> <span class="va">pcod_2011</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>, <span class="co"># off for vignette building speed</span></span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can then plot the effect of depth in link space. This shows the
value of depth on the x-axis and the change in response on the y-axis,
holding all other variables constant.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="http://pbreheny.github.io/visreg/reference/visreg.html" class="external-link">visreg</a></span><span class="op">(</span><span class="va">fit</span>, xvar <span class="op">=</span> <span class="st">"depth_scaled"</span><span class="op">)</span></span></code></pre></div>
<p><img src="visreg_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
<p>Note that by default, randomized quantile residuals are included.
These should be normally distributed in link space if the model is
consistent with the data. These can be turned off with
<code>partial = FALSE</code></p>
<p>The default, a visreg plot uses base graphics. We can set
<code>gg = TRUE</code> to get a ggplot version:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pbreheny.github.io/visreg/reference/visreg.html" class="external-link">visreg</a></span><span class="op">(</span><span class="va">fit</span>, xvar <span class="op">=</span> <span class="st">"depth_scaled"</span>, gg <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">g</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Depth scaled"</span><span class="op">)</span></span></code></pre></div>
<p><img src="visreg_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>We can also grab the underlying data it creates and make our own
plot:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://pbreheny.github.io/visreg/reference/visreg.html" class="external-link">visreg</a></span><span class="op">(</span><span class="va">fit</span>, xvar <span class="op">=</span> <span class="st">"depth_scaled"</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt;   depth_scaled fyear density visregFit visregLwr visregUpr</span></span>
<span><span class="co">#&gt; 1    -2.933490  2011       0  2.629110  1.122039  4.136182</span></span>
<span><span class="co">#&gt; 2    -2.877239  2011       0  2.524430  1.158455  3.890404</span></span>
<span><span class="co">#&gt; 3    -2.820988  2011       0  2.420118  1.185481  3.654756</span></span>
<span><span class="co">#&gt; 4    -2.764737  2011       0  2.316778  1.200202  3.433355</span></span>
<span><span class="co">#&gt; 5    -2.708486  2011       0  2.215283  1.199395  3.231171</span></span>
<span><span class="co">#&gt; 6    -2.652235  2011       0  2.116733  1.180157  3.053310</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">fit</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">depth_scaled</span>, y <span class="op">=</span> <span class="va">visregFit</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">visregLwr</span>, ymax <span class="op">=</span> <span class="va">visregUpr</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># residuals are in d$res</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="co">#&gt;   depth_scaled fyear density visregRes visregPos</span></span>
<span><span class="co">#&gt; 1    0.7408840  2011       0  5.633490      TRUE</span></span>
<span><span class="co">#&gt; 2   -2.7062455  2011       0  2.135630     FALSE</span></span>
<span><span class="co">#&gt; 3   -2.9334899  2011       0  2.532105     FALSE</span></span>
<span><span class="co">#&gt; 4   -0.2224156  2011       0  1.894249     FALSE</span></span>
<span><span class="co">#&gt; 5    1.8685071  2011       0 -4.864248      TRUE</span></span>
<span><span class="co">#&gt; 6    2.3175211  2011       0 -8.423270      TRUE</span></span>
<span></span>
<span><span class="va">g</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">visregRes</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="va">res</span>, size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span></code></pre></div>
<p><img src="visreg_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<p>We can look at the effect of depth in each year separately, either in
separate plots or overlaid on the same plot.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="http://pbreheny.github.io/visreg/reference/visreg.html" class="external-link">visreg</a></span><span class="op">(</span><span class="va">fit</span>, xvar <span class="op">=</span> <span class="st">"depth_scaled"</span>, by <span class="op">=</span> <span class="st">"fyear"</span>, gg <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="visreg_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="http://pbreheny.github.io/visreg/reference/visreg.html" class="external-link">visreg</a></span><span class="op">(</span><span class="va">fit</span>, xvar <span class="op">=</span> <span class="st">"depth_scaled"</span>, by <span class="op">=</span> <span class="st">"fyear"</span>, overlay <span class="op">=</span> <span class="cn">TRUE</span>, gg <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="visreg_files/figure-html/unnamed-chunk-6-2.png" width="672"></p>
<p>And at the effect of depth on the response scale, rather than link
(log) scale.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="http://pbreheny.github.io/visreg/reference/visreg.html" class="external-link">visreg</a></span><span class="op">(</span><span class="va">fit</span>, xvar <span class="op">=</span> <span class="st">"depth_scaled"</span>, scale <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span></code></pre></div>
<p><img src="visreg_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<p>In this case, visreg adds “rug” lines indicating the where the data
were observed along the x-axis variable.</p>
<p><code><a href="http://pbreheny.github.io/visreg/reference/visreg.html" class="external-link">visreg()</a></code> can also be used to visualize just the
categorical effect of year.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="http://pbreheny.github.io/visreg/reference/visreg.html" class="external-link">visreg</a></span><span class="op">(</span><span class="va">fit</span>, xvar <span class="op">=</span> <span class="st">"fyear"</span><span class="op">)</span></span></code></pre></div>
<p><img src="visreg_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<p>We can also simultaneously compare both depth and year with a
two-dimensional contour plot.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="http://pbreheny.github.io/visreg/reference/visreg2d.html" class="external-link">visreg2d</a></span><span class="op">(</span><span class="va">fit</span>, xvar <span class="op">=</span> <span class="st">"fyear"</span>, yvar <span class="op">=</span> <span class="st">"depth_scaled"</span><span class="op">)</span></span></code></pre></div>
<p><img src="visreg_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<p><code><a href="http://pbreheny.github.io/visreg/reference/visreg2d.html" class="external-link">visreg2d()</a></code> is different from <code><a href="http://pbreheny.github.io/visreg/reference/visreg.html" class="external-link">visreg()</a></code> in
that it doesn’t take a <code>gg</code> argument. Instead, it takes
<code>plot.type = c("image", "persp", "rgl", "gg")</code>. For
example:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="http://pbreheny.github.io/visreg/reference/visreg2d.html" class="external-link">visreg2d</a></span><span class="op">(</span><span class="va">fit</span>, xvar <span class="op">=</span> <span class="st">"fyear"</span>, yvar <span class="op">=</span> <span class="st">"depth_scaled"</span>, plot.type <span class="op">=</span> <span class="st">"gg"</span><span class="op">)</span></span></code></pre></div>
<p><img src="visreg_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="http://pbreheny.github.io/visreg/reference/visreg2d.html" class="external-link">visreg2d</a></span><span class="op">(</span><span class="va">fit</span>, xvar <span class="op">=</span> <span class="st">"fyear"</span>, yvar <span class="op">=</span> <span class="st">"depth_scaled"</span>, plot.type <span class="op">=</span> <span class="st">"persp"</span><span class="op">)</span></span></code></pre></div>
<p><img src="visreg_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<div class="section level2">
<h2 id="delta-models">Delta models<a class="anchor" aria-label="anchor" href="#delta-models"></a>
</h2>
<p><code><a href="http://pbreheny.github.io/visreg/reference/visreg.html" class="external-link">visreg()</a></code> can also be used to plot the output of delta
models from <code><a href="../reference/sdmTMB.html">sdmTMB()</a></code> by using similar code for the previous
plots, but using the sdmTMB wrapper function <code><a href="../reference/visreg_delta.html">visreg_delta()</a></code>
and specifying <code>model = 1</code> for the encounter (0 vs. non-zero)
model or <code>model = 2</code> for the positive component model (e.g.,
Gamma, lognormal). For example:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_dg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">depth_scaled</span>, <span class="va">year</span>, k <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">pcod_2011</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">pcod_mesh_2011</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>, <span class="co"># for vignette speed</span></span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/families.html">delta_gamma</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/visreg_delta.html">visreg_delta</a></span><span class="op">(</span><span class="va">fit_dg</span>, xvar <span class="op">=</span> <span class="st">"depth_scaled"</span>, model <span class="op">=</span> <span class="fl">1</span>, gg <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; These are residuals for delta model component 1. Use the `model` argument to</span></span>
<span><span class="co">#&gt; select the other component.</span></span></code></pre></div>
<p><img src="visreg_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/visreg_delta.html">visreg_delta</a></span><span class="op">(</span><span class="va">fit_dg</span>, xvar <span class="op">=</span> <span class="st">"depth_scaled"</span>, model <span class="op">=</span> <span class="fl">2</span>, gg <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; These are residuals for delta model component 2. Use the `model` argument to</span></span>
<span><span class="co">#&gt; select the other component.</span></span></code></pre></div>
<p><img src="visreg_files/figure-html/unnamed-chunk-12-2.png" width="672"></p>
<p>Note that for plotting with <code><a href="../reference/visreg_delta.html">visreg_delta()</a></code>, categorical
variables like year need to be designated as a factor in the data frame,
as in the example above with <code>fyear</code>, rather than in the
model formula (e.g., <code>+ as.factor(year)</code>).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sean C. Anderson, Eric J. Ward, Philina A. English, Lewis A. K. Barnett, James T. Thorson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
