<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Fitting delta (hurdle) models with sdmTMB • sdmTMB</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fitting delta (hurdle) models with sdmTMB">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sdmTMB</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.4.9003</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/age-composition.html">Area-weighted age composition standardization with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/basic-intro.html">Introduction to modelling with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/bayesian.html">Bayesian estimation with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/cross-validation.html">Cross-validation for model evaluation and comparison</a></li>
    <li><a class="dropdown-item" href="../articles/delta-models.html">Fitting delta (hurdle) models with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/forecasting.html">Forecasting with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/ggeffects.html">Visualizing marginal effects in sdmTMB models with ggeffects</a></li>
    <li><a class="dropdown-item" href="../articles/index-standardization.html">Index standardization with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/model-description.html">sdmTMB model description</a></li>
    <li><a class="dropdown-item" href="../articles/multispecies.html">Fitting multispecies models with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/poisson-link.html">Poisson-link delta models</a></li>
    <li><a class="dropdown-item" href="../articles/presence-only.html">Spatial Modeling of Presence-Only Data with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/pretty-plots.html">Making pretty maps with sdmTMB output</a></li>
    <li><a class="dropdown-item" href="../articles/residual-checking.html">Residual checking with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/spatial-trend-models.html">Fitting spatial trend models with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/threshold-models.html">Threshold modeling with sdmTMB</a></li>
    <li><a class="dropdown-item" href="../articles/visreg.html">Visualizing sdmTMB conditional effects using visreg</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pbs-assess/sdmTMB/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Fitting delta (hurdle) models with sdmTMB</h1>
                        <h4 data-toc-skip class="author">Julia Indivero,
Philina English, Sean Anderson, Eric Ward, Lewis Barnett, James
Thorson</h4>
            
            <h4 data-toc-skip class="date">2025-09-05</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/pbs-assess/sdmTMB/blob/main/vignettes/articles/delta-models.Rmd" class="external-link"><code>vignettes/articles/delta-models.Rmd</code></a></small>
      <div class="d-none name"><code>delta-models.Rmd</code></div>
    </div>

    
    
<p><strong>If the code in this vignette has not been evaluated, a
rendered version is available on the <a href="https://pbs-assess.github.io/sdmTMB/index.html">documentation
site</a> under ‘Articles’.</strong></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pbs-assess.github.io/sdmTMB/">sdmTMB</a></span><span class="op">)</span></span></code></pre></div>
<p>sdmTMB has the capability for built-in hurdle models (also called
delta models). These are models with one model for zero vs. non-zero
data and another component for the positive component. Hurdle models
could also be implemented by fitting the two components separately and
combining the predictions.</p>
<p>Hurdle models are more appropriate than something like a Tweedie when
there are differences in the processes controlling presence
vs. abundance, or when greater flexibility to account for dispersion is
required.</p>
<p>Built-in hurdle models can be specified with the <code>family</code>
argument within the <code><a href="../reference/sdmTMB.html">sdmTMB()</a></code> function. Current options
include:</p>
<ol style="list-style-type: decimal">
<li><p>Delta-Gamma:
<code>family = delta_gamma(link1 = "logit", link2 = "log")</code>. This
fits a binomial presence-absence model (i.e.,
<code>binomial(link = "logit")</code>) and then a model for the positive
catches only with a Gamma observation distribution and a log link (i.e.,
<code>Gamma(link = "log")</code>). Here and with other delta models, the
<code>link1</code> and <code>link2</code> can be omitted and left at
their default values.</p></li>
<li><p>Delta-lognormal: <code>family = delta_lognormal()</code>. This
fits a binomial presence-absence model (i.e.,
<code>binomial(link = "logit")</code>) and then a model for the positive
catches only with a lognormal observation distribution and a log link
(i.e., <code>lognormal(link = "log")</code></p></li>
<li><p>Poisson-link delta-Gamma or delta-lognormal. See the <a href="https://pbs-assess.github.io/sdmTMB/articles/poisson-link.html">Poisson-link
delta model vignette</a>.</p></li>
<li><p>Delta-truncated-negative-binomial:
<code>family = delta_truncated_nbinom1()</code> or
<code>family = delta_truncated_nbinom2()</code>. This fits a binomial
presence-absence model (<code>binomial(link = "logit")</code>) and a
<code>truncated_nbinom1(link = "log")</code> or
<code>truncated_nbinom1(link = "log")</code> distribution for positive
catches.</p></li>
</ol>
<p>To summarize the built-in delta models and the separate
components:</p>
<table class="table">
<colgroup>
<col width="14%">
<col width="28%">
<col width="26%">
<col width="31%">
</colgroup>
<thead><tr class="header">
<th>Model Type</th>
<th>Built-in delta function</th>
<th>Presence-absence model</th>
<th>Positive catch model</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Delta-gamma</td>
<td><code><a href="../reference/families.html">delta_gamma()</a></code></td>
<td><code>binomial(link = "logit")</code></td>
<td><code>Gamma(link = "log")</code></td>
</tr>
<tr class="even">
<td>Delta-lognormal</td>
<td><code><a href="../reference/families.html">delta_lognormal()</a></code></td>
<td><code>binomial(link = "logit")</code></td>
<td><code>lognormal(link = "log")</code></td>
</tr>
<tr class="odd">
<td>Delta-NB1</td>
<td><code><a href="../reference/families.html">delta_truncated_nbinom1()</a></code></td>
<td><code>binomial(link = "logit")</code></td>
<td><code>truncated_nbinom1(link = "log")</code></td>
</tr>
<tr class="even">
<td>Delta-NB2</td>
<td><code><a href="../reference/families.html">delta_truncated_nbinom2()</a></code></td>
<td><code>binomial(link = "logit")</code></td>
<td><code>truncated_nbinom2(link = "log")</code></td>
</tr>
</tbody>
</table>
<div class="section level2">
<h2 id="example-with-built-in-delta-model">Example with built-in delta model<a class="anchor" aria-label="anchor" href="#example-with-built-in-delta-model"></a>
</h2>
<p>Here, we will show an example of fitting using the built-in delta
functionality, as well as how to build each model component separately
and then combine. The built-in approach is convenient, allows for
parameters to be shared across components, and allows for calculation of
derived quantities such as standardized indexes
(<code><a href="../reference/get_index.html">get_index()</a></code>) with internally calculated standard
errors.</p>
<p>We will use a dataset built into the sdmTMB package: trawl survey
data for Pacific Cod in Queen Charlotte Sound, British Columbia, Canada.
The density units are kg/km<sup>2</sup>. Here, X and Y are coordinates
in UTM zone 9.</p>
<p>We will first create a mesh that we will use for all the models.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pcod_mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">pcod</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span></code></pre></div>
<p>Then we can fit a model of Pacific cod density using a delta-gamma
model, including a smoothed effect of depth.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_dg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span><span class="va">density</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">depth</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">pcod_mesh</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/families.html">delta_gamma</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The default in built-in delta models is for the formula, spatial and
spatiotemporal structure, and anisotropy to be shared between the two
model components. However, some elements (<code>formula</code>,
<code>spatial</code>, <code>spatiotemporal</code>, and
<code>share_range</code>) can also be specified independently for each
model using a list format within the function argument (see examples
below). The first element of the list is for the binomial component and
the second element is for the positive component (e.g., Gamma). Some
elements must be shared for now (e.g., smoothers, spatially varying
coefficients, and time-varying coefficients).</p>
<p>To specify the settings for spatial and spatiotemporal effects in
each model component, create a list of settings within the
<code>spatial</code> and <code>spatiotemporal</code> arguments. For
example,
<code>spatial = list("on", "off"), spatiotemporal = list("off", "rw")</code>.</p>
<p>We could similarly specify a different formula for each component of
the model, using <code>list(y ~ x1, y ~ x2)</code> For instance, we
could include the effect of depth for only the positive model, and
remove it for the presence-absence model.</p>
<p>However, there are currently limitations if specifying separate
formulas for each model component. The two formulas <em>cannot</em>
have:</p>
<ul>
<li>smoothers</li>
<li>threshold effects</li>
<li>random intercepts</li>
</ul>
<p>For now, these must be specified through a single formula that is
shared across the two models.</p>
<p>Each model component can similarly have separate settings for
<code>share_range</code>, which determines whether there is a shared
spatial and spatiotemporal range parameter (<code>TRUE</code>) or
independent range parameters (<code>FALSE</code>), by using a list.</p>
<p>Lastly, whether or not anisotropy is included in the model is
determined with the logical argument <code>anisotropy</code> (i.e.,
<code>TRUE</code> or <code>FALSE</code>), and cannot be separately
specified for each model. If anisotropy is included, it is by default
shared across the two model components. However it can be made unique in
each model component by using <code>sdmTMBcontrol(map = ...)</code> and
adding the argument <code>control</code> when fitting the model. This
‘maps’ the anisotropy parameters be unique across model components.</p>
<p>Once we fit the delta model, we can evaluate and plot the output,
diagnostics, and predictions similar to other sdmTMB models.</p>
<p>The printed model output will show estimates and standard errors of
parameters for each model separately.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit_dg</span><span class="op">)</span></span>
<span><span class="co">#&gt; Spatiotemporal model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: density ~ 1 + s(depth)</span></span>
<span><span class="co">#&gt; Mesh: pcod_mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Time column: year</span></span>
<span><span class="co">#&gt; Data: pcod</span></span>
<span><span class="co">#&gt; Family: delta_gamma(link1 = 'logit', link2 = 'log')</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Delta/hurdle model 1: -----------------------------------</span></span>
<span><span class="co">#&gt; Family: binomial(link = 'logit') </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;             coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)    -0.34    0.61</span></span>
<span><span class="co">#&gt; sdepth          1.28    2.91</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Smooth terms:</span></span>
<span><span class="co">#&gt;           Std. Dev.</span></span>
<span><span class="co">#&gt; sds(depth     14.38</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matérn range: 61.41</span></span>
<span><span class="co">#&gt; Spatial SD: 1.71</span></span>
<span><span class="co">#&gt; Spatiotemporal IID SD: 0.81</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Delta/hurdle model 2: -----------------------------------</span></span>
<span><span class="co">#&gt; Family: Gamma(link = 'log') </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;             coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)     3.67    0.12</span></span>
<span><span class="co">#&gt; sdepth          0.31    1.29</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Smooth terms:</span></span>
<span><span class="co">#&gt;           Std. Dev.</span></span>
<span><span class="co">#&gt; sds(depth      5.41</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 1.03</span></span>
<span><span class="co">#&gt; Matérn range: 14.80</span></span>
<span><span class="co">#&gt; Spatial SD: 0.69</span></span>
<span><span class="co">#&gt; Spatiotemporal IID SD: 1.45</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ML criterion at convergence: 6126.400</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
<p>Using the <code><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy()</a></code> function will turn the sdmTMB model
output into a data frame, with the argument <code>model=1</code> or
<code>model=2</code> to specify which model component to extract as a
dataframe. See <code><a href="../reference/tidy.sdmTMB.html">tidy.sdmTMB()</a></code> for additional arguments and
options.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fit_dg</span><span class="op">)</span> <span class="co"># model = 1 is default</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 5</span></span></span>
<span><span class="co">#&gt;   term        estimate std.error conf.low conf.high</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> (Intercept)   -<span style="color: #BB0000;">0.343</span>     0.614    -<span style="color: #BB0000;">1.55</span>     0.860</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> sdepth         1.28      2.91     -<span style="color: #BB0000;">4.42</span>     6.98</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fit_dg</span>, model <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 5</span></span></span>
<span><span class="co">#&gt;   term        estimate std.error conf.low conf.high</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> (Intercept)   -<span style="color: #BB0000;">0.343</span>     0.614    -<span style="color: #BB0000;">1.55</span>     0.860</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> sdepth         1.28      2.91     -<span style="color: #BB0000;">4.42</span>     6.98</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fit_dg</span>, model <span class="op">=</span> <span class="fl">1</span>, <span class="st">"ran_pars"</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 6</span></span></span>
<span><span class="co">#&gt;   model term         estimate std.error conf.low conf.high</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1 range          61.4      14.1     39.2       96.3 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     1 sigma_O         1.71      0.265    1.26       2.32</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     1 sigma_E         0.806     0.142    0.570      1.14</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     1 sd__s(depth)   14.4      <span style="color: #BB0000;">NA</span>        7.93      26.1</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fit_dg</span>, model <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 5</span></span></span>
<span><span class="co">#&gt;   term        estimate std.error conf.low conf.high</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> (Intercept)     3.67     0.120     3.44      3.91</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> sdepth          0.31     1.29     -<span style="color: #BB0000;">2.22</span>      2.84</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fit_dg</span>, model <span class="op">=</span> <span class="fl">2</span>, <span class="st">"ran_pars"</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 6</span></span></span>
<span><span class="co">#&gt;   model term         estimate std.error conf.low conf.high</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     2 range          14.8      5.02      7.62      28.8 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     2 phi             1.03     0.050<span style="text-decoration: underline;">2</span>    0.939      1.14</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     2 sigma_O         0.691    0.228     0.361      1.32</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     2 sigma_E         1.45     0.336     0.919      2.28</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     2 sd__s(depth)    5.41    <span style="color: #BB0000;">NA</span>         2.43      12.1</span></span></code></pre></div>
<!-- We can use `predict()` to predict density in either log space (the default) or transformed into the response scale (`type = "response"`). -->
<p>For built-in delta models, the default function will return estimated
response and parameters for each grid cell for each model separately,
notated with a 1 (for the presence/absence model) or 2 (for the positive
catch model) in the column name. See <code><a href="../reference/predict.sdmTMB.html">predict.sdmTMB()</a></code> for a
description of values in the data frame.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid_yrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/replicate_df.html">replicate_df</a></span><span class="op">(</span><span class="va">qcs_grid</span>, <span class="st">"year"</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_dg</span>, newdata <span class="op">=</span> <span class="va">grid_yrs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    65826 obs. of  16 variables:</span></span>
<span><span class="co">#&gt;  $ X            : num  456 458 460 462 464 466 468 470 472 474 ...</span></span>
<span><span class="co">#&gt;  $ Y            : num  5636 5636 5636 5636 5636 ...</span></span>
<span><span class="co">#&gt;  $ depth        : num  347 223 204 183 183 ...</span></span>
<span><span class="co">#&gt;  $ depth_scaled : num  1.561 0.57 0.363 0.126 0.122 ...</span></span>
<span><span class="co">#&gt;  $ depth_scaled2: num  2.4361 0.3246 0.132 0.0158 0.0149 ...</span></span>
<span><span class="co">#&gt;  $ year         : int  2003 2003 2003 2003 2003 2003 2003 2003 2003 2003 ...</span></span>
<span><span class="co">#&gt;  $ est1         : num  -5.804 -0.796 0.021 0.87 0.98 ...</span></span>
<span><span class="co">#&gt;  $ est2         : num  3.2 3.71 4.02 4.39 4.43 ...</span></span>
<span><span class="co">#&gt;  $ est_non_rf1  : num  -5.508 -0.598 0.12 0.871 0.882 ...</span></span>
<span><span class="co">#&gt;  $ est_non_rf2  : num  2.83 3.31 3.59 3.94 3.94 ...</span></span>
<span><span class="co">#&gt;  $ est_rf1      : num  -0.296138 -0.197484 -0.09883 -0.000177 0.098477 ...</span></span>
<span><span class="co">#&gt;  $ est_rf2      : num  0.368 0.398 0.428 0.459 0.489 ...</span></span>
<span><span class="co">#&gt;  $ omega_s1     : num  -0.00543 0.09317 0.19178 0.29039 0.38899 ...</span></span>
<span><span class="co">#&gt;  $ omega_s2     : num  0.108 0.119 0.129 0.139 0.15 ...</span></span>
<span><span class="co">#&gt;  $ epsilon_st1  : num  -0.291 -0.291 -0.291 -0.291 -0.291 ...</span></span>
<span><span class="co">#&gt;  $ epsilon_st2  : num  0.26 0.28 0.299 0.319 0.339 ...</span></span></code></pre></div>
<!-- We can use the `model` argument to return only predictions from model 1 or model 2. -->
<!-- To return combined predictions from both components on the response scale, we can use `model=NA` -->
<p>We can use predictions from the built-in delta model (making sure
that <code>return_tmb_object=TRUE</code>) to get the index values using
the <code><a href="../reference/get_index.html">get_index()</a></code> function. This can be used with predictions
that include both the first and second models (i.e., using the default
and specifying no <code>model</code> argument) or with predictions
generated using <code>model=NA</code>. The <code><a href="../reference/get_index.html">get_index()</a></code>
function will automatically combine predictions from the first and
second model in calculating the index values. For more on modelling for
the purposes of creating an index see the vignette on <a href="https://pbs-assess.github.io/sdmTMB/articles/index-standardization.html">Index
standardization with sdmTMB</a>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_dg</span>, newdata <span class="op">=</span> <span class="va">grid_yrs</span>, return_tmb_object <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">ind_dg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_index.html">get_index</a></span><span class="op">(</span><span class="va">p2</span>, bias_correct <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We can plot conditional effects of covariates (such as depth in the
example model) using the package <code>visreg</code> by specifying each
model component with <code>model=1</code> for the presence-absence model
or <code>model=2</code> for the positive catch model. Currently,
plotting effects of built-in delta models with <code>ggeffects</code> is
not supported. See the vignette on using <a href="https://pbs-assess.github.io/sdmTMB/articles/visreg.html">visreg</a>
with sdmTMB for more information.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/visreg_delta.html">visreg_delta</a></span><span class="op">(</span><span class="va">fit_dg</span>, xvar <span class="op">=</span> <span class="st">"depth"</span>, model <span class="op">=</span> <span class="fl">1</span>, gg <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; These are residuals for delta model component 1. Use the `model` argument to</span></span>
<span><span class="co">#&gt; select the other component.</span></span></code></pre></div>
<p><img src="delta-models_files/figure-html/unnamed-chunk-14-1.png" width="672"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/visreg_delta.html">visreg_delta</a></span><span class="op">(</span><span class="va">fit_dg</span>, xvar <span class="op">=</span> <span class="st">"depth"</span>, model <span class="op">=</span> <span class="fl">2</span>, gg <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The built-in delta models can also be evaluated with the
<code><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals()</a></code> functions in sdmTMB. Similarly to generating
predictions, we can specify which of the model components we want to
return residuals for using the <code>model</code> argument and
specifying <code>=1</code> or <code>=2</code>. See
<code><a href="../reference/residuals.sdmTMB.html">residuals.sdmTMB()</a></code> for additional options for evaluating
residuals in sdmTMB models.</p>
<p>We can also simulate new observations from a fitted delta model. As
in other functions, we can specify which model to simulate from using
the argument <code>model=1</code> for only presence/absence,
<code>model=2</code> for only positive catches, or <code>model=NA</code>
for combined predictions. See <code><a href="../reference/simulate.sdmTMB.html">simulate.sdmTMB()</a></code> for more
details on simulation options.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit_dg</span>, nsim <span class="op">=</span> <span class="fl">5</span>, seed <span class="op">=</span> <span class="fl">5090</span>, model <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="delta-models-by-fitting-two-components-separately-and-combining-predictions">Delta models by fitting two components separately and combining
predictions<a class="anchor" aria-label="anchor" href="#delta-models-by-fitting-two-components-separately-and-combining-predictions"></a>
</h2>
<p>Next, we will show an example of how to implement a delta-gamma model
in sdmTMB, but with each component fit separately and then combined.
This approach gives maximum flexibility for each model and lets you
develop them on at a time. It has limitations if you are calculating an
index of abundance or if you want to share some parameters.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 2,143</span></span>
<span><span class="co">#&gt; Columns: 12</span></span>
<span><span class="co">#&gt; $ year          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 2003<span style="color: #949494;">, </span>2003<span style="color: #949494;">, </span>2003<span style="color: #949494;">, </span>2003<span style="color: #949494;">, </span>2003<span style="color: #949494;">, </span>2003<span style="color: #949494;">, </span>2003<span style="color: #949494;">, </span>2003<span style="color: #949494;">, </span>2003<span style="color: #949494;">, </span>20…</span></span>
<span><span class="co">#&gt; $ X             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 446.4752<span style="color: #949494;">, </span>446.4594<span style="color: #949494;">, </span>448.5987<span style="color: #949494;">, </span>436.9157<span style="color: #949494;">, </span>420.6101<span style="color: #949494;">, </span>417.71…</span></span>
<span><span class="co">#&gt; $ Y             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 5793.426<span style="color: #949494;">, </span>5800.136<span style="color: #949494;">, </span>5801.687<span style="color: #949494;">, </span>5802.305<span style="color: #949494;">, </span>5771.055<span style="color: #949494;">, </span>5772.2…</span></span>
<span><span class="co">#&gt; $ depth         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 201<span style="color: #949494;">, </span>212<span style="color: #949494;">, </span>220<span style="color: #949494;">, </span>197<span style="color: #949494;">, </span>256<span style="color: #949494;">, </span>293<span style="color: #949494;">, </span>410<span style="color: #949494;">, </span>387<span style="color: #949494;">, </span>285<span style="color: #949494;">, </span>270<span style="color: #949494;">, </span>381<span style="color: #949494;">, </span>1…</span></span>
<span><span class="co">#&gt; $ density       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 113.138476<span style="color: #949494;">, </span>41.704922<span style="color: #949494;">, </span>0.000000<span style="color: #949494;">, </span>15.706138<span style="color: #949494;">, </span>0.000000<span style="color: #949494;">, </span>0.…</span></span>
<span><span class="co">#&gt; $ present       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">,</span>…</span></span>
<span><span class="co">#&gt; $ lat           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 52.28858<span style="color: #949494;">, </span>52.34890<span style="color: #949494;">, </span>52.36305<span style="color: #949494;">, </span>52.36738<span style="color: #949494;">, </span>52.08437<span style="color: #949494;">, </span>52.094…</span></span>
<span><span class="co">#&gt; $ lon           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -129.7847<span style="color: #949494;">, </span>-129.7860<span style="color: #949494;">, </span>-129.7549<span style="color: #949494;">, </span>-129.9265<span style="color: #949494;">, </span>-130.1586<span style="color: #949494;">, </span>-…</span></span>
<span><span class="co">#&gt; $ depth_mean    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 5.155194<span style="color: #949494;">, </span>5.155194<span style="color: #949494;">, </span>5.155194<span style="color: #949494;">, </span>5.155194<span style="color: #949494;">, </span>5.155194<span style="color: #949494;">, </span>5.1551…</span></span>
<span><span class="co">#&gt; $ depth_sd      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.4448783<span style="color: #949494;">, </span>0.4448783<span style="color: #949494;">, </span>0.4448783<span style="color: #949494;">, </span>0.4448783<span style="color: #949494;">, </span>0.4448783<span style="color: #949494;">, </span>0…</span></span>
<span><span class="co">#&gt; $ depth_scaled  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.3329252<span style="color: #949494;">, </span>0.4526914<span style="color: #949494;">, </span>0.5359529<span style="color: #949494;">, </span>0.2877417<span style="color: #949494;">, </span>0.8766077<span style="color: #949494;">, </span>1…</span></span>
<span><span class="co">#&gt; $ depth_scaled2 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.11083919<span style="color: #949494;">, </span>0.20492947<span style="color: #949494;">, </span>0.28724555<span style="color: #949494;">, </span>0.08279527<span style="color: #949494;">, </span>0.768440…</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mesh1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">pcod</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="co"># coarse for vignette speed</span></span></code></pre></div>
<p>It is not necessary to use the same mesh for both models, but one can
do so by updating the first mesh to match the reduced data frame as
shown here:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pcod</span>, <span class="va">density</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">mesh2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">dat2</span>,</span>
<span>  xy_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh1</span><span class="op">$</span><span class="va">mesh</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This delta-gamma model is similar to the Tweedie model in the <a href="https://pbs-assess.github.io/sdmTMB/articles/basic-intro.html">Intro
to modelling with sdmTMB</a> vignette, except that we will use
<code>s()</code> for the depth effect.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">present</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">depth</span>, k <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh1</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span>,</span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"iid"</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"on"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">m1</span></span>
<span><span class="co">#&gt; Spatiotemporal model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: present ~ 0 + as.factor(year) + s(depth, k = 3)</span></span>
<span><span class="co">#&gt; Mesh: mesh1 (isotropic covariance)</span></span>
<span><span class="co">#&gt; Time column: year</span></span>
<span><span class="co">#&gt; Data: pcod</span></span>
<span><span class="co">#&gt; Family: binomial(link = 'logit')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;                     coef.est coef.se</span></span>
<span><span class="co">#&gt; as.factor(year)2003    -0.76    0.42</span></span>
<span><span class="co">#&gt; as.factor(year)2004    -0.40    0.42</span></span>
<span><span class="co">#&gt; as.factor(year)2005    -0.42    0.42</span></span>
<span><span class="co">#&gt; as.factor(year)2007    -1.40    0.42</span></span>
<span><span class="co">#&gt; as.factor(year)2009    -1.16    0.42</span></span>
<span><span class="co">#&gt; as.factor(year)2011    -1.56    0.42</span></span>
<span><span class="co">#&gt; as.factor(year)2013    -0.38    0.42</span></span>
<span><span class="co">#&gt; as.factor(year)2015    -0.65    0.42</span></span>
<span><span class="co">#&gt; as.factor(year)2017    -1.56    0.42</span></span>
<span><span class="co">#&gt; sdepth                 -5.66    0.50</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Smooth terms:</span></span>
<span><span class="co">#&gt;           Std. Dev.</span></span>
<span><span class="co">#&gt; sds(depth      85.9</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matérn range: 28.70</span></span>
<span><span class="co">#&gt; Spatial SD: 1.89</span></span>
<span><span class="co">#&gt; Spatiotemporal IID SD: 0.90</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 1054.414</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
<p>One can use different covariates in each model, but in this case we
will just let the depth effect be more wiggly by not specifying
<code>k = 3</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">density</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">depth</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">dat2</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh2</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">Gamma</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"iid"</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"on"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">m2</span></span>
<span><span class="co">#&gt; Spatiotemporal model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: density ~ 0 + as.factor(year) + s(depth)</span></span>
<span><span class="co">#&gt; Mesh: mesh2 (isotropic covariance)</span></span>
<span><span class="co">#&gt; Time column: year</span></span>
<span><span class="co">#&gt; Data: dat2</span></span>
<span><span class="co">#&gt; Family: Gamma(link = 'log')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;                     coef.est coef.se</span></span>
<span><span class="co">#&gt; as.factor(year)2003     4.06    0.20</span></span>
<span><span class="co">#&gt; as.factor(year)2004     4.22    0.20</span></span>
<span><span class="co">#&gt; as.factor(year)2005     4.19    0.20</span></span>
<span><span class="co">#&gt; as.factor(year)2007     3.38    0.20</span></span>
<span><span class="co">#&gt; as.factor(year)2009     3.71    0.21</span></span>
<span><span class="co">#&gt; as.factor(year)2011     4.51    0.21</span></span>
<span><span class="co">#&gt; as.factor(year)2013     4.02    0.19</span></span>
<span><span class="co">#&gt; as.factor(year)2015     4.13    0.20</span></span>
<span><span class="co">#&gt; as.factor(year)2017     3.84    0.22</span></span>
<span><span class="co">#&gt; sdepth                 -0.28    0.36</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Smooth terms:</span></span>
<span><span class="co">#&gt;           Std. Dev.</span></span>
<span><span class="co">#&gt; sds(depth      1.89</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 0.94</span></span>
<span><span class="co">#&gt; Matérn range: 0.01</span></span>
<span><span class="co">#&gt; Spatial SD: 727.41</span></span>
<span><span class="co">#&gt; Spatiotemporal IID SD: 2065.26</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 5102.136</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; **Possible issues detected! Check output of sanity().**</span></span></code></pre></div>
<p>Next, we need some way of combining the predictions across the two
models. If all we need are point predictions, we can just multiply the
predictions from the two models after applying the inverse link:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="va">grid_yrs</span> <span class="co"># use the grid as template for saving our predictions</span></span>
<span><span class="va">p_bin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m1</span>, newdata <span class="op">=</span> <span class="va">grid_yrs</span><span class="op">)</span></span>
<span><span class="va">p_pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m2</span>, newdata <span class="op">=</span> <span class="va">grid_yrs</span><span class="op">)</span></span>
<span><span class="va">p_bin_prob</span> <span class="op">&lt;-</span> <span class="va">m1</span><span class="op">$</span><span class="va">family</span><span class="op">$</span><span class="fu">linkinv</span><span class="op">(</span><span class="va">p_bin</span><span class="op">$</span><span class="va">est</span><span class="op">)</span></span>
<span><span class="va">p_pos_exp</span> <span class="op">&lt;-</span> <span class="va">m2</span><span class="op">$</span><span class="va">family</span><span class="op">$</span><span class="fu">linkinv</span><span class="op">(</span><span class="va">p_pos</span><span class="op">$</span><span class="va">est</span><span class="op">)</span></span>
<span><span class="va">pred</span><span class="op">$</span><span class="va">est_exp</span> <span class="op">&lt;-</span> <span class="va">p_bin_prob</span> <span class="op">*</span> <span class="va">p_pos_exp</span></span></code></pre></div>
<p>But if a measure of uncertainty is required, we can simulate from the
joint parameter precision matrix using the <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>
function with any number of simulations selected (e.g.,
<code>sims = 500</code>). Because the predictions come from simulated
draws from the parameter covariance matrix, the predictions will become
more consistent with a larger number of draws. However, a greater number
of draws takes longer to calculate and will use more memory (larger
matrix), so fewer draws (~100) may be fine for experimentation. A larger
number (say ~1000) may be appropriate for final model runs.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">28239</span><span class="op">)</span></span>
<span><span class="va">p_bin_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m1</span>, newdata <span class="op">=</span> <span class="va">grid_yrs</span>, nsim <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">p_pos_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m2</span>, newdata <span class="op">=</span> <span class="va">grid_yrs</span>, nsim <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">p_bin_prob_sim</span> <span class="op">&lt;-</span> <span class="va">m1</span><span class="op">$</span><span class="va">family</span><span class="op">$</span><span class="fu">linkinv</span><span class="op">(</span><span class="va">p_bin_sim</span><span class="op">)</span></span>
<span><span class="va">p_pos_exp_sim</span> <span class="op">&lt;-</span> <span class="va">m2</span><span class="op">$</span><span class="va">family</span><span class="op">$</span><span class="fu">linkinv</span><span class="op">(</span><span class="va">p_pos_sim</span><span class="op">)</span></span>
<span><span class="va">p_combined_sim</span> <span class="op">&lt;-</span> <span class="va">p_bin_prob_sim</span> <span class="op">*</span> <span class="va">p_pos_exp_sim</span></span></code></pre></div>
<p><code>p_combined_sim</code> is a matrix with a row for each row of
data that was predicted on and width <code>nsim</code>. You can process
this matrix however you would like. We can save median predictions and
upper and lower 95% confidence intervals:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span><span class="op">$</span><span class="va">median</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">p_combined_sim</span>, <span class="fl">1</span>, <span class="va">median</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pred</span><span class="op">$</span><span class="va">est_exp</span>, <span class="va">pred</span><span class="op">$</span><span class="va">median</span><span class="op">)</span></span></code></pre></div>
<p><img src="delta-models_files/figure-html/unnamed-chunk-19-1.png" width="480"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">year</span> <span class="op">==</span> <span class="fl">2017</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, fill <span class="op">=</span> <span class="va">median</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"sqrt"</span><span class="op">)</span></span></code></pre></div>
<p><img src="delta-models_files/figure-html/unnamed-chunk-20-1.png" width="672"></p>
<p>And we can calculate spatial uncertainty:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span><span class="op">$</span><span class="va">cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">p_combined_sim</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">year</span> <span class="op">==</span> <span class="fl">2017</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, fill <span class="op">=</span> <span class="va">cv</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># 2017 as an example</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span></span></code></pre></div>
<p><img src="delta-models_files/figure-html/cv-1.png" width="672"></p>
<!-- sdmTMB also has a function for calculating an index from those draws `get_index_sims()`. -->
<!-- This function is just summing biomass or abundance across grid cells for each simulation draw and for each year and then calculating quantiles on the distribution of samples. -->
<!-- The default for this function expects the simulations to still be in log space. -->
<!-- This index from simulated draws is an approximation.  -->
<!-- We recommend using the built-in delta model and `get_index(..., bias_correct = TRUE)` for final inference in important applications. -->
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sean C. Anderson, Eric J. Ward, Philina A. English, Lewis A. K. Barnett, James T. Thorson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
