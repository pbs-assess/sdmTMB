<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Bayesian estimation with sdmTMB • sdmTMB</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Bayesian estimation with sdmTMB">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sdmTMB</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.4.9024</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/sdmTMB/sdmTMB/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Bayesian estimation with sdmTMB</h1>
            
            <h4 data-toc-skip class="date">2025-11-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/sdmTMB/sdmTMB/blob/main/vignettes/articles/bayesian.Rmd" class="external-link"><code>vignettes/articles/bayesian.Rmd</code></a></small>
      <div class="d-none name"><code>bayesian.Rmd</code></div>
    </div>

    
    
<p><strong>If the code in this vignette has not been evaluated, a
rendered version is available on the <a href="https://sdmTMB.github.io/sdmTMB/index.html">documentation site</a>
under ‘Articles’.</strong></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sdmTMB.github.io/sdmTMB/">sdmTMB</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/" class="external-link">rstan</a></span><span class="op">)</span> <span class="co"># for plot() method</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co"># use rstan parallel processing</span></span></code></pre></div>
<p>Bayesian estimation is possible with sdmTMB by passing fitted models
to <code><a href="https://rdrr.io/pkg/tmbstan/man/tmbstan.html" class="external-link">tmbstan::tmbstan()</a></code> <span class="citation">(Monnahan
&amp; Kristensen 2018)</span>. All sampling is then done using Stan
<span class="citation">(Stan Development Team 2021)</span>, and output
is returned as a <code>stanfit</code> object.</p>
<p>Why might you want to pass an sdmTMB model to Stan?</p>
<ul>
<li>to obtain probabilistic inference on parameters</li>
<li>to avoid the Laplace approximation on the random effects</li>
<li>to robustly quantify uncertainty on derived quantities not already
calculated in the model</li>
<li>in some cases, models that struggle to converge with maximum
likelihood can be adequately sampled with MCMC given carefully chosen
priors <span class="citation">(e.g., Monnahan <em>et al.</em>
2021)</span>
</li>
</ul>
<div class="section level2">
<h2 id="simulating-data">Simulating data<a class="anchor" aria-label="anchor" href="#simulating-data"></a>
</h2>
<p>Here we will demonstrate using a simulated dataset.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">predictor_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span>, Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span>,</span>
<span>  a1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">predictor_dat</span>, xy_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="co"># plot(mesh)</span></span>
<span><span class="co"># mesh$mesh$n</span></span>
<span><span class="va">sim_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB_simulate.html">sdmTMB_simulate</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="op">~</span><span class="va">a1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">predictor_dat</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  range <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  phi <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  sigma_O <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">123</span>,</span>
<span>  B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="op">-</span><span class="fl">0.4</span><span class="op">)</span> <span class="co"># B0 = intercept, B1 = a1 slope</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Visualize our simulated data:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sim_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, colour <span class="op">=</span> <span class="va">observed</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="bayesian_files/figure-html/unnamed-chunk-2-1.png" class="r-plt" width="672"></p>
</div>
<div class="section level2">
<h2 id="fitting-the-model-with-marginal-likelihood">Fitting the model with marginal likelihood<a class="anchor" aria-label="anchor" href="#fitting-the-model-with-marginal-likelihood"></a>
</h2>
<p>First, fit a spatial random field GLMM with maximum likelihood:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">observed</span> <span class="op">~</span> <span class="va">a1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">sim_dat</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"on"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fit</span></span>
<span><span class="co">#&gt; Spatial model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: observed ~ a1</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Data: sim_dat</span></span>
<span><span class="co">#&gt; Family: gaussian(link = 'identity')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;             coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)      0.8    0.06</span></span>
<span><span class="co">#&gt; a1              -0.4    0.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 0.20</span></span>
<span><span class="co">#&gt; Matérn range: 0.32</span></span>
<span><span class="co">#&gt; Spatial SD: 0.17</span></span>
<span><span class="co">#&gt; ML criterion at convergence: -65.939</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="adding-priors">Adding priors<a class="anchor" aria-label="anchor" href="#adding-priors"></a>
</h2>
<p>In that first model fit we did not use any priors (with maximum
likelihood estimation, these also can be thought of as penalties on the
likelihood). For this first model, the priors are implied as uniform on
the internal parameter space. However, sdmTMB provides the option of
applying additional priors. Here we will show an example of applying a
Normal(0, 5) (mean, SD) prior on the intercept and a Normal(0, 1) prior
on the slope parameter. We could guess at the model matrix structure
based on our formula, but we can verify it by looking at the internal
model matrix from the previous fit (using <code>do_fit = FALSE</code>
would save time if you didn’t want to fit it the first time).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">tmb_data</span><span class="op">$</span><span class="va">X_ij</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;   (Intercept)          a1</span></span>
<span><span class="co">#&gt; 1           1 -0.60189285</span></span>
<span><span class="co">#&gt; 2           1 -0.99369859</span></span>
<span><span class="co">#&gt; 3           1  1.02678506</span></span>
<span><span class="co">#&gt; 4           1  0.75106130</span></span>
<span><span class="co">#&gt; 5           1 -1.50916654</span></span>
<span><span class="co">#&gt; 6           1 -0.09514745</span></span></code></pre></div>
<p>Each column corresponds to the order of the <code>b</code>
priors:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">observed</span> <span class="op">~</span> <span class="va">a1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">sim_dat</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"on"</span>,</span>
<span>  priors <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">sdmTMBpriors</a></span><span class="op">(</span></span>
<span>    <span class="co"># location = vector of means; scale = vector of standard deviations:</span></span>
<span>    b <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">normal</a></span><span class="op">(</span>location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fit</span></span>
<span><span class="co">#&gt; Spatial model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: observed ~ a1</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Data: sim_dat</span></span>
<span><span class="co">#&gt; Family: gaussian(link = 'identity')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;             coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)      0.8    0.06</span></span>
<span><span class="co">#&gt; a1              -0.4    0.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 0.20</span></span>
<span><span class="co">#&gt; Matérn range: 0.32</span></span>
<span><span class="co">#&gt; Spatial SD: 0.17</span></span>
<span><span class="co">#&gt; ML criterion at convergence: -62.846</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fixing-a-spatial-correlation-parameter-to-improve-convergence">Fixing a spatial correlation parameter to improve convergence<a class="anchor" aria-label="anchor" href="#fixing-a-spatial-correlation-parameter-to-improve-convergence"></a>
</h2>
<p>Sometimes some of the spatial correlation parameters can be
challenging to estimate with Stan. One option is to apply penalized
complexity (PC) priors with <code><a href="../reference/priors.html">sdmTMBpriors()</a></code> to the Matérn
parameters. Another option, which can also be used in conjunction with
the priors, is to fix one or more parameters at their maximum likelihood
estimate (MLE) values. Frequently, fixing the parameter
<code>ln_kappa</code> can help convergence <span class="citation">(e.g.,
Monnahan <em>et al.</em> 2021)</span>. This estimated parameter is
transformed into the range estimate, so it controls the rate of spatial
correlation decay.</p>
<p>Now we will rebuild the fitted object with fixed (‘mapped’)
<code>ln_kappa</code> parameters using the <code><a href="https://rdrr.io/r/stats/update.html" class="external-link">update()</a></code>
function. We’ll use <code>do_fit = FALSE</code> to avoid actually
fitting the updated model since it’s not necessary.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># grab the internal parameter list at estimated values:</span></span>
<span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu">sdmTMB</span><span class="fu">::</span><span class="fu"><a href="../reference/get_pars.html">get_pars</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co"># create a 'map' vector for TMB</span></span>
<span><span class="co"># factor NA values cause TMB to fix or map the parameter at the starting value:</span></span>
<span><span class="va">kappa_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">pars</span><span class="op">$</span><span class="va">ln_kappa</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># rebuild model updating some elements:</span></span>
<span><span class="va">fit_mle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span></span>
<span>  <span class="va">fit</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="../reference/sdmTMBcontrol.html">sdmTMBcontrol</a></span><span class="op">(</span></span>
<span>    start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      ln_kappa <span class="op">=</span> <span class="va">pars</span><span class="op">$</span><span class="va">ln_kappa</span> <span class="co">#&lt;</span></span>
<span>    <span class="op">)</span>,</span>
<span>    map <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      ln_kappa <span class="op">=</span> <span class="va">kappa_map</span> <span class="co">#&lt;</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  do_fit <span class="op">=</span> <span class="cn">FALSE</span> <span class="co">#&lt;</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Initiating `ln_kappa` at specified starting value(s) of:</span></span>
<span><span class="co">#&gt; 2.173, 2.173</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Fixing or mirroring `ln_kappa`</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="jacobian-adjustments">Jacobian adjustments<a class="anchor" aria-label="anchor" href="#jacobian-adjustments"></a>
</h2>
<p>Adding priors / penalties and fixing spatial parameters represent
strategies to help successful convergence for maximum likelihood
estimation. If we want to do true Bayesian sampling we need to make one
more adjustment to our function call: accounting for non-linear
transformations of parameters with Jacobian adjustments.</p>
<p>What are Jacobian adjustments and why do we need them? Jacobian
adjustments are necessary when the parameters of a model are transformed
in a way that changes their scale or distribution. A good example of
this is the estimation of variance parameters. Whether we’re interested
in spatial, spatiotemporal, or residual variation, the quantity of
interest is usually the variance or standard deviation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>.
These quantities are constrained to be greater than 0, so a widely used
estimation strategy is to estimate them in log space, which is not
constrained. With ‘ln_sigma’ estimated, ‘sigma = exp(ln_sigma)’ can be
calculated internal to a model and used to calculate the likelihood.
There are a number of helpful references detailing the math behind this
in greater detail including the <a href="https://mc-stan.org/docs/stan-users-guide/reparameterization.html#changes-of-variables" class="external-link">Stan
manual</a>. Without equations, the Jacobian adjustment can be thought of
as properly stretching the posterior distribution of parameters to
account for the transformation of variables.</p>
<p>In <code>sdmTMB</code>, we can turn these Jacobian adjustments on
with the flag <code>bayesian = TRUE</code>. Applying this to our
<code>fit_mle</code> object,</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_bayes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">fit_mle</span>,</span>
<span>  bayesian <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Initiating `ln_kappa` at specified starting value(s) of:</span></span>
<span><span class="co">#&gt; 2.173, 2.173</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Fixing or mirroring `ln_kappa`</span></span></code></pre></div>
<p>It is important to emphasize that this <code>bayesian</code> flag
needs to be enabled to any model passed to Stan; MCMC estimation without
it will lead to biased parameter estimates.</p>
</div>
<div class="section level2">
<h2 id="passing-the-model-to-tmbstan">Passing the model to tmbstan<a class="anchor" aria-label="anchor" href="#passing-the-model-to-tmbstan"></a>
</h2>
<p>Now we can pass the <code>$tmb_obj</code> element of our model to
<code><a href="https://rdrr.io/pkg/tmbstan/man/tmbstan.html" class="external-link">tmbstan::tmbstan()</a></code>. We are only using 1000 iterations and 2
chains so this vignette builds quickly. In practice, you will likely
want to use more (e.g., 2000 iterations, 4 chains).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_stan</span> <span class="op">&lt;-</span> <span class="fu">tmbstan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tmbstan/man/tmbstan.html" class="external-link">tmbstan</a></span><span class="op">(</span></span>
<span>  <span class="va">fit_bayes</span><span class="op">$</span><span class="va">tmb_obj</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">1000</span>, chains <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">8217</span> <span class="co"># ensures repeatability</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Sometimes you may need to adjust the sampler settings such as:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tmbstan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tmbstan/man/tmbstan.html" class="external-link">tmbstan</a></span><span class="op">(</span></span>
<span>  <span class="va">...</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.9</span>, max_treedepth <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>See the Details section in <code><a href="https://mc-stan.org/rstan/reference/stan.html" class="external-link">?rstan::stan</a></code>.</p>
<p>You can also ‘thin’ samples via the <code>thin</code> argument if
working with model predictions becomes cumbersome given a large number
of required samples.</p>
<p>We can look at the model:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_stan</span></span>
<span><span class="co">#&gt; Inference for Stan model: sdmTMB.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=1000; warmup=500; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=500, total post-warmup draws=1000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;               mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; b_j[1]        0.81    0.01 0.05   0.69   0.77   0.81   0.84   0.92    71 1.03</span></span>
<span><span class="co">#&gt; b_j[2]       -0.40    0.00 0.01  -0.41  -0.40  -0.40  -0.39  -0.38  1923 1.00</span></span>
<span><span class="co">#&gt; ln_tau_O     -1.66    0.01 0.14  -1.93  -1.75  -1.65  -1.57  -1.37   384 1.00</span></span>
<span><span class="co">#&gt; ln_phi       -1.63    0.00 0.04  -1.70  -1.65  -1.63  -1.60  -1.56  1147 1.00</span></span>
<span><span class="co">#&gt; omega_s[1]   -0.09    0.01 0.09  -0.26  -0.15  -0.09  -0.04   0.08   148 1.02</span></span>
<span><span class="co">#&gt; omega_s[2]   -0.06    0.01 0.09  -0.23  -0.12  -0.06   0.00   0.11   168 1.01</span></span>
<span><span class="co">#&gt; omega_s[3]    0.01    0.01 0.09  -0.16  -0.05   0.01   0.07   0.20   228 1.01</span></span>
<span><span class="co">#&gt; omega_s[4]   -0.21    0.01 0.09  -0.38  -0.27  -0.21  -0.15  -0.02   193 1.01</span></span>
<span><span class="co">#&gt; omega_s[5]   -0.34    0.01 0.10  -0.53  -0.41  -0.34  -0.27  -0.14   324 1.00</span></span>
<span><span class="co">#&gt; omega_s[6]   -0.09    0.01 0.10  -0.29  -0.15  -0.09  -0.01   0.12   224 1.01</span></span>
<span><span class="co">#&gt; omega_s[7]   -0.03    0.01 0.08  -0.19  -0.09  -0.03   0.02   0.15   142 1.02</span></span>
<span><span class="co">#&gt; omega_s[8]   -0.23    0.01 0.09  -0.41  -0.29  -0.23  -0.17  -0.05   210 1.01</span></span>
<span><span class="co">#&gt; omega_s[9]   -0.32    0.01 0.09  -0.49  -0.38  -0.32  -0.26  -0.15   206 1.01</span></span>
<span><span class="co">#&gt; omega_s[10]   0.28    0.01 0.09   0.12   0.22   0.28   0.34   0.45   173 1.01</span></span>
<span><span class="co">#&gt; omega_s[11]  -0.16    0.01 0.09  -0.33  -0.22  -0.16  -0.10   0.02   169 1.01</span></span>
<span><span class="co">#&gt; omega_s[12]   0.00    0.01 0.10  -0.19  -0.07   0.00   0.06   0.20   321 1.01</span></span>
<span><span class="co">#&gt; omega_s[13]   0.18    0.01 0.08   0.04   0.13   0.18   0.24   0.34   157 1.02</span></span>
<span><span class="co">#&gt; omega_s[14]  -0.09    0.01 0.10  -0.28  -0.16  -0.09  -0.03   0.10   225 1.01</span></span>
<span><span class="co">#&gt; omega_s[15]   0.22    0.01 0.09   0.04   0.16   0.22   0.27   0.38   175 1.01</span></span>
<span><span class="co">#&gt; omega_s[16]  -0.02    0.01 0.09  -0.20  -0.08  -0.02   0.04   0.15   194 1.01</span></span>
<span><span class="co">#&gt; omega_s[17]  -0.15    0.01 0.09  -0.33  -0.21  -0.15  -0.09   0.03   266 1.00</span></span>
<span><span class="co">#&gt; omega_s[18]  -0.29    0.01 0.11  -0.49  -0.36  -0.29  -0.22  -0.09   254 1.00</span></span>
<span><span class="co">#&gt; omega_s[19]  -0.01    0.01 0.09  -0.19  -0.07   0.00   0.06   0.18   179 1.01</span></span>
<span><span class="co">#&gt; omega_s[20]   0.02    0.01 0.08  -0.15  -0.04   0.02   0.07   0.18   156 1.01</span></span>
<span><span class="co">#&gt; omega_s[21]   0.07    0.01 0.08  -0.07   0.01   0.07   0.13   0.24   163 1.01</span></span>
<span><span class="co">#&gt; omega_s[22]  -0.02    0.01 0.10  -0.22  -0.09  -0.02   0.06   0.18   219 1.01</span></span>
<span><span class="co">#&gt; omega_s[23]   0.12    0.01 0.09  -0.04   0.06   0.11   0.17   0.30   169 1.02</span></span>
<span><span class="co">#&gt; omega_s[24]   0.20    0.01 0.10   0.00   0.13   0.19   0.26   0.41   264 1.01</span></span>
<span><span class="co">#&gt; omega_s[25]   0.07    0.01 0.08  -0.10   0.02   0.07   0.12   0.23   146 1.01</span></span>
<span><span class="co">#&gt; omega_s[26]  -0.01    0.01 0.10  -0.21  -0.08  -0.01   0.06   0.18   241 1.01</span></span>
<span><span class="co">#&gt; omega_s[27]  -0.11    0.01 0.09  -0.28  -0.17  -0.11  -0.05   0.06   224 1.01</span></span>
<span><span class="co">#&gt; omega_s[28]   0.11    0.01 0.10  -0.07   0.05   0.11   0.18   0.32   247 1.01</span></span>
<span><span class="co">#&gt; omega_s[29]   0.29    0.01 0.09   0.12   0.23   0.29   0.35   0.47   189 1.01</span></span>
<span><span class="co">#&gt; omega_s[30]  -0.04    0.01 0.09  -0.21  -0.10  -0.04   0.01   0.13   202 1.01</span></span>
<span><span class="co">#&gt; omega_s[31]   0.09    0.01 0.08  -0.06   0.04   0.09   0.15   0.25   180 1.01</span></span>
<span><span class="co">#&gt; omega_s[32]   0.05    0.01 0.11  -0.17  -0.02   0.05   0.12   0.26   359 1.01</span></span>
<span><span class="co">#&gt; omega_s[33]   0.07    0.01 0.10  -0.12   0.01   0.07   0.14   0.28   241 1.00</span></span>
<span><span class="co">#&gt; omega_s[34]   0.04    0.01 0.09  -0.13  -0.02   0.04   0.10   0.22   223 1.01</span></span>
<span><span class="co">#&gt; omega_s[35]   0.07    0.01 0.09  -0.11   0.01   0.07   0.13   0.24   219 1.01</span></span>
<span><span class="co">#&gt; omega_s[36]   0.14    0.01 0.09  -0.04   0.07   0.14   0.20   0.32   240 1.01</span></span>
<span><span class="co">#&gt; omega_s[37]   0.16    0.01 0.11  -0.05   0.08   0.16   0.23   0.38   331 1.00</span></span>
<span><span class="co">#&gt; omega_s[38]   0.12    0.01 0.09  -0.05   0.05   0.12   0.17   0.30   222 1.01</span></span>
<span><span class="co">#&gt; omega_s[39]  -0.22    0.01 0.09  -0.40  -0.28  -0.23  -0.16  -0.03   212 1.01</span></span>
<span><span class="co">#&gt; omega_s[40]  -0.03    0.01 0.09  -0.21  -0.09  -0.03   0.04   0.17   163 1.01</span></span>
<span><span class="co">#&gt; omega_s[41]   0.18    0.01 0.09   0.01   0.13   0.18   0.24   0.35   149 1.02</span></span>
<span><span class="co">#&gt; omega_s[42]   0.20    0.01 0.09   0.03   0.14   0.20   0.26   0.38   198 1.01</span></span>
<span><span class="co">#&gt; omega_s[43]   0.14    0.01 0.10  -0.04   0.07   0.14   0.21   0.34   277 1.01</span></span>
<span><span class="co">#&gt; omega_s[44]   0.13    0.01 0.09  -0.05   0.07   0.13   0.19   0.33   192 1.01</span></span>
<span><span class="co">#&gt; omega_s[45]   0.09    0.01 0.10  -0.12   0.02   0.09   0.16   0.29   272 1.01</span></span>
<span><span class="co">#&gt; omega_s[46]   0.06    0.01 0.09  -0.11  -0.01   0.05   0.12   0.24   217 1.01</span></span>
<span><span class="co">#&gt; omega_s[47]   0.30    0.01 0.09   0.13   0.24   0.30   0.37   0.48   188 1.01</span></span>
<span><span class="co">#&gt; omega_s[48]  -0.25    0.01 0.10  -0.44  -0.31  -0.24  -0.18  -0.07   261 1.00</span></span>
<span><span class="co">#&gt; omega_s[49]   0.09    0.01 0.10  -0.11   0.03   0.09   0.16   0.29   251 1.01</span></span>
<span><span class="co">#&gt; omega_s[50]  -0.09    0.01 0.08  -0.24  -0.14  -0.09  -0.04   0.07   161 1.01</span></span>
<span><span class="co">#&gt; omega_s[51]   0.24    0.01 0.11   0.03   0.17   0.24   0.31   0.47   238 1.00</span></span>
<span><span class="co">#&gt; omega_s[52]  -0.22    0.01 0.11  -0.43  -0.29  -0.21  -0.15  -0.02   279 1.00</span></span>
<span><span class="co">#&gt; omega_s[53]   0.03    0.01 0.10  -0.14  -0.03   0.04   0.09   0.22   236 1.01</span></span>
<span><span class="co">#&gt; omega_s[54]   0.03    0.01 0.09  -0.14  -0.04   0.02   0.09   0.21   179 1.02</span></span>
<span><span class="co">#&gt; omega_s[55]  -0.09    0.01 0.11  -0.30  -0.16  -0.09  -0.02   0.13   467 1.00</span></span>
<span><span class="co">#&gt; omega_s[56]  -0.42    0.01 0.10  -0.62  -0.49  -0.42  -0.34  -0.22   241 1.01</span></span>
<span><span class="co">#&gt; omega_s[57]   0.00    0.01 0.11  -0.21  -0.08   0.01   0.08   0.21   288 1.01</span></span>
<span><span class="co">#&gt; omega_s[58]  -0.21    0.01 0.10  -0.40  -0.28  -0.21  -0.16  -0.02   197 1.01</span></span>
<span><span class="co">#&gt; omega_s[59]   0.04    0.01 0.23  -0.40  -0.12   0.04   0.19   0.49   859 1.00</span></span>
<span><span class="co">#&gt; omega_s[60]  -0.22    0.01 0.26  -0.71  -0.40  -0.21  -0.05   0.31  1225 1.00</span></span>
<span><span class="co">#&gt; omega_s[61]  -0.27    0.01 0.24  -0.73  -0.43  -0.27  -0.11   0.20   637 1.00</span></span>
<span><span class="co">#&gt; omega_s[62]  -0.27    0.01 0.24  -0.73  -0.42  -0.27  -0.10   0.19   521 1.00</span></span>
<span><span class="co">#&gt; omega_s[63]  -0.27    0.01 0.23  -0.70  -0.43  -0.27  -0.13   0.18   645 1.00</span></span>
<span><span class="co">#&gt; omega_s[64]   0.07    0.01 0.23  -0.37  -0.09   0.08   0.23   0.51   972 1.00</span></span>
<span><span class="co">#&gt; omega_s[65]   0.17    0.01 0.22  -0.25   0.02   0.17   0.33   0.59   808 1.00</span></span>
<span><span class="co">#&gt; omega_s[66]   0.16    0.01 0.22  -0.28   0.02   0.16   0.30   0.57   676 1.00</span></span>
<span><span class="co">#&gt; omega_s[67]  -0.03    0.01 0.22  -0.45  -0.17  -0.02   0.11   0.39   759 1.00</span></span>
<span><span class="co">#&gt; omega_s[68]  -0.01    0.01 0.25  -0.49  -0.19  -0.01   0.16   0.44   927 1.00</span></span>
<span><span class="co">#&gt; omega_s[69]   0.00    0.01 0.22  -0.42  -0.14   0.01   0.15   0.41   745 1.00</span></span>
<span><span class="co">#&gt; omega_s[70]   0.00    0.01 0.21  -0.44  -0.13   0.00   0.14   0.41   732 1.00</span></span>
<span><span class="co">#&gt; omega_s[71]   0.17    0.01 0.22  -0.29   0.03   0.18   0.31   0.57   642 1.00</span></span>
<span><span class="co">#&gt; omega_s[72]  -0.11    0.01 0.24  -0.62  -0.27  -0.11   0.05   0.35   859 1.00</span></span>
<span><span class="co">#&gt; omega_s[73]  -0.14    0.01 0.22  -0.59  -0.29  -0.14   0.00   0.26   545 1.00</span></span>
<span><span class="co">#&gt; omega_s[74]  -0.13    0.01 0.21  -0.55  -0.28  -0.12   0.01   0.26   572 1.00</span></span>
<span><span class="co">#&gt; omega_s[75]  -0.38    0.01 0.22  -0.80  -0.52  -0.38  -0.24   0.05   958 1.00</span></span>
<span><span class="co">#&gt; omega_s[76]   0.09    0.01 0.19  -0.26  -0.04   0.09   0.21   0.48   912 1.01</span></span>
<span><span class="co">#&gt; omega_s[77]   0.09    0.01 0.20  -0.30  -0.04   0.08   0.22   0.49   710 1.00</span></span>
<span><span class="co">#&gt; omega_s[78]  -0.06    0.01 0.21  -0.45  -0.20  -0.06   0.08   0.39   998 1.00</span></span>
<span><span class="co">#&gt; omega_s[79]   0.04    0.01 0.15  -0.27  -0.06   0.04   0.15   0.34   638 1.00</span></span>
<span><span class="co">#&gt; omega_s[80]  -0.18    0.01 0.23  -0.64  -0.33  -0.17  -0.02   0.23  1011 1.00</span></span>
<span><span class="co">#&gt; omega_s[81]  -0.07    0.01 0.19  -0.43  -0.20  -0.08   0.06   0.29   844 1.00</span></span>
<span><span class="co">#&gt; omega_s[82]  -0.15    0.01 0.20  -0.55  -0.29  -0.14  -0.02   0.26   834 1.00</span></span>
<span><span class="co">#&gt; omega_s[83]  -0.02    0.01 0.23  -0.46  -0.17  -0.02   0.14   0.41   978 1.00</span></span>
<span><span class="co">#&gt; omega_s[84]   0.11    0.01 0.20  -0.28  -0.02   0.11   0.24   0.50  1071 1.00</span></span>
<span><span class="co">#&gt; omega_s[85]  -0.30    0.01 0.21  -0.71  -0.44  -0.30  -0.16   0.12  1112 1.00</span></span>
<span><span class="co">#&gt; lp__        136.24    0.54 9.17 118.78 130.29 136.85 142.47 153.21   284 1.00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Nov 22 21:53:05 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span></code></pre></div>
<p>The <code>Rhat</code> values look reasonable (&lt; 1.05). The
<code>n_eff</code> (number of effective samples) values mostly look
reasonable (&gt; 100) for inference about the mean for all parameters
except the intercept (<code>b_j[1]</code>). Furthermore, we can see
correlation in the MCMC samples for <code>b_j[1]</code>. We could try
running for more iterations and chains and/or placing priors on this and
other parameters as described below (highly recommended).</p>
<p>Now we can use various functions to visualize the posterior:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit_stan</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'pars' not specified. Showing first 10 parameters by default.</span></span>
<span><span class="co">#&gt; ci_level: 0.8 (80% intervals)</span></span>
<span><span class="co">#&gt; outer_level: 0.95 (95% intervals)</span></span></code></pre></div>
<p><img src="bayesian_files/figure-html/unnamed-chunk-9-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pars_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b_j[1]"</span>, <span class="st">"b_j[2]"</span>, <span class="st">"ln_tau_O"</span>, <span class="st">"omega_s[1]"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">bayesplot</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-traces.html" class="external-link">mcmc_trace</a></span><span class="op">(</span><span class="va">fit_stan</span>, pars <span class="op">=</span> <span class="va">pars_plot</span><span class="op">)</span></span></code></pre></div>
<p><img src="bayesian_files/figure-html/unnamed-chunk-9-2.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">bayesplot</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-scatterplots.html" class="external-link">mcmc_pairs</a></span><span class="op">(</span><span class="va">fit_stan</span>, pars <span class="op">=</span> <span class="va">pars_plot</span><span class="op">)</span></span></code></pre></div>
<p><img src="bayesian_files/figure-html/unnamed-chunk-9-3.png" class="r-plt" width="672"></p>
</div>
<div class="section level2">
<h2 id="posterior-predictive-checks">Posterior predictive checks<a class="anchor" aria-label="anchor" href="#posterior-predictive-checks"></a>
</h2>
<p>We can perform posterior predictive checks to assess whether our
model can generate predictive data that are consistent with the
observations. For this, we can make use of
<code><a href="../reference/simulate.sdmTMB.html">simulate.sdmTMB()</a></code> while passing in our Stan model.
<code><a href="../reference/simulate.sdmTMB.html">simulate.sdmTMB()</a></code> will take draws from the joint parameter
posterior and add observation error. We need to ensure <code>nsim</code>
is less than or equal to the total number of post-warmup samples.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">19292</span><span class="op">)</span></span>
<span><span class="va">samps</span> <span class="op">&lt;-</span> <span class="fu">sdmTMBextra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sdmTMBextra/man/extract_mcmc.html" class="external-link">extract_mcmc</a></span><span class="op">(</span><span class="va">fit_stan</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">fit_mle</span>, mcmc_samples <span class="op">=</span> <span class="va">samps</span>, nsim <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="fu">bayesplot</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/pp_check.html" class="external-link">pp_check</a></span><span class="op">(</span></span>
<span>  <span class="va">sim_dat</span><span class="op">$</span><span class="va">observed</span>,</span>
<span>  yrep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span>,</span>
<span>  fun <span class="op">=</span> <span class="fu">bayesplot</span><span class="fu">::</span><span class="va"><a href="https://mc-stan.org/bayesplot/reference/PPC-distributions.html" class="external-link">ppc_dens_overlay</a></span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="bayesian_files/figure-html/unnamed-chunk-10-1.png" class="r-plt" width="672"></p>
<p>See <code><a href="https://mc-stan.org/bayesplot/reference/pp_check.html" class="external-link">?bayesplot::pp_check</a></code>. The solid line represents the
density of the observed data and the light blue lines represent the
density of 50 posterior predictive simulations. In this case, the
simulated data seem consistent with the observed data.</p>
</div>
<div class="section level2">
<h2 id="plotting-predictions">Plotting predictions<a class="anchor" aria-label="anchor" href="#plotting-predictions"></a>
</h2>
<p>We can make predictions with our Bayesian model by supplying the
posterior samples to the <code>mcmc_samples</code> argument in
<code><a href="../reference/predict.sdmTMB.html">predict.sdmTMB()</a></code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_mle</span>, mcmc_samples <span class="op">=</span> <span class="va">samps</span><span class="op">)</span></span></code></pre></div>
<p>The output is a matrix where each row corresponds to a row of
predicted data and each column corresponds to a sample.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  500 1000</span></span></code></pre></div>
<p>We can summarize these draws in various ways to visualize them:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_dat</span><span class="op">$</span><span class="va">post_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">pred</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span></span>
<span><span class="va">sim_dat</span><span class="op">$</span><span class="va">post_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">pred</span>, <span class="fl">1</span>, <span class="va">sd</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sim_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, colour <span class="op">=</span> <span class="va">post_mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="bayesian_files/figure-html/unnamed-chunk-13-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sim_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, colour <span class="op">=</span> <span class="va">post_sd</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="bayesian_files/figure-html/unnamed-chunk-13-2.png" class="r-plt" width="672"></p>
<p>Or predict on a grid for a given value of <code>a1</code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">70</span><span class="op">)</span>,</span>
<span>  Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">70</span><span class="op">)</span>,</span>
<span>  a1 <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span>
<span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_mle</span>, newdata <span class="op">=</span> <span class="va">nd</span>, mcmc_samples <span class="op">=</span> <span class="va">samps</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nd</span><span class="op">$</span><span class="va">post_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">pred</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span></span>
<span><span class="va">nd</span><span class="op">$</span><span class="va">post_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">pred</span>, <span class="fl">1</span>, <span class="va">sd</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">nd</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, fill <span class="op">=</span> <span class="va">post_mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="bayesian_files/figure-html/unnamed-chunk-14-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">nd</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, fill <span class="op">=</span> <span class="va">post_sd</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="bayesian_files/figure-html/unnamed-chunk-14-2.png" class="r-plt" width="672"></p>
</div>
<div class="section level2">
<h2 id="extracting-parameter-posterior-samples">Extracting parameter posterior samples<a class="anchor" aria-label="anchor" href="#extracting-parameter-posterior-samples"></a>
</h2>
<p>We can extract posterior samples with
<code><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">rstan::extract()</a></code>,</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit_stan</span><span class="op">)</span></span></code></pre></div>
<p>The result is a list where each element corresponds to a parameter or
set of parameters:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">post</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "b_j"      "ln_tau_O" "ln_phi"   "omega_s"  "lp__"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">b_j</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="bayesian_files/figure-html/unnamed-chunk-15-1.png" class="r-plt" width="672"></p>
<p>As an example of calculating a derived parameter, here we will
calculate the marginal spatial random field standard deviation:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ln_kappa</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_pars.html">get_pars</a></span><span class="op">(</span><span class="va">fit_mle</span><span class="op">)</span><span class="op">$</span><span class="va">ln_kappa</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="co"># 2 elements since 2nd would be for spatiotemporal</span></span>
<span><span class="va">ln_tau_O</span> <span class="op">&lt;-</span> <span class="va">post</span><span class="op">$</span><span class="va">ln_tau_O</span></span>
<span><span class="va">sigma_O</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">4</span> <span class="op">*</span> <span class="va">pi</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">ln_tau_O</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">ln_kappa</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">sigma_O</span><span class="op">)</span></span></code></pre></div>
<p><img src="bayesian_files/figure-html/unnamed-chunk-16-1.png" class="r-plt" width="672"></p>
</div>
<div class="section level2">
<h2 id="extracting-the-posterior-of-other-predicted-elements">Extracting the posterior of other predicted elements<a class="anchor" aria-label="anchor" href="#extracting-the-posterior-of-other-predicted-elements"></a>
</h2>
<p>By default <code><a href="../reference/predict.sdmTMB.html">predict.sdmTMB()</a></code> returns the overall
prediction in link space when a tmbstan model is passed in. If instead
we want some other element that we might find in the usual data frame
returned by <code><a href="../reference/predict.sdmTMB.html">predict.sdmTMB()</a></code> when applied to a regular
sdmTMB model, we can specify that through the <code>sims_var</code>
argument.</p>
<p>For example, let’s extract the spatial random field values
<code>"omega_s"</code>. Other options are documented in
<code>?predict.sdmTMB()</code>.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>  <span class="va">fit_mle</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">nd</span>,</span>
<span>  mcmc_samples <span class="op">=</span> <span class="va">samps</span>,</span>
<span>  sims_var <span class="op">=</span> <span class="st">"omega_s"</span> <span class="co">#&lt;</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">nd</span><span class="op">$</span><span class="va">spatial_rf_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">fit_pred</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span></span>
<span><span class="va">nd</span><span class="op">$</span><span class="va">spatial_rf_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">fit_pred</span>, <span class="fl">1</span>, <span class="va">sd</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">nd</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, fill <span class="op">=</span> <span class="va">spatial_rf_mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="bayesian_files/figure-html/unnamed-chunk-17-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">nd</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, fill <span class="op">=</span> <span class="va">spatial_rf_sd</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="bayesian_files/figure-html/unnamed-chunk-17-2.png" class="r-plt" width="672"></p>
<!-- As a more complex example, we'll fit a spatial model with a quadratic effect of depth to Pacific cod using a presence-absence response.  -->
<!-- One major difference between this example and the model above is that we also implement penalized complexity (PC) priors on the range and variance of the Matérn correlation (using `sdmTMB::sdmTMBpriors()`).  -->
<!-- Without the prior, the MCMC sampling won't converge (and takes a long time to run). -->
<!-- Evaluating this full model will take some time (400 iterations on 4 chains takes about ~ 10 minutes). For real applications we have to run this on multiple chains, and for lots of iterations.  -->
<!-- As before we can make basic plots with `bayesplot`,    -->
<!-- and extract raw parameter estimates with `rstan::extract()`, -->
<!-- We can also make some diagnostic plots showing the trade-off between different variances. -->
<!-- For example, with the  -->
<!-- The MCMC traces look OK (Rhat < 1.05) but this is also a case where it would be good to compare with more iterations.   -->
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-monnahan2018" class="csl-entry">
Monnahan, C. &amp; Kristensen, K. (2018). <a href="https://doi.org/10.1371/journal.pone.0197954" class="external-link"><span class="nocase">No-U-turn</span> sampling for fast bayesian inference in
<span>ADMB</span> and <span>TMB</span>: Introducing the adnuts and
tmbstan <span class="nocase">R packages</span></a>. <em>PloS one</em>,
<strong>13</strong>.
</div>
<div id="ref-monnahan_2021" class="csl-entry">
Monnahan, C.C., Thorson, J.T., Kotwicki, S., Lauffenburger, N., Ianelli,
J.N. &amp; Punt, A.E. (2021). <a href="https://doi.org/10.1093/icesjms/fsab085" class="external-link">Incorporating vertical
distribution in index standardization accounts for spatiotemporal
availability to acoustic and bottom trawl gear for semi-pelagic
species</a> (O.R. Godo, Ed.). <em>ICES Journal of Marine Science</em>,
<strong>78</strong>, 1826–1839.
</div>
<div id="ref-standev_2021" class="csl-entry">
Stan Development Team. (2021). <span>RStan</span>: The <span>R</span>
interface to <span>Stan</span>. Retrieved from <a href="https://mc-stan.org/" class="external-link">https://mc-stan.org/</a>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sean C. Anderson, Eric J. Ward, Philina A. English, Lewis A. K. Barnett, James T. Thorson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
