<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Forecasting with sdmTMB • sdmTMB</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Forecasting with sdmTMB">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sdmTMB</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.4.9024</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/sdmTMB/sdmTMB/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Forecasting with sdmTMB</h1>
                        <h4 data-toc-skip class="author">Julia Indivero,
Sean Anderson, Lewis Barnett, Philina English, Eric Ward, Jim
Thorson</h4>
            
            <h4 data-toc-skip class="date">2025-11-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/sdmTMB/sdmTMB/blob/main/vignettes/articles/forecasting.Rmd" class="external-link"><code>vignettes/articles/forecasting.Rmd</code></a></small>
      <div class="d-none name"><code>forecasting.Rmd</code></div>
    </div>

    
    
<p>Here we will cover using sdmTMB for forecasting data in time or
extrapolating spatially to unsampled areas. These forecasting approaches
have multiple applications, including,</p>
<ul>
<li>predicting for future years</li>
<li>interpolating over missed years</li>
<li>extrapolating in space to unsampled areas (e.g., an area beyond the
existing domain)</li>
<li>interpolating in space within the existing spatial domain</li>
</ul>
<div class="section level2">
<h2 id="forecasting-predicting-for-future-time-and-interpolating-over-missed-time-slices">Forecasting: predicting for future time and interpolating over
missed time slices<a class="anchor" aria-label="anchor" href="#forecasting-predicting-for-future-time-and-interpolating-over-missed-time-slices"></a>
</h2>
<p>Predicting for future time and interpolating over missed time
requires a similar method, so we will cover them both here. To forecast
in time, either future or missed time, we need a model for time. As an
example, we can’t predict with years as factors below because the model
won’t know what value to assign to years without data.</p>
<p>The options for including time in the model include:</p>
<ul>
<li>AR(1) or random walk random fields</li>
<li>Random walk intercepts</li>
<li>Smoothers on the time variable (e.g., <code>s(year)</code>)</li>
<li>Ignoring time (fixed)</li>
<li>Some combination of these</li>
</ul>
<p>We will use the Pacific cod data to show how to implement each of
these options.</p>
<p>First, we need to make our mesh.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">pcod</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<p>Next, we need to create a list of the years that we want to forecast
or interpolate. The DFO survey in this region only includes years 2003,
2004, 2005, 2007, 2009, 2011, 2013, 2015, and 2017.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">pcod</span></span>
<span><span class="va">years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span></code></pre></div>
<p>To use the model to fill in Pacific cod density for the unsampled
years, we will create a list of the years we want added to fill in from
2003–2017. To predict for future years, we will also add in years for
after the observed data (i.e., after 2017) for however many years we
want to forecast into the future. For this example, we will predict on
years 2018–2025. We will name the vector of extra years
<code>extra_years</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">extra_years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fl">2006</span>, <span class="fl">2008</span>, <span class="fl">2010</span>, <span class="fl">2012</span>, <span class="fl">2014</span>, <span class="fl">2016</span>, <span class="co"># missing years</span></span>
<span>  <span class="fl">2018</span><span class="op">:</span><span class="fl">2025</span> <span class="co"># predicted future years</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Then, we will fit a model of Pacific cod density that includes depth
variables. The argument <code>extra_time</code> in the
<code><a href="../reference/sdmTMB.html">sdmTMB()</a></code> function is how we will add in interpolation and
forecasting. We also will need to set the argument <code>time</code> to
<code>time = "year"</code>.</p>
<p>In this example, we will choose to turn off spatial random fields
(<code>spatial = "off"</code>), so we are only including spatiotemporal
random fields.</p>
<p>We then have different options for including time in the model.</p>
<div class="section level4">
<h4 id="ar1-spatiotemporal-field">AR(1) spatiotemporal field<a class="anchor" aria-label="anchor" href="#ar1-spatiotemporal-field"></a>
</h4>
<p>To include spatiotemporal variation as an AR(1) process, we can
specify <code>spatiotemporal = "AR1"</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_ar1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="va">depth_scaled</span> <span class="op">+</span> <span class="va">depth_scaled2</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  extra_time <span class="op">=</span> <span class="va">extra_years</span>, <span class="co">#&lt;&lt; our list of extra years to be included</span></span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"AR1"</span>, <span class="co">#&lt;&lt; setting an AR(1) spatiotemporal process</span></span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>,</span>
<span>  silent <span class="op">=</span> <span class="cn">FALSE</span> <span class="co">#&lt; monitor progress</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="random-walk-spatiotemporal-field">Random walk spatiotemporal field<a class="anchor" aria-label="anchor" href="#random-walk-spatiotemporal-field"></a>
</h4>
<p>Or, we can set spatiotemporal variation to a random walk with
<code>spatiotemporal = "RW"</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_rw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="va">depth_scaled</span> <span class="op">+</span> <span class="va">depth_scaled2</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  extra_time <span class="op">=</span> <span class="va">extra_years</span>, <span class="co">#&lt;&lt;</span></span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"RW"</span>, <span class="co">#&lt;&lt;</span></span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>,</span>
<span>  silent <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="random-walk-intercept-ar1-fields">Random walk intercept + AR(1) fields<a class="anchor" aria-label="anchor" href="#random-walk-intercept-ar1-fields"></a>
</h4>
<p>We can also model the intercept as a random walk by removing the
intercept from the main formula (adding <code>0</code> to the model
equation) and including the argument <code>time_varying = ~1</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_rw_ar1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">depth_scaled</span> <span class="op">+</span> <span class="va">depth_scaled2</span>, <span class="co">#&lt;&lt; remove intercept with 0</span></span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  time_varying <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>, <span class="co">#&lt;&lt; instead include the intercept here as a random walk</span></span>
<span>  extra_time <span class="op">=</span> <span class="va">extra_years</span>,</span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"AR1"</span>, <span class="co">#&lt;&lt;</span></span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>,</span>
<span>  silent <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="smoother-on-year-ar1-fields">Smoother on year + AR(1) fields<a class="anchor" aria-label="anchor" href="#smoother-on-year-ar1-fields"></a>
</h4>
<p>We can also add a smoother on year as a variable in the model
equation with <code>s(year)</code> in the model equation and keeping
<code>spatiotemporal="AR1"</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_sm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">year</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span> <span class="va">depth_scaled</span> <span class="op">+</span> <span class="va">depth_scaled2</span>, <span class="co">#&lt;&lt; add smoother on year</span></span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  extra_time <span class="op">=</span> <span class="va">extra_years</span>, <span class="co">#&lt;&lt;</span></span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"AR1"</span>, <span class="co">#&lt;&lt;</span></span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>,</span>
<span>  silent <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="deciding-between-methods">Deciding between methods<a class="anchor" aria-label="anchor" href="#deciding-between-methods"></a>
</h4>
<p>In deciding which method (AR(1), RW, etc) to use for including time
in the model, it is important to know that</p>
<ul>
<li>AR(1) field processes revert towards mean</li>
<li>Random walk processes (in the mean or time varying parameters) do
not revert towards the mean</li>
<li>Smoothers should be used with caution, because they continue
whatever the basis functions were doing</li>
<li>Uncertainties in prediction for random walks, AR(1) processes, and
smoothers (here, p-splines) increase the further away we get from
data</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="project-function-for-faster-long-term-forecasting">`project()`` function for faster long-term forecasting<a class="anchor" aria-label="anchor" href="#project-function-for-faster-long-term-forecasting"></a>
</h2>
<p>Because forecasting can be slow—especially for large datasets or for
projections far into the future, sdmTMB also includes a
<code><a href="../reference/project.html">project()</a></code> function for doing projections via simulations.
Using the built-in <code>dogfish</code> dataset, we’ll first define the
years for the historical (fitting) and projection period. This is based
off an approach first developed in the <code>project_model()</code>
function in VAST.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">dogfish</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">historical_years</span> <span class="op">&lt;-</span> <span class="fl">2004</span><span class="op">:</span><span class="fl">2022</span></span>
<span><span class="va">to_project</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">future_years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">historical_years</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">historical_years</span><span class="op">)</span> <span class="op">+</span> <span class="va">to_project</span><span class="op">)</span></span>
<span><span class="va">all_years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">historical_years</span>, <span class="va">future_years</span><span class="op">)</span></span>
<span><span class="va">proj_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/replicate_df.html">replicate_df</a></span><span class="op">(</span><span class="va">wcvi_grid</span>, <span class="st">"year"</span>, <span class="va">all_years</span><span class="op">)</span></span></code></pre></div>
<p>Next, we’ll fit the model. We’ll use an AR(1) spatiotemporal field
that is responsible for future forecasts.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">catch_weight</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">dogfish</span><span class="op">$</span><span class="va">area_swept</span><span class="op">)</span>,</span>
<span>  extra_time <span class="op">=</span> <span class="va">historical_years</span>, <span class="co">#&lt; does *not* include projection years</span></span>
<span>  spatial <span class="op">=</span> <span class="st">"on"</span>,</span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"ar1"</span>,</span>
<span>  data <span class="op">=</span> <span class="va">dogfish</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Finally, we’ll do the projections. We’ll only use 20 draws for speed
and simplicity, but you should increase this for real-world applications
so that you have stable results.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/project.html">project</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">proj_grid</span>, nsim <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<p>The <code>out</code> object now contains two objects:
<code>out$est</code> and <code>out$epsilon_est</code>, each with
dimensions of the number of rows in the prediction data
(<code>proj_grid</code>) (rows) and number of draws for this example (n
= 20) (columns). The first (<code>est</code>) are the predictions (in
link space) and the second (<code>epsilon_est</code>) is the
spatiotemporal random effects. These can be summarized and visualized in
several ways to show trends in both the mean, as well as the confidence
intervals.</p>
<p>For example, here are the projections:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">proj_grid</span><span class="op">$</span><span class="va">est_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">est</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">proj_grid</span>, <span class="va">year</span> <span class="op">&gt;</span> <span class="fl">2022</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, fill <span class="op">=</span> <span class="va">est_mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Projection simulation (mean)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="forecasting_files/figure-html/unnamed-chunk-6-1.png" class="r-plt" width="672"></p>
<p>See the help file <code><a href="../reference/project.html">?sdmTMB::project</a></code> for additional
examples.</p>
</div>
<div class="section level2">
<h2 id="interpolating-in-space-to-unsampled-areas">Interpolating in space to unsampled areas<a class="anchor" aria-label="anchor" href="#interpolating-in-space-to-unsampled-areas"></a>
</h2>
<p>We can also interpolate predicted values to unsampled areas within
the geographic extent of the data. For this example, we will use the
data on the locations of 3605 trees in a 1000 by 500 m rectangular
sampling region from the <a href="https://CRAN.R-project.org/package=spatstat.data" class="external-link">the spatst.data
package</a></p>
<p>First we will create a data frame of the x and y coordinates from the
tree dataset, and we can map the locations:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu">spatstat.data</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/spatstat.data/man/bei.html" class="external-link">bei</a></span><span class="op">$</span><span class="va">x</span>,</span>
<span>  y <span class="op">=</span> <span class="fu">spatstat.data</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/spatstat.data/man/bei.html" class="external-link">bei</a></span><span class="op">$</span><span class="va">y</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"darkblue"</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="forecasting_files/figure-html/bei-1.png" class="r-plt" width="672"></p>
<p>We first re-format the data to create density observations. We
re-scale the x and y coordinates, using the size of the scale value to
control the resolution (i.e., increasing the scale value will decrease
the resolution). Then we can add a column in our data frame of tree
density by adding the number of trees in each location that we created
with the scale function. Then, we create the mesh and can visualize it
by plotting.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># scale controls resolution</span></span>
<span><span class="va">scale</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">scale</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">x</span> <span class="op">/</span> <span class="va">scale</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">scale</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">y</span> <span class="op">/</span> <span class="va">scale</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_mesh.html">make_mesh</a></span><span class="op">(</span></span>
<span>  <span class="va">dat</span>,</span>
<span>  xy_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>,</span>
<span>  cutoff <span class="op">=</span> <span class="fl">80</span> <span class="co"># min. distance between knots in X-Y units</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mesh</span><span class="op">)</span></span></code></pre></div>
<p><img src="forecasting_files/figure-html/bei2-1.png" class="r-plt" width="672"></p>
<p>Then, we can fit the model of tree density, with only an intercept
and only one time slice</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span><span class="va">n</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">dat</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/families.html">truncated_nbinom2</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span><span class="op">)</span></span></code></pre></div>
<p>Next, we can predict to unsampled areas within the geographic extent
of our data. We first expand the grid by adding in x and y coordinates
between existing coordinates in our dataset. Here, we will add in points
at intervals of 5 for x and y. This value controls the resolution of
predicted data. Increasing the value will decrease the resolution of
spatial predictions.</p>
<p>In this example, we include <code>se_fit = TRUE</code> in the predict
function to generate standard errors, though this can slow down
computation time.</p>
<p>We can map the predicted tree density at each of our interpolated
points compared to the locations of our data to see the increased
resolution by forecasting with this method</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># makes all combinations of x and y:</span></span>
<span><span class="va">newdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">newdf</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">p</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">p</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, fill <span class="op">=</span> <span class="va">est</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"tree density"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="forecasting_files/figure-html/pred-fit-1.png" class="r-plt" width="672"></p>
<p>We can also use add the argument <code>nsim = 200</code> when
predicting and then summarize predicted densities from all simulations
in a matrix</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">newdf</span>, nsim <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">newdf</span><span class="op">$</span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">p2</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">newdf</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">newdf</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, fill <span class="op">=</span> <span class="va">p2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"tree density"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="forecasting_files/figure-html/unnamed-chunk-7-1.png" class="r-plt" width="672"></p>
<p>We can also visualize uncertainty in the forecasts by mapping the
standard error of predicted densities at each point in space. We see
that uncertainty is higher at vertices. This is because there are fewer
neighbors, e.g. <a href="https://ourcodingclub.github.io/tutorials/spatial-modelling-inla/" class="external-link">this
tutorial</a></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">newdf</span><span class="op">$</span><span class="va">est_se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">p2</span>, <span class="fl">1</span>, <span class="va">sd</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">newdf</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">est_se</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"Standard error\nof spatiotemporal field"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Ignoring unknown labels:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> <span style="color: #00BB00;">colour</span> : <span style="color: #0000BB;">"Standard error of spatiotemporal field"</span></span></span></code></pre></div>
<p><img src="forecasting_files/figure-html/vis-vert-1.png" class="r-plt" width="672"></p>
<div class="section level4">
<h4 id="extrapolating-outside-the-survey-domain">Extrapolating outside the survey domain<a class="anchor" aria-label="anchor" href="#extrapolating-outside-the-survey-domain"></a>
</h4>
<p>We can also extrapolate spatially to outside of the geographic extent
of the data (ensuring we are not extrapolating outside the extent of our
mesh!) For instance, we can predict into a border area. To do so, we
expand the x and y coordinates to values above and below the extent of
the coordinates in the data. Here, we expand the geographic domain by
100 in all directions, and keep the resolution at 5.</p>
<p>Then, we can use the same model fit to predict to the expanded
geographic domain.</p>
<p><img src="forecasting_files/figure-html/pred-fit2-1.png" class="r-plt" width="672"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sean C. Anderson, Eric J. Ward, Philina A. English, Lewis A. K. Barnett, James T. Thorson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
