<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Area-weighted age composition standardization with sdmTMB • sdmTMB</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Area-weighted age composition standardization with sdmTMB">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sdmTMB</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.4.9024</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/sdmTMB/sdmTMB/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Area-weighted age composition standardization with sdmTMB</h1>
            
            <h4 data-toc-skip class="date">2025-11-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/sdmTMB/sdmTMB/blob/main/vignettes/articles/age-composition.Rmd" class="external-link"><code>vignettes/articles/age-composition.Rmd</code></a></small>
      <div class="d-none name"><code>age-composition.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sdmTMB.github.io/sdmTMB/">sdmTMB</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://inlabru-org.github.io/fmesher/" class="external-link">fmesher</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/get_theme.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This document shows area-weighted age composition expansion with
sdmTMB using simulated data. In other words, we use area-expansion to
calculate proportion-at-age using (potentially) spatially unbalanced
sampling data. Please see Thorson and Haltuch (2018) for further
description.</p>
<p>We will start by simulating some data. This simulation code chunk is
hidden for simplicity.</p>
<p>We can look at the simulated data:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   year         x          y abundance_per_area   age   year_age</span></span>
<span><span class="co">#&gt; 1 2018 0.2875775 0.63918581         0.51004952 age_1 2018_age_1</span></span>
<span><span class="co">#&gt; 2 2018 0.7883051 0.12482240         1.60038328 age_1 2018_age_1</span></span>
<span><span class="co">#&gt; 3 2018 0.4089769 0.25526578         0.00000000 age_1 2018_age_1</span></span>
<span><span class="co">#&gt; 4 2018 0.8830174 0.82057469         0.04387091 age_1 2018_age_1</span></span>
<span><span class="co">#&gt; 5 2018 0.9404673 0.80378039         1.27301974 age_1 2018_age_1</span></span>
<span><span class="co">#&gt; 6 2018 0.0455565 0.04583463         0.86470310 age_1 2018_age_1</span></span></code></pre></div>
<p>We are assuming that these data have already gone “first stage
expansion”. I.e., each subsample has been expanded to represent the
total abundance (or biomass) of the primary sample from which it came.
Although we model abundance per area here, we could alternatively model
abundance with an offset for (log) area. And instead of a Tweedie
distribution, we could use a delta-gamma or delta-lognormal family or
even a Poisson or negative binomial.</p>
<p>Plot the raw simulated data:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">abundance_per_area</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">year</span> <span class="op">~</span> <span class="va">age</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_colour_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"Abundance\nper\narea"</span><span class="op">)</span></span></code></pre></div>
<p><img src="age-composition_files/figure-html/plot_data-1.png" class="r-plt" width="576"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Show data for one year</span></span>
<span><span class="va">data_subset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">year</span> <span class="op">==</span> <span class="fl">2021</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data_subset</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, size <span class="op">=</span> <span class="va">abundance_per_area</span>, colour <span class="op">=</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">age</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Simulated data (2021)"</span>, size <span class="op">=</span> <span class="st">"Abundance per area"</span><span class="op">)</span></span></code></pre></div>
<p><img src="age-composition_files/figure-html/plot_data-2.png" class="r-plt" width="576"></p>
<p>Now we will set up the spatial and spatiotemporal fields with shared
SDs across ages. This could alternatively be set up to have different
spatial SDs by age and/or different spatiotemporal SDs by age.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mesh_sdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use a helper function to set up the model components</span></span>
<span><span class="va">svc_setup</span> <span class="op">&lt;-</span> <span class="fu">sdmTMB</span><span class="fu">::</span><span class="fu"><a href="../reference/make_category_svc.html">make_category_svc</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">data</span>,</span>
<span>  category_column <span class="op">=</span> <span class="st">"age"</span>,</span>
<span>  time_column <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  share_spatial_sd <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># All ages share spatial SD</span></span>
<span>  share_spatiotemporal_sd <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># All age-year combinations share spatiotemporal SD</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This would return information on what just ran:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svc_setup</span><span class="op">$</span><span class="va">info</span></span></code></pre></div>
<p>The important parts are the following.</p>
<p>Our data frame has additional columns for use in the
<code>spatial_varying</code> argument:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">svc_setup</span><span class="op">$</span><span class="va">data_expanded</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "year"                      "x"                        </span></span>
<span><span class="co">#&gt;  [3] "y"                         "abundance_per_area"       </span></span>
<span><span class="co">#&gt;  [5] "age"                       "year_age"                 </span></span>
<span><span class="co">#&gt;  [7] "ageage_1"                  "ageage_2"                 </span></span>
<span><span class="co">#&gt;  [9] "ageage_3"                  "ageage_4"                 </span></span>
<span><span class="co">#&gt; [11] "ageage_5"                  "ageage_6"                 </span></span>
<span><span class="co">#&gt; [13] "factor(year)2018:ageage_1" "factor(year)2019:ageage_1"</span></span>
<span><span class="co">#&gt; [15] "factor(year)2020:ageage_1" "factor(year)2021:ageage_1"</span></span>
<span><span class="co">#&gt; [17] "factor(year)2022:ageage_1" "factor(year)2023:ageage_1"</span></span>
<span><span class="co">#&gt; [19] "factor(year)2024:ageage_1" "factor(year)2025:ageage_1"</span></span>
<span><span class="co">#&gt; [21] "factor(year)2018:ageage_2" "factor(year)2019:ageage_2"</span></span>
<span><span class="co">#&gt; [23] "factor(year)2020:ageage_2" "factor(year)2021:ageage_2"</span></span>
<span><span class="co">#&gt; [25] "factor(year)2022:ageage_2" "factor(year)2023:ageage_2"</span></span>
<span><span class="co">#&gt; [27] "factor(year)2024:ageage_2" "factor(year)2025:ageage_2"</span></span>
<span><span class="co">#&gt; [29] "factor(year)2018:ageage_3" "factor(year)2019:ageage_3"</span></span>
<span><span class="co">#&gt; [31] "factor(year)2020:ageage_3" "factor(year)2021:ageage_3"</span></span>
<span><span class="co">#&gt; [33] "factor(year)2022:ageage_3" "factor(year)2023:ageage_3"</span></span>
<span><span class="co">#&gt; [35] "factor(year)2024:ageage_3" "factor(year)2025:ageage_3"</span></span>
<span><span class="co">#&gt; [37] "factor(year)2018:ageage_4" "factor(year)2019:ageage_4"</span></span>
<span><span class="co">#&gt; [39] "factor(year)2020:ageage_4" "factor(year)2021:ageage_4"</span></span>
<span><span class="co">#&gt; [41] "factor(year)2022:ageage_4" "factor(year)2023:ageage_4"</span></span>
<span><span class="co">#&gt; [43] "factor(year)2024:ageage_4" "factor(year)2025:ageage_4"</span></span>
<span><span class="co">#&gt; [45] "factor(year)2018:ageage_5" "factor(year)2019:ageage_5"</span></span>
<span><span class="co">#&gt; [47] "factor(year)2020:ageage_5" "factor(year)2021:ageage_5"</span></span>
<span><span class="co">#&gt; [49] "factor(year)2022:ageage_5" "factor(year)2023:ageage_5"</span></span>
<span><span class="co">#&gt; [51] "factor(year)2024:ageage_5" "factor(year)2025:ageage_5"</span></span>
<span><span class="co">#&gt; [53] "factor(year)2018:ageage_6" "factor(year)2019:ageage_6"</span></span>
<span><span class="co">#&gt; [55] "factor(year)2020:ageage_6" "factor(year)2021:ageage_6"</span></span>
<span><span class="co">#&gt; [57] "factor(year)2022:ageage_6" "factor(year)2023:ageage_6"</span></span>
<span><span class="co">#&gt; [59] "factor(year)2024:ageage_6" "factor(year)2025:ageage_6"</span></span></code></pre></div>
<p>We have a formula for the <code>spatial_varying</code> argument:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svc_setup</span><span class="op">$</span><span class="va">svc_formula</span></span>
<span><span class="co">#&gt; ~ageage_1 + ageage_2 + ageage_3 + ageage_4 + ageage_5 + ageage_6 + </span></span>
<span><span class="co">#&gt;     `factor(year)2018:ageage_1` + `factor(year)2019:ageage_1` + </span></span>
<span><span class="co">#&gt;     `factor(year)2020:ageage_1` + `factor(year)2021:ageage_1` + </span></span>
<span><span class="co">#&gt;     `factor(year)2022:ageage_1` + `factor(year)2023:ageage_1` + </span></span>
<span><span class="co">#&gt;     `factor(year)2024:ageage_1` + `factor(year)2025:ageage_1` + </span></span>
<span><span class="co">#&gt;     `factor(year)2018:ageage_2` + `factor(year)2019:ageage_2` + </span></span>
<span><span class="co">#&gt;     `factor(year)2020:ageage_2` + `factor(year)2021:ageage_2` + </span></span>
<span><span class="co">#&gt;     `factor(year)2022:ageage_2` + `factor(year)2023:ageage_2` + </span></span>
<span><span class="co">#&gt;     `factor(year)2024:ageage_2` + `factor(year)2025:ageage_2` + </span></span>
<span><span class="co">#&gt;     `factor(year)2018:ageage_3` + `factor(year)2019:ageage_3` + </span></span>
<span><span class="co">#&gt;     `factor(year)2020:ageage_3` + `factor(year)2021:ageage_3` + </span></span>
<span><span class="co">#&gt;     `factor(year)2022:ageage_3` + `factor(year)2023:ageage_3` + </span></span>
<span><span class="co">#&gt;     `factor(year)2024:ageage_3` + `factor(year)2025:ageage_3` + </span></span>
<span><span class="co">#&gt;     `factor(year)2018:ageage_4` + `factor(year)2019:ageage_4` + </span></span>
<span><span class="co">#&gt;     `factor(year)2020:ageage_4` + `factor(year)2021:ageage_4` + </span></span>
<span><span class="co">#&gt;     `factor(year)2022:ageage_4` + `factor(year)2023:ageage_4` + </span></span>
<span><span class="co">#&gt;     `factor(year)2024:ageage_4` + `factor(year)2025:ageage_4` + </span></span>
<span><span class="co">#&gt;     `factor(year)2018:ageage_5` + `factor(year)2019:ageage_5` + </span></span>
<span><span class="co">#&gt;     `factor(year)2020:ageage_5` + `factor(year)2021:ageage_5` + </span></span>
<span><span class="co">#&gt;     `factor(year)2022:ageage_5` + `factor(year)2023:ageage_5` + </span></span>
<span><span class="co">#&gt;     `factor(year)2024:ageage_5` + `factor(year)2025:ageage_5` + </span></span>
<span><span class="co">#&gt;     `factor(year)2018:ageage_6` + `factor(year)2019:ageage_6` + </span></span>
<span><span class="co">#&gt;     `factor(year)2020:ageage_6` + `factor(year)2021:ageage_6` + </span></span>
<span><span class="co">#&gt;     `factor(year)2022:ageage_6` + `factor(year)2023:ageage_6` + </span></span>
<span><span class="co">#&gt;     `factor(year)2024:ageage_6` + `factor(year)2025:ageage_6`</span></span>
<span><span class="co">#&gt; &lt;environment: 0x55601637e880&gt;</span></span></code></pre></div>
<p>And we have a TMB ‘map’ list, which controls which random field SDs
are shared vs. estimated separately. Factor levels that are the same get
shared; those that are different are estimated separately.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svc_setup</span><span class="op">$</span><span class="va">svc_map</span></span>
<span><span class="co">#&gt; $ln_tau_Z</span></span>
<span><span class="co">#&gt;  [1] 1 1 1 1 1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2</span></span>
<span><span class="co">#&gt; [39] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2</span></span>
<span><span class="co">#&gt; Levels: 1 2</span></span></code></pre></div>
<p>Internally, <code>ln_tau_Z</code> is a precision parameter that
affects the SD of the SVC fields.</p>
<p>We’ll set up a control list. The only critical part is the map
argument.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">control_sdmTMB</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMBcontrol.html">sdmTMBcontrol</a></span><span class="op">(</span></span>
<span>  map <span class="op">=</span> <span class="va">svc_setup</span><span class="op">$</span><span class="va">svc_map</span>, <span class="co"># critical part</span></span>
<span>  multiphase <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># often faster here</span></span>
<span>  newton_loops <span class="op">=</span> <span class="fl">0</span>, <span class="co"># for a faster example</span></span>
<span>  profile <span class="op">=</span> <span class="st">"b_j"</span>, <span class="co"># often faster here</span></span>
<span>  getsd <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># skip running sdreport() if desired for speed while testing</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Fit our model:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_sdmTMB</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">abundance_per_area</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">year_age</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh_sdm</span>,</span>
<span>  data <span class="op">=</span> <span class="va">svc_setup</span><span class="op">$</span><span class="va">data_expanded</span>, <span class="co"># Use expanded data</span></span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/families.html">tweedie</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>, <span class="co"># all spatial variation with spatial_varying</span></span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"off"</span>, <span class="co"># all spatiotemporal variation with spatial_varying</span></span>
<span>  spatial_varying <span class="op">=</span> <span class="va">svc_setup</span><span class="op">$</span><span class="va">svc_formula</span>,</span>
<span>  silent <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  control <span class="op">=</span> <span class="va">control_sdmTMB</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Fixing or mirroring `ln_tau_Z`</span></span>
<span><span class="co">#&gt; running TMB sdreport</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sanity.html">sanity</a></span><span class="op">(</span><span class="va">fit_sdmTMB</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Non-linear minimizer suggests successful convergence</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Hessian matrix is positive definite</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> No extreme or very small eigenvalues detected</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> No gradients with respect to fixed effects are &gt;= 0.001</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> No fixed-effect standard errors are NA</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> No standard errors look unreasonably large</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> No sigma parameters are &lt; 0.01</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> No sigma parameters are &gt; 100</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Range parameter doesn't look unreasonably large</span></span>
<span><span class="va">fit_sdmTMB</span></span>
<span><span class="co">#&gt; Spatial model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: abundance_per_area ~ 0 + year_age</span></span>
<span><span class="co">#&gt; Mesh: mesh_sdm (isotropic covariance)</span></span>
<span><span class="co">#&gt; Time column: year</span></span>
<span><span class="co">#&gt; Data: svc_setup$data_expanded</span></span>
<span><span class="co">#&gt; Family: tweedie(link = 'log')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;                    coef.est coef.se</span></span>
<span><span class="co">#&gt; year_age2018_age_1     0.73    0.19</span></span>
<span><span class="co">#&gt; year_age2018_age_2     0.81    0.19</span></span>
<span><span class="co">#&gt; year_age2018_age_3    -0.08    0.20</span></span>
<span><span class="co">#&gt; year_age2018_age_4     0.00    0.20</span></span>
<span><span class="co">#&gt; year_age2018_age_5     0.24    0.20</span></span>
<span><span class="co">#&gt; year_age2018_age_6     0.11    0.20</span></span>
<span><span class="co">#&gt; year_age2019_age_1     0.78    0.19</span></span>
<span><span class="co">#&gt; year_age2019_age_2     0.41    0.19</span></span>
<span><span class="co">#&gt; year_age2019_age_3     0.13    0.20</span></span>
<span><span class="co">#&gt; year_age2019_age_4    -0.01    0.20</span></span>
<span><span class="co">#&gt; year_age2019_age_5     0.13    0.20</span></span>
<span><span class="co">#&gt; year_age2019_age_6    -0.28    0.20</span></span>
<span><span class="co">#&gt; year_age2020_age_1     0.79    0.19</span></span>
<span><span class="co">#&gt; year_age2020_age_2     0.80    0.19</span></span>
<span><span class="co">#&gt; year_age2020_age_3     0.13    0.20</span></span>
<span><span class="co">#&gt; year_age2020_age_4    -0.39    0.21</span></span>
<span><span class="co">#&gt; year_age2020_age_5     0.66    0.19</span></span>
<span><span class="co">#&gt; year_age2020_age_6     0.27    0.20</span></span>
<span><span class="co">#&gt; year_age2021_age_1     0.51    0.19</span></span>
<span><span class="co">#&gt; year_age2021_age_2     0.88    0.19</span></span>
<span><span class="co">#&gt; year_age2021_age_3    -0.17    0.20</span></span>
<span><span class="co">#&gt; year_age2021_age_4     0.29    0.20</span></span>
<span><span class="co">#&gt; year_age2021_age_5     0.10    0.20</span></span>
<span><span class="co">#&gt; year_age2021_age_6    -0.08    0.20</span></span>
<span><span class="co">#&gt; year_age2022_age_1     0.39    0.19</span></span>
<span><span class="co">#&gt; year_age2022_age_2     0.68    0.19</span></span>
<span><span class="co">#&gt; year_age2022_age_3     0.26    0.20</span></span>
<span><span class="co">#&gt; year_age2022_age_4    -0.03    0.20</span></span>
<span><span class="co">#&gt; year_age2022_age_5     0.50    0.19</span></span>
<span><span class="co">#&gt; year_age2022_age_6    -0.47    0.21</span></span>
<span><span class="co">#&gt; year_age2023_age_1     0.69    0.19</span></span>
<span><span class="co">#&gt; year_age2023_age_2     0.55    0.19</span></span>
<span><span class="co">#&gt; year_age2023_age_3     0.40    0.19</span></span>
<span><span class="co">#&gt; year_age2023_age_4     0.40    0.19</span></span>
<span><span class="co">#&gt; year_age2023_age_5     0.22    0.20</span></span>
<span><span class="co">#&gt; year_age2023_age_6     0.12    0.20</span></span>
<span><span class="co">#&gt; year_age2024_age_1     1.32    0.18</span></span>
<span><span class="co">#&gt; year_age2024_age_2     0.19    0.20</span></span>
<span><span class="co">#&gt; year_age2024_age_3     0.06    0.20</span></span>
<span><span class="co">#&gt; year_age2024_age_4    -0.31    0.20</span></span>
<span><span class="co">#&gt; year_age2024_age_5     0.09    0.20</span></span>
<span><span class="co">#&gt; year_age2024_age_6    -0.18    0.20</span></span>
<span><span class="co">#&gt; year_age2025_age_1     0.58    0.19</span></span>
<span><span class="co">#&gt; year_age2025_age_2     0.82    0.19</span></span>
<span><span class="co">#&gt; year_age2025_age_3    -0.39    0.21</span></span>
<span><span class="co">#&gt; year_age2025_age_4    -0.01    0.20</span></span>
<span><span class="co">#&gt; year_age2025_age_5     0.12    0.20</span></span>
<span><span class="co">#&gt; year_age2025_age_6    -0.26    0.20</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 2.99</span></span>
<span><span class="co">#&gt; Tweedie p: 1.60</span></span>
<span><span class="co">#&gt; Matérn range: 0.20</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (ageage_1): 0.47</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (ageage_2): 0.47</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (ageage_3): 0.47</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (ageage_4): 0.47</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (ageage_5): 0.47</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (ageage_6): 0.47</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2018:ageage_1`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2019:ageage_1`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2020:ageage_1`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2021:ageage_1`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2022:ageage_1`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2023:ageage_1`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2024:ageage_1`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2025:ageage_1`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2018:ageage_2`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2019:ageage_2`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2020:ageage_2`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2021:ageage_2`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2022:ageage_2`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2023:ageage_2`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2024:ageage_2`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2025:ageage_2`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2018:ageage_3`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2019:ageage_3`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2020:ageage_3`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2021:ageage_3`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2022:ageage_3`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2023:ageage_3`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2024:ageage_3`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2025:ageage_3`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2018:ageage_4`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2019:ageage_4`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2020:ageage_4`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2021:ageage_4`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2022:ageage_4`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2023:ageage_4`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2024:ageage_4`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2025:ageage_4`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2018:ageage_5`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2019:ageage_5`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2020:ageage_5`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2021:ageage_5`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2022:ageage_5`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2023:ageage_5`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2024:ageage_5`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2025:ageage_5`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2018:ageage_6`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2019:ageage_6`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2020:ageage_6`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2021:ageage_6`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2022:ageage_6`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2023:ageage_6`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2024:ageage_6`): 0.51</span></span>
<span><span class="co">#&gt; Spatially varying coefficient SD (`factor(year)2025:ageage_6`): 0.51</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 17325.664</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
<div class="section level3">
<h3 id="area-expansion">Area expansion<a class="anchor" aria-label="anchor" href="#area-expansion"></a>
</h3>
<p>Now let’s calculate area-weighted abundance indices for each age
class. First, we need to set up our ‘grid’ data frame over which we will
predict. Here we make a simple grid over our 0-1 simulated survey
domain.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create prediction grid on the same 0-1 spatial domain</span></span>
<span><span class="va">n_pred</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">pred_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n_pred</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n_pred</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Each grid cell area (since we're on 0-1 domain)</span></span>
<span><span class="va">cell_area</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">n_pred</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span></span>
<span><span class="co"># Replicate over years and ages</span></span>
<span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/replicate_df.html">replicate_df</a></span><span class="op">(</span><span class="va">pred_grid</span>, <span class="st">"year"</span>, <span class="va">years</span><span class="op">)</span></span>
<span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/replicate_df.html">replicate_df</a></span><span class="op">(</span><span class="va">nd</span>, <span class="st">"age"</span>, <span class="va">ages</span><span class="op">)</span></span>
<span><span class="va">nd</span><span class="op">$</span><span class="va">year_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">nd</span><span class="op">$</span><span class="va">year</span>, <span class="va">nd</span><span class="op">$</span><span class="va">age</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use helper function to add model matrix columns</span></span>
<span><span class="va">nd_setup</span> <span class="op">&lt;-</span> <span class="fu">sdmTMB</span><span class="fu">::</span><span class="fu"><a href="../reference/make_category_svc.html">make_category_svc</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">nd</span>,</span>
<span>  category_column <span class="op">=</span> <span class="st">"age"</span>,</span>
<span>  time_column <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  share_spatial_sd <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  share_spatiotemporal_sd <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Calculate indices for each age:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ind_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">ages</span>, <span class="kw">function</span><span class="op">(</span><span class="va">age</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Calculating index for age:"</span>, <span class="va">age</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Subset prediction data for this age</span></span>
<span>  <span class="va">nd_age</span> <span class="op">&lt;-</span> <span class="va">nd_setup</span><span class="op">$</span><span class="va">data_expanded</span><span class="op">[</span><span class="va">nd_setup</span><span class="op">$</span><span class="va">data_expanded</span><span class="op">$</span><span class="va">age</span> <span class="op">==</span> <span class="va">age</span>, <span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Get predictions</span></span>
<span>  <span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_sdmTMB</span>, newdata <span class="op">=</span> <span class="va">nd_age</span>, return_tmb_object <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Calculate area-weighted index</span></span>
<span>  <span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_index.html">get_index</a></span><span class="op">(</span><span class="va">pred</span>, area <span class="op">=</span> <span class="va">cell_area</span>, bias_correct <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">ind</span>, age <span class="op">=</span> <span class="va">age</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">ind_list</span><span class="op">)</span></span></code></pre></div>
<p>Plot abundance indices by age:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">ind</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">est</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lwr</span>, ymax <span class="op">=</span> <span class="va">upr</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">age</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html" class="external-link">expansion</a></span><span class="op">(</span>mult <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Abundance index"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Age-specific abundance indices"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="age-composition_files/figure-html/plot_indices-1.png" class="r-plt" width="576"></p>
</div>
<div class="section level3">
<h3 id="convert-to-age-composition-proportions">Convert to age composition (proportions)<a class="anchor" aria-label="anchor" href="#convert-to-age-composition-proportions"></a>
</h3>
<p>Convert the abundance indices to proportions-at-age:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ind_props</span> <span class="op">&lt;-</span> <span class="va">ind</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span>,</span>
<span>    proportion <span class="op">=</span> <span class="va">est</span> <span class="op">/</span> <span class="va">total</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Plot age composition:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">ind_props</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">proportion</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">age</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">ages</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_area</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"stack"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Proportion"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Age"</span>,</span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="age-composition_files/figure-html/plot_age_composition-1.png" class="r-plt" width="576"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">ind_props</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">proportion</span>, colour <span class="op">=</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Proportion"</span>,</span>
<span>    colour <span class="op">=</span> <span class="st">"Age"</span>,</span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="age-composition_files/figure-html/plot_age_composition-2.png" class="r-plt" width="576"></p>
</div>
<div class="section level3">
<h3 id="calculate-effective-sample-sizes">Calculate effective sample sizes<a class="anchor" aria-label="anchor" href="#calculate-effective-sample-sizes"></a>
</h3>
<p>Here we’ll calculate effective sample sizes for the age composition,
following the method from VAST (Thorson 2019) as described in Thorson
and Haltuch (2018).</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to calculate effective sample sizes from index estimates</span></span>
<span><span class="co"># This may be folded into sdmTMB eventually</span></span>
<span><span class="va">get_comp_neff</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">index_df</span>, <span class="va">time_column</span> <span class="op">=</span> <span class="st">"year"</span>, <span class="va">bin_column</span> <span class="op">=</span> <span class="st">"age"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Get unique years and ages in original order</span></span>
<span>  <span class="va">years_unique</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[[</span><span class="va">time_column</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">bins_unique</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[[</span><span class="va">bin_column</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">nyrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">years_unique</span><span class="op">)</span></span>
<span>  <span class="va">nbins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">bins_unique</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Reshape estimates and SEs to matrices (bins x years)</span></span>
<span>  <span class="va">est_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">index_df</span><span class="op">$</span><span class="va">est</span>, nrow <span class="op">=</span> <span class="va">nyrs</span>, ncol <span class="op">=</span> <span class="va">nbins</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">se_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">index_df</span><span class="op">$</span><span class="va">se_natural</span>, nrow <span class="op">=</span> <span class="va">nyrs</span>, ncol <span class="op">=</span> <span class="va">nbins</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Calculate total abundance and SE by year</span></span>
<span>  <span class="va">total_by_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">est_mat</span><span class="op">)</span></span>
<span>  <span class="va">total_se_by_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">se_mat</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Calculate proportions</span></span>
<span>  <span class="va">prop_mat</span> <span class="op">&lt;-</span> <span class="va">est_mat</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">total_by_year</span>, each <span class="op">=</span> <span class="va">nbins</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Calculate proportion variance and effective sample sizes using delta method</span></span>
<span>  <span class="va">var_prop_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">nbins</span>, ncol <span class="op">=</span> <span class="va">nyrs</span><span class="op">)</span></span>
<span>  <span class="va">neff_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">nbins</span>, ncol <span class="op">=</span> <span class="va">nyrs</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nbins</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nyrs</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">est_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">var_prop_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">est_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">total_by_year</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span></span>
<span>          <span class="op">(</span><span class="va">se_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">est_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span></span>
<span>            <span class="fl">2</span> <span class="op">*</span> <span class="va">se_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="op">(</span><span class="va">est_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">*</span> <span class="va">total_by_year</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="va">total_se_by_year</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">total_by_year</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>        <span class="va">neff_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">prop_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">prop_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">var_prop_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">var_prop_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>        <span class="va">neff_mat</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Calculate median Neff by year</span></span>
<span>  <span class="va">neff_median</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">neff_mat</span>, <span class="fl">2</span>, <span class="va">median</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Convert to data frame</span></span>
<span>  <span class="va">bin_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nbins</span>, <span class="va">nyrs</span><span class="op">)</span></span>
<span>  <span class="va">year_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nyrs</span>, each <span class="op">=</span> <span class="va">nbins</span><span class="op">)</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    prop_se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">var_prop_mat</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">prop_mat</span><span class="op">)</span>,</span>
<span>    neff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">neff_mat</span><span class="op">)</span>,</span>
<span>    neff_median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">neff_median</span>, each <span class="op">=</span> <span class="va">nbins</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Add year and bin columns</span></span>
<span>  <span class="va">result</span><span class="op">[[</span><span class="va">time_column</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">years_unique</span><span class="op">[</span><span class="va">year_indices</span><span class="op">]</span></span>
<span>  <span class="va">result</span><span class="op">[[</span><span class="va">bin_column</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">bins_unique</span><span class="op">[</span><span class="va">bin_indices</span><span class="op">]</span></span>
<span>  <span class="va">result</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Calculate effective sample sizes</span></span>
<span><span class="va">neff_results</span> <span class="op">&lt;-</span> <span class="fu">get_comp_neff</span><span class="op">(</span><span class="va">data</span>, <span class="va">ind</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">neff_results</span><span class="op">)</span></span>
<span><span class="co">#&gt;      prop_se      prop      neff neff_median year   age</span></span>
<span><span class="co">#&gt; 1 0.18427485 0.2419754  5.401600    8.519126 2018 age_1</span></span>
<span><span class="co">#&gt; 2 0.19090118 0.2575352  5.246810    8.519126 2018 age_2</span></span>
<span><span class="co">#&gt; 3 0.09922406 0.1119492 10.097755    8.519126 2018 age_3</span></span>
<span><span class="co">#&gt; 4 0.10186871 0.1156016  9.852132    8.519126 2018 age_4</span></span>
<span><span class="co">#&gt; 5 0.12500528 0.1462638  7.991050    8.519126 2018 age_5</span></span>
<span><span class="co">#&gt; 6 0.11057981 0.1266747  9.047203    8.519126 2018 age_6</span></span></code></pre></div>
<p>Plot effective sample sizes:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">neff_results</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">neff</span>, colour <span class="op">=</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Effective sample size"</span>,</span>
<span>    colour <span class="op">=</span> <span class="st">"Age"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Effective sample sizes by age"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="age-composition_files/figure-html/plot_neff-1.png" class="r-plt" width="576"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Plot median effective sample size across ages</span></span>
<span><span class="va">neff_median</span> <span class="op">&lt;-</span> <span class="va">neff_results</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">neff_median</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">neff_median</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">neff_median</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Median effective sample size"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Median effective sample size across ages"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="age-composition_files/figure-html/plot_neff-2.png" class="r-plt" width="576"></p>
</div>
<div class="section level2">
<h2 id="troubleshooting-and-advanced-options">Troubleshooting and advanced options<a class="anchor" aria-label="anchor" href="#troubleshooting-and-advanced-options"></a>
</h2>
<p>The previous example assumed shared spatial and spatiotemporal SDs
across ages. However, there are several common scenarios where you might
want to modify this behaviour or handle challenging data structures.</p>
<div class="section level3">
<h3 id="sdmtmb-vs--tinyvast-for-age-composition-models">sdmTMB vs. tinyVAST for age composition models<a class="anchor" aria-label="anchor" href="#sdmtmb-vs--tinyvast-for-age-composition-models"></a>
</h3>
<p>If you want independent spatial/spatiotemporal fields across ages (as
shown in the examples here), you can fit identical models with either
sdmTMB or tinyVAST. The choice doesn’t matter functionally. However, if
you want correlation between the age-specific spatial fields, you’ll
need to use tinyVAST. Most published applications, including the
approach described by Thorson and Haltuch (2018), use independent fields
across ages. Also, if you want to have different levels of observation
error by age, you’ll need to use tinyVAST. There is a branch that has
this in sdmTMB, but it hasn’t been merged into main yet.</p>
</div>
<div class="section level3">
<h3 id="different-spatialspatiotemporal-sds-by-age">Different spatial/spatiotemporal SDs by age<a class="anchor" aria-label="anchor" href="#different-spatialspatiotemporal-sds-by-age"></a>
</h3>
<p>If you expect different magnitude of spatial or spatiotemporal
variation by age, you can specify independent SDs for each age. This
will be harder to estimate.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set up model with independent spatial and spatiotemporal SDs for each age</span></span>
<span><span class="va">svc_setup_independent</span> <span class="op">&lt;-</span> <span class="fu">sdmTMB</span><span class="fu">::</span><span class="fu"><a href="../reference/make_category_svc.html">make_category_svc</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">data</span>,</span>
<span>  category_column <span class="op">=</span> <span class="st">"age"</span>,</span>
<span>  time_column <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  share_spatial_sd <span class="op">=</span> <span class="cn">FALSE</span>,      <span class="co"># Each age has its own spatial SD</span></span>
<span>  share_spatiotemporal_sd <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># Each age has its own spatiotemporal SD</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now there's one factor level for each field</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">svc_setup_independent</span><span class="op">$</span><span class="va">svc_map</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Then fit the model as before with the new 'map'</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="selective-sharing-of-spatial-sds">Selective sharing of spatial SDs<a class="anchor" aria-label="anchor" href="#selective-sharing-of-spatial-sds"></a>
</h3>
<p>Sometimes you may want some ages to share SDs while others are kept
independent. You can manually manipulate the map after creating it with
the helper function. Here we will share all spatiotemporal SDs but share
only some of the spatial SDs.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Start with independent SDs using the helper function</span></span>
<span><span class="va">svc_setup_selective</span> <span class="op">&lt;-</span> <span class="fu">sdmTMB</span><span class="fu">::</span><span class="fu"><a href="../reference/make_category_svc.html">make_category_svc</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">data</span>,</span>
<span>  category_column <span class="op">=</span> <span class="st">"age"</span>,</span>
<span>  time_column <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  share_spatial_sd <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  share_spatiotemporal_sd <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Look at the original map structure</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">svc_setup_selective</span><span class="op">$</span><span class="va">svc_map</span><span class="op">)</span></span>
<span><span class="co">#&gt; $ln_tau_Z</span></span>
<span><span class="co">#&gt;  [1] 1 2 3 4 5 6 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7</span></span>
<span><span class="co">#&gt; [39] 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7</span></span>
<span><span class="co">#&gt; Levels: 1 2 3 4 5 6 7</span></span></code></pre></div>
<p>Look at the order of the fields in the column names.
<code>ageage1</code> through <code>ageage_6</code> are the spatial
fields. Then the rest are the spatiotemporal fields.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">svc_setup_selective</span><span class="op">$</span><span class="va">data_expanded</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "year"                      "x"                        </span></span>
<span><span class="co">#&gt;  [3] "y"                         "abundance_per_area"       </span></span>
<span><span class="co">#&gt;  [5] "age"                       "year_age"                 </span></span>
<span><span class="co">#&gt;  [7] "ageage_1"                  "ageage_2"                 </span></span>
<span><span class="co">#&gt;  [9] "ageage_3"                  "ageage_4"                 </span></span>
<span><span class="co">#&gt; [11] "ageage_5"                  "ageage_6"                 </span></span>
<span><span class="co">#&gt; [13] "factor(year)2018:ageage_1" "factor(year)2019:ageage_1"</span></span>
<span><span class="co">#&gt; [15] "factor(year)2020:ageage_1" "factor(year)2021:ageage_1"</span></span>
<span><span class="co">#&gt; [17] "factor(year)2022:ageage_1" "factor(year)2023:ageage_1"</span></span>
<span><span class="co">#&gt; [19] "factor(year)2024:ageage_1" "factor(year)2025:ageage_1"</span></span>
<span><span class="co">#&gt; [21] "factor(year)2018:ageage_2" "factor(year)2019:ageage_2"</span></span>
<span><span class="co">#&gt; [23] "factor(year)2020:ageage_2" "factor(year)2021:ageage_2"</span></span>
<span><span class="co">#&gt; [25] "factor(year)2022:ageage_2" "factor(year)2023:ageage_2"</span></span>
<span><span class="co">#&gt; [27] "factor(year)2024:ageage_2" "factor(year)2025:ageage_2"</span></span>
<span><span class="co">#&gt; [29] "factor(year)2018:ageage_3" "factor(year)2019:ageage_3"</span></span>
<span><span class="co">#&gt; [31] "factor(year)2020:ageage_3" "factor(year)2021:ageage_3"</span></span>
<span><span class="co">#&gt; [33] "factor(year)2022:ageage_3" "factor(year)2023:ageage_3"</span></span>
<span><span class="co">#&gt; [35] "factor(year)2024:ageage_3" "factor(year)2025:ageage_3"</span></span>
<span><span class="co">#&gt; [37] "factor(year)2018:ageage_4" "factor(year)2019:ageage_4"</span></span>
<span><span class="co">#&gt; [39] "factor(year)2020:ageage_4" "factor(year)2021:ageage_4"</span></span>
<span><span class="co">#&gt; [41] "factor(year)2022:ageage_4" "factor(year)2023:ageage_4"</span></span>
<span><span class="co">#&gt; [43] "factor(year)2024:ageage_4" "factor(year)2025:ageage_4"</span></span>
<span><span class="co">#&gt; [45] "factor(year)2018:ageage_5" "factor(year)2019:ageage_5"</span></span>
<span><span class="co">#&gt; [47] "factor(year)2020:ageage_5" "factor(year)2021:ageage_5"</span></span>
<span><span class="co">#&gt; [49] "factor(year)2022:ageage_5" "factor(year)2023:ageage_5"</span></span>
<span><span class="co">#&gt; [51] "factor(year)2024:ageage_5" "factor(year)2025:ageage_5"</span></span>
<span><span class="co">#&gt; [53] "factor(year)2018:ageage_6" "factor(year)2019:ageage_6"</span></span>
<span><span class="co">#&gt; [55] "factor(year)2020:ageage_6" "factor(year)2021:ageage_6"</span></span>
<span><span class="co">#&gt; [57] "factor(year)2022:ageage_6" "factor(year)2023:ageage_6"</span></span>
<span><span class="co">#&gt; [59] "factor(year)2024:ageage_6" "factor(year)2025:ageage_6"</span></span></code></pre></div>
<p>Manually modify the map to share SDs between some ages. For example,
share spatial SDs between ages 1-4, but keep 5-6 independent:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modified_map</span> <span class="op">&lt;-</span> <span class="va">svc_setup_selective</span><span class="op">$</span><span class="va">svc_map</span></span>
<span></span>
<span><span class="va">modified_map</span><span class="op">$</span><span class="va">ln_tau_Z</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get rid of empty factor levels:</span></span>
<span><span class="va">modified_map</span><span class="op">$</span><span class="va">ln_tau_Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="va">modified_map</span><span class="op">$</span><span class="va">ln_tau_Z</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">modified_map</span><span class="op">$</span><span class="va">ln_tau_Z</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 1 1 1 1 5 6 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7</span></span>
<span><span class="co">#&gt; [39] 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7</span></span>
<span><span class="co">#&gt; Levels: 1 5 6 7</span></span>
<span></span>
<span><span class="co"># Now use the modified map in the model</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fixing-spatial-sds-to-zero-turning-off-spatial-variation">Fixing spatial SDs to zero (turning off spatial variation)<a class="anchor" aria-label="anchor" href="#fixing-spatial-sds-to-zero-turning-off-spatial-variation"></a>
</h3>
<p>If some ages have spatial or spatiotemporal SDs that want to collapse
to zero or you want to turn off spatial variation for specific ages, you
can map the corresponding <code>ln_tau_Z</code> elements to
<code>factor(NA)</code> and set their starting values to a large
value.</p>
<p>Among other times, this will be necessary if you have empty
categories (age-year combinations) and separate spatiotemporal SDs by
age.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set up independent SDs first using the helper function</span></span>
<span><span class="va">svc_setup_fixed</span> <span class="op">&lt;-</span> <span class="fu">sdmTMB</span><span class="fu">::</span><span class="fu"><a href="../reference/make_category_svc.html">make_category_svc</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">data</span>,</span>
<span>  category_column <span class="op">=</span> <span class="st">"age"</span>,</span>
<span>  time_column <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  share_spatial_sd <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  share_spatiotemporal_sd <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create map and starting values to fix some SDs to effectively zero</span></span>
<span><span class="co"># Suppose we want to turn off spatial variation for ages 5 and 6</span></span>
<span><span class="va">modified_map_fixed</span> <span class="op">&lt;-</span> <span class="va">svc_setup_fixed</span><span class="op">$</span><span class="va">svc_map</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">modified_map_fixed</span><span class="op">)</span></span>
<span><span class="co">#&gt; $ln_tau_Z</span></span>
<span><span class="co">#&gt;  [1] 1 2 3 4 5 6 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7</span></span>
<span><span class="co">#&gt; [39] 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7</span></span>
<span><span class="co">#&gt; Levels: 1 2 3 4 5 6 7</span></span>
<span></span>
<span><span class="va">modified_map_fixed</span><span class="op">$</span><span class="va">ln_tau_Z</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span></span>
<span><span class="va">modified_map_fixed</span><span class="op">$</span><span class="va">ln_tau_Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="va">modified_map_fixed</span><span class="op">$</span><span class="va">ln_tau_Z</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">modified_map_fixed</span><span class="op">)</span></span>
<span><span class="co">#&gt; $ln_tau_Z</span></span>
<span><span class="co">#&gt;  [1] 1    2    3    4    &lt;NA&gt; &lt;NA&gt; 7    7    7    7    7    7    7    7    7   </span></span>
<span><span class="co">#&gt; [16] 7    7    7    7    7    7    7    7    7    7    7    7    7    7    7   </span></span>
<span><span class="co">#&gt; [31] 7    7    7    7    7    7    7    7    7    7    7    7    7    7    7   </span></span>
<span><span class="co">#&gt; [46] 7    7    7    7    7    7    7    7    7   </span></span>
<span><span class="co">#&gt; Levels: 1 2 3 4 7</span></span>
<span></span>
<span><span class="co"># Set starting ln_tau_Z values to large for fixed parameters to imply</span></span>
<span><span class="co"># a near zero marginal SD</span></span>
<span><span class="co"># sdmTMB is expecting a matrix here</span></span>
<span><span class="co"># for a 'delta' model, sdmTMB would be expecting a 2 column matrix</span></span>
<span><span class="co"># we can check this with:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fit_sdmTMB</span><span class="op">$</span><span class="va">tmb_params</span><span class="op">$</span><span class="va">ln_tau_Z</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1]</span></span>
<span><span class="co">#&gt; [1,]    0</span></span>
<span><span class="co">#&gt; [2,]    0</span></span>
<span><span class="co">#&gt; [3,]    0</span></span>
<span><span class="co">#&gt; [4,]    0</span></span>
<span><span class="co">#&gt; [5,]    0</span></span>
<span><span class="co">#&gt; [6,]    0</span></span>
<span></span>
<span><span class="co"># all 0s as default:</span></span>
<span><span class="va">ln_tau_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, ncol <span class="op">=</span> <span class="fl">1</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">modified_map_fixed</span><span class="op">$</span><span class="va">ln_tau_Z</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># find the correct index:</span></span>
<span><span class="va">cn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">svc_setup</span><span class="op">$</span><span class="va">data_expanded</span><span class="op">)</span></span>
<span><span class="va">cn</span><span class="op">[</span><span class="fl">7</span><span class="op">:</span><span class="fl">60</span><span class="op">]</span></span>
<span><span class="co">#&gt;  [1] "ageage_1"                  "ageage_2"                 </span></span>
<span><span class="co">#&gt;  [3] "ageage_3"                  "ageage_4"                 </span></span>
<span><span class="co">#&gt;  [5] "ageage_5"                  "ageage_6"                 </span></span>
<span><span class="co">#&gt;  [7] "factor(year)2018:ageage_1" "factor(year)2019:ageage_1"</span></span>
<span><span class="co">#&gt;  [9] "factor(year)2020:ageage_1" "factor(year)2021:ageage_1"</span></span>
<span><span class="co">#&gt; [11] "factor(year)2022:ageage_1" "factor(year)2023:ageage_1"</span></span>
<span><span class="co">#&gt; [13] "factor(year)2024:ageage_1" "factor(year)2025:ageage_1"</span></span>
<span><span class="co">#&gt; [15] "factor(year)2018:ageage_2" "factor(year)2019:ageage_2"</span></span>
<span><span class="co">#&gt; [17] "factor(year)2020:ageage_2" "factor(year)2021:ageage_2"</span></span>
<span><span class="co">#&gt; [19] "factor(year)2022:ageage_2" "factor(year)2023:ageage_2"</span></span>
<span><span class="co">#&gt; [21] "factor(year)2024:ageage_2" "factor(year)2025:ageage_2"</span></span>
<span><span class="co">#&gt; [23] "factor(year)2018:ageage_3" "factor(year)2019:ageage_3"</span></span>
<span><span class="co">#&gt; [25] "factor(year)2020:ageage_3" "factor(year)2021:ageage_3"</span></span>
<span><span class="co">#&gt; [27] "factor(year)2022:ageage_3" "factor(year)2023:ageage_3"</span></span>
<span><span class="co">#&gt; [29] "factor(year)2024:ageage_3" "factor(year)2025:ageage_3"</span></span>
<span><span class="co">#&gt; [31] "factor(year)2018:ageage_4" "factor(year)2019:ageage_4"</span></span>
<span><span class="co">#&gt; [33] "factor(year)2020:ageage_4" "factor(year)2021:ageage_4"</span></span>
<span><span class="co">#&gt; [35] "factor(year)2022:ageage_4" "factor(year)2023:ageage_4"</span></span>
<span><span class="co">#&gt; [37] "factor(year)2024:ageage_4" "factor(year)2025:ageage_4"</span></span>
<span><span class="co">#&gt; [39] "factor(year)2018:ageage_5" "factor(year)2019:ageage_5"</span></span>
<span><span class="co">#&gt; [41] "factor(year)2020:ageage_5" "factor(year)2021:ageage_5"</span></span>
<span><span class="co">#&gt; [43] "factor(year)2022:ageage_5" "factor(year)2023:ageage_5"</span></span>
<span><span class="co">#&gt; [45] "factor(year)2024:ageage_5" "factor(year)2025:ageage_5"</span></span>
<span><span class="co">#&gt; [47] "factor(year)2018:ageage_6" "factor(year)2019:ageage_6"</span></span>
<span><span class="co">#&gt; [49] "factor(year)2020:ageage_6" "factor(year)2021:ageage_6"</span></span>
<span><span class="co">#&gt; [51] "factor(year)2022:ageage_6" "factor(year)2023:ageage_6"</span></span>
<span><span class="co">#&gt; [53] "factor(year)2024:ageage_6" "factor(year)2025:ageage_6"</span></span>
<span></span>
<span><span class="co"># large value means a very small marginal field SD for age 5 and 6 spatial fields here:</span></span>
<span><span class="va">ln_tau_start</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="fl">6</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ln_tau_start</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1]</span></span>
<span><span class="co">#&gt; [1,]    0</span></span>
<span><span class="co">#&gt; [2,]    0</span></span>
<span><span class="co">#&gt; [3,]    0</span></span>
<span><span class="co">#&gt; [4,]    0</span></span>
<span><span class="co">#&gt; [5,]   10</span></span>
<span><span class="co">#&gt; [6,]   10</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_fixed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">abundance_per_area</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">year_age</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh_sdm</span>,</span>
<span>  data <span class="op">=</span> <span class="va">svc_setup_fixed</span><span class="op">$</span><span class="va">data_expanded</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/families.html">tweedie</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span>,</span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"off"</span>,</span>
<span>  spatial_varying <span class="op">=</span> <span class="va">svc_setup_fixed</span><span class="op">$</span><span class="va">svc_formula</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="../reference/sdmTMBcontrol.html">sdmTMBcontrol</a></span><span class="op">(</span></span>
<span>    map <span class="op">=</span> <span class="va">modified_map_fixed</span>, <span class="co">#&lt; new</span></span>
<span>    start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ln_tau_Z <span class="op">=</span> <span class="va">ln_tau_start</span><span class="op">)</span> <span class="co">#&lt; new</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>You can then ignore the warning from <code><a href="../reference/sanity.html">sanity()</a></code> about
<code>sigma_Z</code> being less than 0.01; we’ve set it up that way on
purpose! Do check the output of <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> though to make
sure <em>other</em> spatially varying SDs haven’t collapsed.</p>
</div>
<div class="section level3">
<h3 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<p>Thorson, J.T., and Haltuch, M.A. 2018. Spatio-temporal analysis of
compositional data: increased precision and improved workflow using
model-based inputs to stock assessment. Can. J. Fish. Aquat. Sci. <a href="doi:10.1139/cjfas-2018-0015" class="uri">doi:10.1139/cjfas-2018-0015</a>.</p>
<p>Thorson, J.T. 2019. Guidance for decisions using the Vector
Autoregressive Spatio-Temporal (VAST) package in stock, ecosystem,
habitat and climate assessments. Fisheries Research 210: 143–161. <a href="doi:10.1016/j.fishres.2018.10.013" class="uri">doi:10.1016/j.fishres.2018.10.013</a>.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sean C. Anderson, Eric J. Ward, Philina A. English, Lewis A. K. Barnett, James T. Thorson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
