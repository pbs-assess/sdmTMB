<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction to modelling with sdmTMB • sdmTMB</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to modelling with sdmTMB">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sdmTMB</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.4.9024</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/sdmTMB/sdmTMB/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Introduction to modelling with sdmTMB</h1>
            
            <h4 data-toc-skip class="date">2025-11-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/sdmTMB/sdmTMB/blob/main/vignettes/articles/basic-intro.Rmd" class="external-link"><code>vignettes/articles/basic-intro.Rmd</code></a></small>
      <div class="d-none name"><code>basic-intro.Rmd</code></div>
    </div>

    
    
<p><strong>If the code in this vignette has not been evaluated, a
rendered version is available on the <a href="https://sdmTMB.github.io/sdmTMB/index.html">documentation site</a>
under ‘Articles’.</strong></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sdmTMB.github.io/sdmTMB/">sdmTMB</a></span><span class="op">)</span></span></code></pre></div>
<p>In this vignette, we describe the basic steps to fitting a spatial or
spatiotemporal GLMM with sdmTMB. The goal is to show how to (i) build a
mesh that captures spatial structure, (ii) fit increasingly rich models
(GLM → spatial → spatiotemporal), (iii) interpret coefficients and
random fields, and (iv) check predictions/uncertainty. These models are
useful for (dynamic, i.e. changing through time) species distribution
models and relative abundance index standardization among many other
uses. See the <a href="https://sdmTMB.github.io/sdmTMB/articles/model-description.html">model
description</a> for full model structure and equations.</p>
<p>We will use built-in package data for Pacific Cod from a fisheries
independent trawl survey (kg caught, swept area, and tow time).</p>
<ul>
<li>Density is in kg/km<sup>2</sup> (biomass standardization using swept
area and tow duration).</li>
<li>X and Y are coordinates in UTM zone 9. We could add these to a new
dataset with <code><a href="../reference/add_utm_columns.html">sdmTMB::add_utm_columns()</a></code>.</li>
<li>Depth was centered and scaled by its standard deviation so that
coefficient sizes weren’t too big or small.</li>
<li>There are columns for depth (<code>depth_scaled</code>) and depth
squared (<code>depth_scaled2</code>).</li>
</ul>
<p>Before fitting, it helps to see the raw data we’re fitting to:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pcod</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, col <span class="op">=</span> <span class="va">density</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_colour_viridis_c</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"sqrt"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"Density"</span>, title <span class="op">=</span> <span class="st">"Observed survey tows"</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic-intro_files/figure-html/plot-pcod-raw-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 2,143</span></span>
<span><span class="co">#&gt; Columns: 12</span></span>
<span><span class="co">#&gt; $ year          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 2003<span style="color: #949494;">, </span>2003<span style="color: #949494;">, </span>2003<span style="color: #949494;">, </span>2003<span style="color: #949494;">, </span>2003<span style="color: #949494;">, </span>2003<span style="color: #949494;">, </span>2003<span style="color: #949494;">, </span>2003<span style="color: #949494;">, </span>2003<span style="color: #949494;">, </span>20…</span></span>
<span><span class="co">#&gt; $ X             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 446.4752<span style="color: #949494;">, </span>446.4594<span style="color: #949494;">, </span>448.5987<span style="color: #949494;">, </span>436.9157<span style="color: #949494;">, </span>420.6101<span style="color: #949494;">, </span>417.71…</span></span>
<span><span class="co">#&gt; $ Y             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 5793.426<span style="color: #949494;">, </span>5800.136<span style="color: #949494;">, </span>5801.687<span style="color: #949494;">, </span>5802.305<span style="color: #949494;">, </span>5771.055<span style="color: #949494;">, </span>5772.2…</span></span>
<span><span class="co">#&gt; $ depth         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 201<span style="color: #949494;">, </span>212<span style="color: #949494;">, </span>220<span style="color: #949494;">, </span>197<span style="color: #949494;">, </span>256<span style="color: #949494;">, </span>293<span style="color: #949494;">, </span>410<span style="color: #949494;">, </span>387<span style="color: #949494;">, </span>285<span style="color: #949494;">, </span>270<span style="color: #949494;">, </span>381<span style="color: #949494;">, </span>1…</span></span>
<span><span class="co">#&gt; $ density       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 113.138476<span style="color: #949494;">, </span>41.704922<span style="color: #949494;">, </span>0.000000<span style="color: #949494;">, </span>15.706138<span style="color: #949494;">, </span>0.000000<span style="color: #949494;">, </span>0.…</span></span>
<span><span class="co">#&gt; $ present       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">, </span>0<span style="color: #949494;">,</span>…</span></span>
<span><span class="co">#&gt; $ lat           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 52.28858<span style="color: #949494;">, </span>52.34890<span style="color: #949494;">, </span>52.36305<span style="color: #949494;">, </span>52.36738<span style="color: #949494;">, </span>52.08437<span style="color: #949494;">, </span>52.094…</span></span>
<span><span class="co">#&gt; $ lon           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -129.7847<span style="color: #949494;">, </span>-129.7860<span style="color: #949494;">, </span>-129.7549<span style="color: #949494;">, </span>-129.9265<span style="color: #949494;">, </span>-130.1586<span style="color: #949494;">, </span>-…</span></span>
<span><span class="co">#&gt; $ depth_mean    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 5.155194<span style="color: #949494;">, </span>5.155194<span style="color: #949494;">, </span>5.155194<span style="color: #949494;">, </span>5.155194<span style="color: #949494;">, </span>5.155194<span style="color: #949494;">, </span>5.1551…</span></span>
<span><span class="co">#&gt; $ depth_sd      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.4448783<span style="color: #949494;">, </span>0.4448783<span style="color: #949494;">, </span>0.4448783<span style="color: #949494;">, </span>0.4448783<span style="color: #949494;">, </span>0.4448783<span style="color: #949494;">, </span>0…</span></span>
<span><span class="co">#&gt; $ depth_scaled  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.3329252<span style="color: #949494;">, </span>0.4526914<span style="color: #949494;">, </span>0.5359529<span style="color: #949494;">, </span>0.2877417<span style="color: #949494;">, </span>0.8766077<span style="color: #949494;">, </span>1…</span></span>
<span><span class="co">#&gt; $ depth_scaled2 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.11083919<span style="color: #949494;">, </span>0.20492947<span style="color: #949494;">, </span>0.28724555<span style="color: #949494;">, </span>0.08279527<span style="color: #949494;">, </span>0.768440…</span></span></code></pre></div>
<p>The most basic model structure possible in sdmTMB replicates a GLM as
can be fit with <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code> or a GLMM as can be fit with lme4 or
glmmTMB, for example. The spatial components in sdmTMB are included as
random fields using a triangulated (“finite element”) mesh with vertices
(knots) that approximate spatial variability. A Gaussian Markov random
field (GMRF) is a set of spatial random effects with a sparse precision
matrix; the SPDE approach (Lindgren et al., 2011) links a Gaussian
random field with Matérn covariance to this discrete GMRF. Bilinear
interpolation is used to approximate a continuous spatial field (Rue et
al., 2009; Lindgren et al., 2011) from the estimated values of the
spatial surface at these knot locations to other locations including
those of actual observations.</p>
<p>There are different options for creating the spatial mesh (see
<code><a href="../reference/make_mesh.html">sdmTMB::make_mesh()</a></code>). We will start with a relatively
coarse mesh for a balance between speed and accuracy
(<code>cutoff = 10</code>, where cutoff is in the units of X and Y (km
here) and represents the minimum distance between knots before a new
mesh vertex is added). Smaller values create meshes with more knots
(finer spatial detail, slower fitting). Larger values create fewer knots
(faster, but coarser). In applied scenarios, start coarse, then check
whether a finer mesh changes conclusions. The circles represent
observations and the vertices are the knot locations.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_mesh.html">make_mesh</a></span><span class="op">(</span><span class="va">pcod</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mesh</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic-intro_files/figure-html/spde-1.png" class="r-plt" width="672"></p>
<p>We will start with a logistic regression of Pacific Cod
encounter/non-encounter in tows as a function of depth and depth
squared. We will first use <code><a href="../reference/sdmTMB.html">sdmTMB()</a></code> without any spatial
random effects (<code>spatial = "off"</code>). This mirrors a standard
GLM and serves as a baseline:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>,</span>
<span>  formula <span class="op">=</span> <span class="va">present</span> <span class="op">~</span> <span class="va">depth_scaled</span> <span class="op">+</span> <span class="va">depth_scaled2</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"off"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">m</span></span>
<span><span class="co">#&gt; Model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: present ~ depth_scaled + depth_scaled2</span></span>
<span><span class="co">#&gt; Mesh: NULL (isotropic covariance)</span></span>
<span><span class="co">#&gt; Data: pcod</span></span>
<span><span class="co">#&gt; Family: binomial(link = 'logit')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;               coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)       0.57    0.06</span></span>
<span><span class="co">#&gt; depth_scaled     -1.04    0.07</span></span>
<span><span class="co">#&gt; depth_scaled2    -0.99    0.06</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ML criterion at convergence: 1193.035</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2392.07</span></span></code></pre></div>
<p>For comparison, here’s the same model with <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>,</span>
<span>  formula <span class="op">=</span> <span class="va">present</span> <span class="op">~</span> <span class="va">depth_scaled</span> <span class="op">+</span> <span class="va">depth_scaled2</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m0</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; glm(formula = present ~ depth_scaled + depth_scaled2, family = binomial(link = "logit"), </span></span>
<span><span class="co">#&gt;     data = pcod)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;               Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; (Intercept)    0.56599    0.05979   9.467   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; depth_scaled  -1.03590    0.07266 -14.258   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; depth_scaled2 -0.99259    0.06066 -16.363   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Null deviance: 2958.4  on 2142  degrees of freedom</span></span>
<span><span class="co">#&gt; Residual deviance: 2386.1  on 2140  degrees of freedom</span></span>
<span><span class="co">#&gt; AIC: 2392.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of Fisher Scoring iterations: 5</span></span></code></pre></div>
<p>Notice that the AIC, log likelihood, parameter estimates, and
standard errors are all identical. Interpreting these coefficients: a
negative linear depth term with a positive quadratic suggests peak
presence at intermediate depths; the logit link means these are log-odds
changes per SD of depth.</p>
<p>Next, we can incorporate spatial random effects into the above model
by changing <code>spatial</code> to <code>"on"</code> and adding our
<code>mesh</code>. These spatial random fields absorb spatial structure
not explained by depth and typically reduce residual spatial
autocorrelation. Expect coefficient estimates and their standard errors
to shift once spatial structure is accounted for:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>,</span>
<span>  formula <span class="op">=</span> <span class="va">present</span> <span class="op">~</span> <span class="va">depth_scaled</span> <span class="op">+</span> <span class="va">depth_scaled2</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"on"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">m1</span></span>
<span><span class="co">#&gt; Spatial model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: present ~ depth_scaled + depth_scaled2</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Data: pcod</span></span>
<span><span class="co">#&gt; Family: binomial(link = 'logit')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;               coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)       1.14    0.44</span></span>
<span><span class="co">#&gt; depth_scaled     -2.17    0.21</span></span>
<span><span class="co">#&gt; depth_scaled2    -1.59    0.13</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matérn range: 43.54</span></span>
<span><span class="co">#&gt; Spatial SD: 1.65</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 1042.157</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2094.314</span></span></code></pre></div>
<p>To add spatiotemporal random fields to this model, we need to include
both the time argument that indicates what column of your data frame
contains the time slices at which spatial random fields should be
estimated (e.g., <code>time = "year"</code>) and we need to choose
whether these fields are independent and identically distributed
(<code>spatiotemporal = "IID"</code>), first-order autoregressive
(<code>spatiotemporal = "AR1"</code>, each year correlated with the
previous), or a random walk (<code>spatiotemporal = "RW"</code>,
cumulative drift). We will stick with IID for these examples.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>,</span>
<span>  formula <span class="op">=</span> <span class="va">present</span> <span class="op">~</span> <span class="va">depth_scaled</span> <span class="op">+</span> <span class="va">depth_scaled2</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"on"</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"IID"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">m2</span></span>
<span><span class="co">#&gt; Spatiotemporal model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: present ~ depth_scaled + depth_scaled2</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Time column: year</span></span>
<span><span class="co">#&gt; Data: pcod</span></span>
<span><span class="co">#&gt; Family: binomial(link = 'logit')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;               coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)       1.37    0.58</span></span>
<span><span class="co">#&gt; depth_scaled     -2.47    0.25</span></span>
<span><span class="co">#&gt; depth_scaled2    -1.83    0.15</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matérn range: 49.96</span></span>
<span><span class="co">#&gt; Spatial SD: 1.91</span></span>
<span><span class="co">#&gt; Spatiotemporal IID SD: 0.95</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 1014.753</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
<p>We can also model biomass density using a Tweedie distribution
(handles zero-inflated continuous biomass). We’ll switch to
<code><a href="https://rdrr.io/r/stats/poly.html" class="external-link">poly()</a></code> notation to make some of the plotting easier.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>,</span>
<span>  formula <span class="op">=</span> <span class="va">density</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html" class="external-link">poly</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">depth</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"on"</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"IID"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">m3</span></span>
<span><span class="co">#&gt; Spatiotemporal model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: density ~ poly(log(depth), 2)</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Time column: year</span></span>
<span><span class="co">#&gt; Data: pcod</span></span>
<span><span class="co">#&gt; Family: tweedie(link = 'log')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;                      coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)              1.86    0.21</span></span>
<span><span class="co">#&gt; poly(log(depth), 2)1   -65.13    6.32</span></span>
<span><span class="co">#&gt; poly(log(depth), 2)2   -96.54    5.98</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 11.03</span></span>
<span><span class="co">#&gt; Tweedie p: 1.50</span></span>
<span><span class="co">#&gt; Matérn range: 19.75</span></span>
<span><span class="co">#&gt; Spatial SD: 1.40</span></span>
<span><span class="co">#&gt; Spatiotemporal IID SD: 1.55</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 6277.624</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
<div class="section level2">
<h2 id="parameter-estimates">Parameter estimates<a class="anchor" aria-label="anchor" href="#parameter-estimates"></a>
</h2>
<p>We can view the confidence intervals on the fixed effects by using
the tidy function. For interpretation, think of a 1-unit increase in a
standardized covariate as 1 SD in the original units; exponentiate
log-linked effects to get multiplicative changes in biomass density:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">m3</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 5</span></span></span>
<span><span class="co">#&gt;   term                 estimate std.error conf.low conf.high</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> (Intercept)              1.86     0.208     1.45      2.26</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> poly(log(depth), 2)1   -<span style="color: #BB0000;">65.1</span>      6.32    -<span style="color: #BB0000;">77.5</span>     -<span style="color: #BB0000;">52.8</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> poly(log(depth), 2)2   -<span style="color: #BB0000;">96.5</span>      5.98   -<span style="color: #BB0000;">108.</span>      -<span style="color: #BB0000;">84.8</span></span></span></code></pre></div>
<p>And similarly for the random effect and variance parameters:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">m3</span>, <span class="st">"ran_pars"</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 5</span></span></span>
<span><span class="co">#&gt;   term      estimate std.error conf.low conf.high</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> range        19.8     3.03      14.6      26.7 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> phi          11.0     0.377     10.3      11.8 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> sigma_O       1.40    0.162      1.12      1.76</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> sigma_E       1.55    0.129      1.32      1.83</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> tweedie_p     1.50    0.011<span style="text-decoration: underline;">9</span>     1.48      1.52</span></span></code></pre></div>
<p>These parameters are defined as follows:</p>
<ul>
<li><p><code>range</code>: A derived parameter that defines the distance
at which 2 points are effectively independent (actually about 13%
correlated). If the <code>share_range</code> argument is changed to
<code>FALSE</code> then the spatial and spatiotemporal ranges will be
unique, otherwise the default is for both to share the same
range.</p></li>
<li><p><code>phi</code>: Observation error scale parameter (e.g., SD in
Gaussian).</p></li>
<li><p><code>sigma_O</code>: SD of the spatial process
(“Omega”).</p></li>
<li><p><code>sigma_E</code>: SD of the spatiotemporal process
(“Epsilon”).</p></li>
<li><p><code>tweedie_p</code>: Tweedie p (power) parameter; between 1
and 2.</p></li>
</ul>
<p>If the model used AR1 spatiotemporal fields then:</p>
<ul>
<li>
<code>rho</code>: Spatiotemporal correlation between years; between
-1 and 1.</li>
</ul>
</div>
<div class="section level2">
<h2 id="model-diagnostics">Model diagnostics<a class="anchor" aria-label="anchor" href="#model-diagnostics"></a>
</h2>
<p>We can inspect randomized quantile residuals:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pcod</span><span class="op">$</span><span class="va">resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">m3</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span> <span class="co"># randomized quantile residuals</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/qqnorm.html" class="external-link">qqnorm</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">resids</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic-intro_files/figure-html/residuals-1.png" class="r-plt" width="768"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pcod</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, col <span class="op">=</span> <span class="va">resids</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_colour_gradient2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic-intro_files/figure-html/residuals-2.png" class="r-plt" width="768"></p>
<p>Look for straight QQ lines and no large spatial patches of residuals;
strong spatial patterns suggest missing covariates or a too-coarse
mesh.</p>
<p>We can also use simulation-based randomized quantile residuals.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">19283</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">m3</span>, nsim <span class="op">=</span> <span class="fl">300</span>, type <span class="op">=</span> <span class="st">"mle-mvn"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dharma_residuals.html">dharma_residuals</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">m3</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic-intro_files/figure-html/residuals-dharma-1.png" class="r-plt" width="768"></p>
<p>See <code>?residuals.sdmTMB()</code> and the <a href="https://sdmtmb.github.io/sdmTMB/articles/residual-checking.html" class="external-link">residuals
vignette</a>.</p>
</div>
<div class="section level2">
<h2 id="spatial-predictions">Spatial predictions<a class="anchor" aria-label="anchor" href="#spatial-predictions"></a>
</h2>
<p>Now, for the purposes of this example (e.g., visualization), we want
to predict on a fine-scale grid on the entire survey domain. There is a
grid built into the package for Queen Charlotte Sound named
<code>qcs_grid</code>. See <a href="https://github.com/sdmTMB/sdmTMB/discussions/151" class="external-link">this
discussion</a> thread if you’re looking for some suggestions for how to
form your own grid. Our prediction grid also needs to have all the
covariates that we used in the model above. We replicate the grid across
years so that spatiotemporal fields can be projected to every time
slice.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">qcs_grid</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 7,314</span></span>
<span><span class="co">#&gt; Columns: 5</span></span>
<span><span class="co">#&gt; $ X             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 456<span style="color: #949494;">, </span>458<span style="color: #949494;">, </span>460<span style="color: #949494;">, </span>462<span style="color: #949494;">, </span>464<span style="color: #949494;">, </span>466<span style="color: #949494;">, </span>468<span style="color: #949494;">, </span>470<span style="color: #949494;">, </span>472<span style="color: #949494;">, </span>474<span style="color: #949494;">, </span>476<span style="color: #949494;">, </span>4…</span></span>
<span><span class="co">#&gt; $ Y             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 5636<span style="color: #949494;">, </span>5636<span style="color: #949494;">, </span>5636<span style="color: #949494;">, </span>5636<span style="color: #949494;">, </span>5636<span style="color: #949494;">, </span>5636<span style="color: #949494;">, </span>5636<span style="color: #949494;">, </span>5636<span style="color: #949494;">, </span>5636<span style="color: #949494;">, </span>56…</span></span>
<span><span class="co">#&gt; $ depth         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 347.08345<span style="color: #949494;">, </span>223.33479<span style="color: #949494;">, </span>203.74085<span style="color: #949494;">, </span>183.29868<span style="color: #949494;">, </span>182.99983<span style="color: #949494;">, </span>1…</span></span>
<span><span class="co">#&gt; $ depth_scaled  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1.56081222<span style="color: #949494;">, </span>0.56976988<span style="color: #949494;">, </span>0.36336929<span style="color: #949494;">, </span>0.12570465<span style="color: #949494;">, </span>0.122036…</span></span>
<span><span class="co">#&gt; $ depth_scaled2 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 2.436134794<span style="color: #949494;">, </span>0.324637712<span style="color: #949494;">, </span>0.132037240<span style="color: #949494;">, </span>0.015801659<span style="color: #949494;">, </span>0.01…</span></span></code></pre></div>
<p>We can replicate our grid across all necessary years:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid_yrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/replicate_df.html">replicate_df</a></span><span class="op">(</span><span class="va">qcs_grid</span>, <span class="st">"year"</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we will make the predictions on new data:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m3</span>, newdata <span class="op">=</span> <span class="va">grid_yrs</span><span class="op">)</span></span></code></pre></div>
<p>Let’s make a small function to help make maps.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_map</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">column</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, fill <span class="op">=</span> <span class="op">{</span><span class="op">{</span> <span class="va">column</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The <code>{{ }}</code> syntax is just a “<a href="https://ggplot2.tidyverse.org/reference/tidyeval.html" class="external-link">tidy-eval
helper</a>” that lets us supply the unquoted column name and pass it on
to ggplot.</p>
<p>There are four kinds of predictions that we get out of the model. Use
cases: - <code>est</code>: fixed + spatial + spatiotemporal; use for
maps and indices. - <code>est_non_rf</code>: fixed effects only; use to
understand covariate-driven signal. - <code>omega_s</code>: spatial
random effects; use to see persistent spatial deviations. -
<code>epsilon_st</code>: spatiotemporal random effects; use to see
year-specific anomalies.</p>
<p>First, we will show the predictions that incorporate all fixed
effects and random effects:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_map</span><span class="op">(</span><span class="va">predictions</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span></span>
<span>    trans <span class="op">=</span> <span class="st">"sqrt"</span>,</span>
<span>    <span class="co"># trim extreme high values to make spatial variation more visible:</span></span>
<span>    na.value <span class="op">=</span> <span class="st">"yellow"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">predictions</span><span class="op">$</span><span class="va">est</span><span class="op">)</span>, <span class="fl">0.995</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Prediction (fixed effects + all random effects)"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"maximum estimated biomass density ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">predictions</span><span class="op">$</span><span class="va">est</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="basic-intro_files/figure-html/plot-all-effects-1.png" class="r-plt" width="768"></p>
<p>We can also look at just the fixed effects, here only a quadratic
effect of depth:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_map</span><span class="op">(</span><span class="va">predictions</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">est_non_rf</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"sqrt"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Prediction (fixed effects only)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic-intro_files/figure-html/plot-fix-defects-1.png" class="r-plt" width="576"></p>
<p>We can look at the spatial random effects that represent consistent
deviations in space through time that are not accounted for by our fixed
effects. In other words, these deviations represent consistent spatially
structured biotic and abiotic factors that are affecting biomass density
but are not accounted for in the model.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_map</span><span class="op">(</span><span class="va">predictions</span>, <span class="va">omega_s</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Spatial random effects only"</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic-intro_files/figure-html/plot-spatial-effects-1.png" class="r-plt" width="576"></p>
<p>And finally we can look at the spatiotemporal random effects that
represent deviation from the fixed effect predictions and the spatial
random effect deviations. These represent spatially structured biotic
and abiotic factors that are changing through time and are not accounted
for in the model.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_map</span><span class="op">(</span><span class="va">predictions</span>, <span class="va">epsilon_st</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Spatiotemporal random effects only"</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic-intro_files/figure-html/plot-spatiotemporal-effects-1.png" class="r-plt" width="768"></p>
<p>We can also estimate the uncertainty in our spatiotemporal density
predictions using simulations from the joint precision matrix by setting
<code>nsim &gt; 0</code> in the predict function. Here we generate 100
estimates and use <code><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply()</a></code> to calculate upper and lower
confidence intervals, a standard deviation, and a coefficient of
variation (CV).</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m3</span>, newdata <span class="op">=</span> <span class="va">grid_yrs</span>, nsim <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">sim_last</span> <span class="op">&lt;-</span> <span class="va">sim</span><span class="op">[</span><span class="va">grid_yrs</span><span class="op">$</span><span class="va">year</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">grid_yrs</span><span class="op">$</span><span class="va">year</span><span class="op">)</span>, <span class="op">]</span> <span class="co"># just plot last year</span></span>
<span><span class="va">pred_last</span> <span class="op">&lt;-</span> <span class="va">predictions</span><span class="op">[</span><span class="va">predictions</span><span class="op">$</span><span class="va">year</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">grid_yrs</span><span class="op">$</span><span class="va">year</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">pred_last</span><span class="op">$</span><span class="va">lwr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">sim_last</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="va">pred_last</span><span class="op">$</span><span class="va">upr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">sim_last</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">0.975</span><span class="op">)</span></span>
<span><span class="va">pred_last</span><span class="op">$</span><span class="va">sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">sim_last</span><span class="op">)</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">pred_last</span><span class="op">$</span><span class="va">cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">sim_last</span><span class="op">)</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>Plot the CV on the estimates:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pred_last</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, fill <span class="op">=</span> <span class="va">cv</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic-intro_files/figure-html/plot-cv-1.png" class="r-plt" width="576"></p>
</div>
<div class="section level2">
<h2 id="conditional-effects">Conditional effects<a class="anchor" aria-label="anchor" href="#conditional-effects"></a>
</h2>
<p>We can visualize the conditional effect of any covariates by feeding
simplified data frames to the predict function that fix covariate values
we want fixed (e.g., at means) and vary parameters we want to visualize
(across a range of values):</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  depth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">depth</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">depth</span><span class="op">)</span>,</span>
<span>    length.out <span class="op">=</span> <span class="fl">100</span></span>
<span>  <span class="op">)</span>,</span>
<span>  year <span class="op">=</span> <span class="fl">2015L</span> <span class="co"># a chosen year</span></span>
<span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m3</span>, newdata <span class="op">=</span> <span class="va">nd</span>, se_fit <span class="op">=</span> <span class="cn">TRUE</span>, re_form <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">p</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">depth</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span>,</span>
<span>  ymin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">est</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">est_se</span><span class="op">)</span>,</span>
<span>  ymax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">est</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">est_se</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Depth (m)"</span>, y <span class="op">=</span> <span class="st">"Biomass density (kg/km2)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic-intro_files/figure-html/depth-eff-1.png" class="r-plt" width="576"></p>
<p>We could also do this with the visreg package. This version is in
link space and the residuals are partial randomized quantile residuals.
See the <code>scale</code> argument in visreg for response scale
plots.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">visreg</span><span class="fu">::</span><span class="fu"><a href="https://pbreheny.github.io/visreg/reference/visreg.html" class="external-link">visreg</a></span><span class="op">(</span><span class="va">m3</span>, <span class="st">"depth"</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic-intro_files/figure-html/visreg-1.png" class="r-plt" width="672"></p>
<p>Or the ggeffects package for a marginal effects plot. This will also
be faster since it relies on the already estimated coefficients and
variance-covariance matrix.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggeffects</span><span class="fu">::</span><span class="fu"><a href="https://strengejacke.github.io/ggeffects/reference/ggpredict.html" class="external-link">ggeffect</a></span><span class="op">(</span><span class="va">m3</span>, <span class="st">"depth [0:500 by=1]"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 1 row containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span>
<span><span class="co">#&gt; Warning: Removed 1 row containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_ribbon()`).</span></span></code></pre></div>
<p><img src="basic-intro_files/figure-html/ggeffects-1.png" class="r-plt" width="672"></p>
<div class="section level3">
<h3 id="time-varying-effects">Time-varying effects<a class="anchor" aria-label="anchor" href="#time-varying-effects"></a>
</h3>
<p>We could also let the effect of depth vary through time. We set up
the time-varying coefficients to follow an AR1 process by setting
<code>time_varying_type = "ar1"</code> (each year’s coefficient is
correlated with the previous year’s). With <code>"ar1"</code> or
<code>"rw0"</code>, the fixed effects represent the starting point of
the time series and the time-varying process represents deviations from
this over time. If, instead, we had used
<code>time_varying_type = "rw"</code>, the first time step of the random
effect process would represent the initial year values and we would want
to omit the matching effects in the main formula. For example:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>formula <span class="ot">=</span> density <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>time_varying <span class="ot">=</span> <span class="er">~</span> <span class="dv">1</span> <span class="sc">+</span> depth_scaled <span class="sc">+</span> depth_scaled2,</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>time_varying_type <span class="ot">=</span> <span class="st">"rw"</span></span></code></pre></div>
<p>We include a full length of time increments with
<code>extra_time</code> to ensure we estimate time-varying coefficient
values for each year, including any years that are missing from our
data. For this example, we turn off the spatiotemporal random effects
because we were having convergence issues with them turned on.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdmTMB.html">sdmTMB</a></span><span class="op">(</span></span>
<span>  <span class="va">density</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">depth_scaled</span> <span class="op">+</span> <span class="va">depth_scaled2</span>,</span>
<span>  data <span class="op">=</span> <span class="va">pcod</span>,</span>
<span>  time_varying <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">depth_scaled</span> <span class="op">+</span> <span class="va">depth_scaled2</span>,</span>
<span>  time_varying_type <span class="op">=</span> <span class="st">"ar1"</span>,</span>
<span>  extra_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">year</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/families.html">tweedie</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>  spatial <span class="op">=</span> <span class="st">"on"</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  spatiotemporal <span class="op">=</span> <span class="st">"off"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">m4</span></span>
<span><span class="co">#&gt; Spatial model fit by ML ['sdmTMB']</span></span>
<span><span class="co">#&gt; Formula: density ~ 1 + depth_scaled + depth_scaled2</span></span>
<span><span class="co">#&gt; Mesh: mesh (isotropic covariance)</span></span>
<span><span class="co">#&gt; Time column: year</span></span>
<span><span class="co">#&gt; Data: pcod</span></span>
<span><span class="co">#&gt; Family: tweedie(link = 'log')</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Conditional model:</span></span>
<span><span class="co">#&gt;               coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)       3.84    0.28</span></span>
<span><span class="co">#&gt; depth_scaled     -1.91    0.16</span></span>
<span><span class="co">#&gt; depth_scaled2    -1.72    0.18</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Time-varying parameters:</span></span>
<span><span class="co">#&gt;                    coef.est coef.se</span></span>
<span><span class="co">#&gt; (Intercept)-2003       0.00    0.08</span></span>
<span><span class="co">#&gt; (Intercept)-2004       0.21    0.08</span></span>
<span><span class="co">#&gt; (Intercept)-2005       0.17    0.08</span></span>
<span><span class="co">#&gt; (Intercept)-2006      -0.03    0.16</span></span>
<span><span class="co">#&gt; (Intercept)-2007      -0.25    0.09</span></span>
<span><span class="co">#&gt; (Intercept)-2008      -0.15    0.21</span></span>
<span><span class="co">#&gt; (Intercept)-2009      -0.25    0.08</span></span>
<span><span class="co">#&gt; (Intercept)-2010      -0.03    0.16</span></span>
<span><span class="co">#&gt; (Intercept)-2011       0.15    0.08</span></span>
<span><span class="co">#&gt; (Intercept)-2012       0.05    0.17</span></span>
<span><span class="co">#&gt; (Intercept)-2013       0.03    0.08</span></span>
<span><span class="co">#&gt; (Intercept)-2014       0.04    0.17</span></span>
<span><span class="co">#&gt; (Intercept)-2015       0.12    0.08</span></span>
<span><span class="co">#&gt; (Intercept)-2016       0.02    0.16</span></span>
<span><span class="co">#&gt; (Intercept)-2017      -0.06    0.08</span></span>
<span><span class="co">#&gt; depth_scaled-2003      0.00    0.04</span></span>
<span><span class="co">#&gt; depth_scaled-2004      0.00    0.04</span></span>
<span><span class="co">#&gt; depth_scaled-2005     -0.01    0.05</span></span>
<span><span class="co">#&gt; depth_scaled-2006      0.00    0.05</span></span>
<span><span class="co">#&gt; depth_scaled-2007     -0.01    0.07</span></span>
<span><span class="co">#&gt; depth_scaled-2008      0.00    0.04</span></span>
<span><span class="co">#&gt; depth_scaled-2009      0.01    0.06</span></span>
<span><span class="co">#&gt; depth_scaled-2010      0.00    0.05</span></span>
<span><span class="co">#&gt; depth_scaled-2011      0.01    0.05</span></span>
<span><span class="co">#&gt; depth_scaled-2012      0.00    0.04</span></span>
<span><span class="co">#&gt; depth_scaled-2013      0.00    0.04</span></span>
<span><span class="co">#&gt; depth_scaled-2014      0.00    0.05</span></span>
<span><span class="co">#&gt; depth_scaled-2015      0.03    0.11</span></span>
<span><span class="co">#&gt; depth_scaled-2016      0.00    0.04</span></span>
<span><span class="co">#&gt; depth_scaled-2017     -0.02    0.10</span></span>
<span><span class="co">#&gt; depth_scaled2-2003    -0.05    0.22</span></span>
<span><span class="co">#&gt; depth_scaled2-2004    -0.04    0.19</span></span>
<span><span class="co">#&gt; depth_scaled2-2005    -0.11    0.22</span></span>
<span><span class="co">#&gt; depth_scaled2-2006     0.00    0.42</span></span>
<span><span class="co">#&gt; depth_scaled2-2007    -0.02    0.24</span></span>
<span><span class="co">#&gt; depth_scaled2-2008     0.01    0.50</span></span>
<span><span class="co">#&gt; depth_scaled2-2009     0.69    0.19</span></span>
<span><span class="co">#&gt; depth_scaled2-2010     0.00    0.42</span></span>
<span><span class="co">#&gt; depth_scaled2-2011    -0.50    0.23</span></span>
<span><span class="co">#&gt; depth_scaled2-2012     0.00    0.42</span></span>
<span><span class="co">#&gt; depth_scaled2-2013     0.56    0.17</span></span>
<span><span class="co">#&gt; depth_scaled2-2014     0.00    0.46</span></span>
<span><span class="co">#&gt; depth_scaled2-2015    -0.06    0.23</span></span>
<span><span class="co">#&gt; depth_scaled2-2016     0.00    0.46</span></span>
<span><span class="co">#&gt; depth_scaled2-2017    -0.45    0.25</span></span>
<span><span class="co">#&gt; rho-(Intercept)        0.34    0.39</span></span>
<span><span class="co">#&gt; rho-depth_scaled       0.00    1.19</span></span>
<span><span class="co">#&gt; rho-depth_scaled2      0.01    0.40</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dispersion parameter: 12.37</span></span>
<span><span class="co">#&gt; Tweedie p: 1.58</span></span>
<span><span class="co">#&gt; Matérn range: 15.41</span></span>
<span><span class="co">#&gt; Spatial SD: 1.75</span></span>
<span><span class="co">#&gt; ML criterion at convergence: 6361.987</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</span></span></code></pre></div>
<p>To plot these, we make a data frame that contains all combinations of
the time-varying covariate and time. This is easily created using
<code><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid()</a></code> or <code><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">tidyr::expand_grid()</a></code>.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  depth_scaled <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">depth_scaled</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.2</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">depth_scaled</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.2</span>,</span>
<span>    length.out <span class="op">=</span> <span class="fl">50</span></span>
<span>  <span class="op">)</span>,</span>
<span>  year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pcod</span><span class="op">$</span><span class="va">year</span><span class="op">)</span> <span class="co"># all years</span></span>
<span><span class="op">)</span></span>
<span><span class="va">nd</span><span class="op">$</span><span class="va">depth_scaled2</span> <span class="op">&lt;-</span> <span class="va">nd</span><span class="op">$</span><span class="va">depth_scaled</span><span class="op">^</span><span class="fl">2</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m4</span>, newdata <span class="op">=</span> <span class="va">nd</span>, se_fit <span class="op">=</span> <span class="cn">TRUE</span>, re_form <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">p</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">depth_scaled</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span>,</span>
<span>  ymin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">est</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">est_se</span><span class="op">)</span>,</span>
<span>  ymax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">est</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">est_se</span><span class="op">)</span>,</span>
<span>  group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="va">year</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">year</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_colour_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="va">pcod</span><span class="op">$</span><span class="va">depth_sd</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">pcod</span><span class="op">$</span><span class="va">depth_mean</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Depth (m)"</span>, y <span class="op">=</span> <span class="st">"Biomass density (kg/km2)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic-intro_files/figure-html/tv-depth-eff-1.png" class="r-plt" width="576"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sean C. Anderson, Eric J. Ward, Philina A. English, Lewis A. K. Barnett, James T. Thorson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
